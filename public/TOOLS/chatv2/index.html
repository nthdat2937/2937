<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ntdChat v2</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Archivo+Black&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --bg-main: #000000;
            --bg-secondary: #0a0a0a;
            --bg-message: #1a1a1a;
            --accent: #00ff41;
            --accent-dim: #00cc33;
            --text: #ffffff;
            --text-dim: #999999;
            --border: #00ff41;
            --border-subtle: #333333;
            --danger: #ff3366;
            --warning: #ffaa00;
            --admin: #ff00ff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Mono', monospace;
            background: var(--bg-main);
            color: var(--text);
            overflow: hidden;
            height: 100vh;
        }

        #loginScreen {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: linear-gradient(135deg, #000000 0%, #0a0a0a 100%);
            position: relative;
            overflow: hidden;
        }

        #loginScreen::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0, 255, 65, 0.03) 2px,
                rgba(0, 255, 65, 0.03) 4px
            );
            animation: scanlines 8s linear infinite;
        }

        @keyframes scanlines {
            0% { transform: translateY(0); }
            100% { transform: translateY(50px); }
        }

        .login-container {
            background: var(--bg-main);
            border: 2px solid var(--accent);
            padding: 3rem;
            max-width: 400px;
            width: 90%;
            position: relative;
            box-shadow: 0 0 30px rgba(0, 255, 65, 0.3);
            animation: slideIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @media (max-width: 768px) {
            .login-container {
                padding: 2rem 1.5rem;
                width: 95%;
            }

            .login-container h1 {
                font-size: 2rem;
                letter-spacing: 2px;
            }
        }

        .login-container.admin-mode {
            border-color: var(--admin);
            box-shadow: 0 0 30px rgba(255, 0, 255, 0.3);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .login-container h1 {
            font-family: 'Archivo Black', sans-serif;
            font-size: 2.5rem;
            color: var(--accent);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
        }

        .login-container.admin-mode h1 {
            color: var(--admin);
            text-shadow: 0 0 10px rgba(255, 0, 255, 0.5);
        }

        .login-container p {
            color: var(--text-dim);
            margin-bottom: 2rem;
            font-size: 0.9rem;
        }

        .admin-notice {
            background: rgba(255, 0, 255, 0.1);
            border: 1px solid var(--admin);
            padding: 0.5rem;
            margin-bottom: 1rem;
            color: var(--admin);
            font-size: 0.85rem;
            text-align: center;
            display: none;
        }

        .admin-notice.active {
            display: block;
        }

        #adminPasswordInput {
            display: none;
        }

        #adminPasswordInput.active {
            display: block;
        }

        input {
            width: 100%;
            padding: 1rem;
            background: var(--bg-main);
            border: 2px solid var(--border-subtle);
            color: var(--text);
            font-family: 'Space Mono', monospace;
            font-size: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s;
        }

        input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.3);
        }

        .admin-mode input:focus {
            border-color: var(--admin);
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.2);
        }

        button {
            width: 100%;
            padding: 1rem;
            background: var(--accent);
            border: 2px solid var(--accent);
            color: #000000;
            font-family: 'Space Mono', monospace;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            /* background: var(--accent-dim); */
            transform: translate(-50%, -50%);
            transition: width 0.4s, height 0.4s;
            border-radius: 50%;
        }

        button:hover::before {
            width: 300px;
            height: 300px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 255, 65, 0.4);
        }

        button span {
            position: relative;
            z-index: 1;
        }

        #chatScreen {
            display: none;
            height: 100vh;
            flex-direction: column;
            margin-left: 250px;
        }

        .chat-header {
            background: var(--bg-main);
            border-bottom: 2px solid var(--accent);
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        @media (max-width: 768px) {
            .chat-header {
                padding: 1rem;
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .chat-header h2 {
                font-size: 1.2rem;
                letter-spacing: 1px;
            }

            .chat-header .header-controls {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
        }

        .chat-header.admin-header {
            border-bottom-color: var(--admin);
        }

        .chat-header h2 {
            font-family: 'Archivo Black', sans-serif;
            color: var(--accent);
            font-size: 1.5rem;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .admin-header h2 {
            color: var(--admin);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-name {
            color: var(--text);
            font-weight: 700;
        }

        .admin-badge {
            background: var(--admin);
            color: var(--bg-main);
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            border-radius: 3px;
            display: none;
        }

        .admin-badge.active {
            display: inline-block;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            background: var(--accent);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .logout-btn {
            width: auto;
            padding: 0.5rem 1rem;
            background: transparent;
            border: 2px solid var(--danger);
            color: var(--danger);
            font-size: 0.8rem;
        }

        .logout-btn:hover {
            background: var(--danger);
            color: var(--text);
        }

        .online-users {
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            width: 250px;
            background: var(--bg-main);
            border-right: 2px solid var(--accent);
            padding: 1.5rem;
            display: none;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto;
            z-index: 100;
        }

        .online-users.active {
            display: flex;
        }

        .online-users-label {
            color: var(--accent);
            font-size: 0.9rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--accent);
        }

        .online-user {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 0.8rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 5px;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .online-user:hover {
            border-color: var(--accent);
            background: rgba(0, 255, 65, 0.05);
        }

        .online-users::-webkit-scrollbar {
            width: 6px;
        }

        .online-users::-webkit-scrollbar-track {
            background: var(--bg-main);
        }

        .online-users::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 3px;
        }

        .online-dot {
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            background: var(--bg-main);
        }

        .messages-container::-webkit-scrollbar {
            width: 8px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 4px;
        }

        .message {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 0.5rem 1rem 0.25rem 1rem;
            background: var(--bg-message);
            border: 1px solid var(--border-subtle);
            border-left: 3px solid var(--accent);
            border-radius: 8px;
            max-width: 600px;
            width: fit-content;
            position: relative;
            animation: messageSlide 0.3s ease-out;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .message.own {
            align-self: flex-end;
            border-left: 1px solid var(--border-subtle);
            border-right: 3px solid red;
        }

        .message.deleted {
            opacity: 0.5;
            background: rgba(255, 51, 102, 0.1);
            border-left-color: var(--danger);
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .message-sender {
            font-weight: 700;
            color: var(--accent);
            font-size: 0.9rem;
        }

        .message-time {
            color: var(--text-dim);
            font-size: 0.75rem;
        }

        .message-content {
            color: var(--text);
            line-height: 1.5;
            word-wrap: break-word;
            position: relative;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .message-text {
            display: block;
            width: 100%;
            word-wrap: break-word;
        }

        .message-content.deleted-content {
            font-style: italic;
            color: var(--text-dim);
            display: block;
        }

        .delete-reason {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: rgba(255, 51, 102, 0.1);
            border-left: 2px solid var(--danger);
            font-size: 0.8rem;
            color: var(--danger);
        }

        .message-footer {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.25rem;
            flex-wrap: wrap;
        }

        .message-actions {
            display: inline-flex;
            gap: 0.3rem;
            opacity: 0;
            transition: opacity 0.2s;
            flex-shrink: 0;
            align-items: center;
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .react-btn, .delete-msg-btn {
            background: var(--bg-main);
            border: 1px solid var(--border-subtle);
            color: var(--text);
            padding: 0.15rem 0.35rem;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
            width: auto;
            border-radius: 4px;
        }

        .react-btn:hover {
            background: var(--accent);
            color: #000000;
            border-color: var(--accent);
        }

        .delete-msg-btn {
            border-color: var(--danger);
            color: var(--danger);
            display: none;
        }

        .delete-msg-btn.visible {
            display: inline-block;
        }

        .delete-msg-btn:hover {
            background: var(--danger);
            color: #ffffff;
        }

        .reaction-picker {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 0;
            background: var(--bg-secondary);
            border: 2px solid var(--accent);
            padding: 0.3rem;
            gap: 0.3rem;
            border-radius: 6px;
            margin-bottom: 0.3rem;
            z-index: 10;
        }

        .reaction-picker.active {
            display: flex;
        }

        .reaction-option {
            font-size: 1.2rem;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .reaction-option:hover {
            transform: scale(1.2);
        }

        .message-reactions {
            display: inline-flex;
            gap: 0.25rem;
            flex-wrap: wrap;
            margin-top: 0;
            align-items: center;
        }

        .reaction {
            display: flex;
            align-items: center;
            gap: 0.2rem;
            padding: 0.15rem 0.35rem;
            background: var(--bg-main);
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .reaction:hover {
            border-color: var(--accent);
            background: rgba(0, 255, 65, 0.1);
        }

        .reaction.active {
            background: var(--accent);
            color: var(--bg-main);
            border-color: var(--accent);
        }

        .reaction span {
            font-size: 0.7rem;
            font-weight: 700;
        }

        /* Kick notification styles */
        .system-message {
            background: rgba(0, 255, 65, 0.1);
            border-left: 3px solid var(--accent);
            padding: 0.8rem;
            margin: 0.5rem 0;
            font-style: italic;
            color: var(--text-dim);
            animation: slideInMessage 0.3s ease;
        }

        .system-message.kick-message {
            background: rgba(255, 51, 102, 0.1);
            border-left: 3px solid var(--danger);
            color: var(--danger);
            font-weight: 600;
        }

        /* Bot message style */
        .message.bot-message {
            background: rgba(0, 255, 65, 0.05);
            border-left: 3px solid yellow;

        }

        .message.bot-message .message-sender {
            color: var(--accent);
            font-weight: 700;
        }

        .kick-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-main);
            border: 3px solid var(--danger);
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            z-index: 10000;
            box-shadow: 0 0 50px rgba(255, 51, 102, 0.5);
            animation: kickPopupSlide 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        /* Overlay để che toàn bộ nội dung khi bị kick */
        .kick-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            display: none;
        }
        
        .kick-overlay.active {
            display: block;
        }

        @keyframes kickPopupSlide {
            from {
                opacity: 0;
                transform: translate(-50%, -60%) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .kick-popup h2 {
            color: var(--danger);
            font-family: 'Archivo Black', sans-serif;
            font-size: 1.8rem;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(255, 51, 102, 0.5);
        }

        .kick-popup .kick-info {
            margin-bottom: 1rem;
        }

        .kick-popup .kick-reason {
            background: rgba(255, 51, 102, 0.1);
            border: 1px solid var(--danger);
            padding: 1rem;
            margin: 1rem 0;
            color: var(--text);
            word-wrap: break-word;
        }

        .kick-popup .kick-timer {
            color: var(--text-dim);
            font-size: 0.9rem;
            text-align: center;
            margin-top: 1rem;
        }

        .input-container {
            padding: 1.5rem;
            background: var(--bg-main);
            border-top: 2px solid var(--accent);
            display: flex;
            gap: 1rem;
            flex-direction: column;
        }

        .preview-container {
            display: none;
            padding: 0.5rem 0;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .preview-container.active {
            display: flex;
        }

        .image-preview {
            position: relative;
            display: inline-block;
        }

        .image-preview img {
            max-width: 100px;
            max-height: 100px;
            border: 2px solid var(--accent);
            border-radius: 4px;
        }

        .image-preview .remove-image {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            font-weight: 700;
        }

        .input-wrapper {
            display: flex;
            gap: 1rem;
        }

        .input-container input {
            flex: 1;
            margin-bottom: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
        }

        .media-btn-container {
            position: relative;
            flex-shrink: 0;
        }

        .media-button {
            background: var(--bg-secondary);
            border: 2px solid var(--accent);
            color: var(--accent);
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.2rem;
            width: auto;
        }

        .media-button:hover {
            background: var(--accent);
            color: #000000;
            transform: none;
            box-shadow: none;
        }

        .media-menu {
            position: absolute;
            bottom: 100%;
            left: 0;
            background: var(--bg-main);
            border: 2px solid var(--accent);
            margin-bottom: 0.5rem;
            display: none;
            flex-direction: column;
            min-width: 180px;
            box-shadow: 0 5px 20px rgba(0, 255, 65, 0.3);
            z-index: 1000;
        }

        .media-menu.active {
            display: flex;
        }

        .media-menu-item {
            padding: 0.75rem 1rem;
            background: transparent;
            border: none;
            color: var(--accent);
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Space Mono', monospace;
            font-size: 0.85rem;
            text-align: left;
            border-bottom: 1px solid var(--border-subtle);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .media-menu-item:last-child {
            border-bottom: none;
        }

        .media-menu-item:hover {
            background: var(--accent);
            color: #000000;
        }

        .media-menu-item i {
            margin-right: 0.5rem;
            width: 20px;
            display: inline-block;
        }

        #imageInput, #videoInput, #audioInput {
            display: none;
        }

        .message-image {
            max-width: 300px;
            max-height: 300px;
            border-radius: 4px;
            margin-top: 0.5rem;
            cursor: pointer;
            border: 2px solid var(--border-subtle);
            display: block;
        }

        .message-image:hover {
            border-color: var(--accent);
        }

        .message-video, .message-audio {
            min-width: 400px;
            max-width: 400px;
            width: 100%;
            margin-top: 0.5rem;
            border-radius: 4px;
            border: 2px solid var(--border-subtle);
            display: block;
            background: var(--bg-secondary);
        }

        .message-audio {
            min-height: 54px;
            height: 54px;
        }

        /* Đảm bảo controls của audio hiển thị đầy đủ */
        .message-audio::-webkit-media-controls-panel {
            display: flex;
            align-items: center;
            height: 50px;
        }

        .message-audio::-webkit-media-controls-enclosure {
            height: 50px;
        }

        .message-video:hover, .message-audio:hover {
            border-color: var(--accent);
        }

        /* Image Viewer Dialog */
        .image-viewer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .image-viewer-modal.active {
            display: flex;
        }

        .image-viewer-container {
            position: relative;
            width: 90%;
            height: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .image-viewer-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.8), transparent);
            z-index: 10;
        }

        .image-viewer-title {
            color: var(--accent);
            font-family: 'Archivo Black', sans-serif;
            font-size: 1.2rem;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .image-viewer-close {
            background: var(--danger);
            border: 2px solid var(--danger);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            padding: 0;
        }

        .image-viewer-close:hover {
            transform: rotate(90deg) scale(1.1);
            box-shadow: 0 0 20px rgba(255, 51, 102, 0.6);
        }

        .image-viewer-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            width: 100%;
        }

        .image-viewer-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: transform 0.3s ease;
            cursor: move;
        }

        .image-viewer-controls {
            position: absolute;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 1rem;
            background: rgba(0, 0, 0, 0.8);
            padding: 1rem 2rem;
            border: 2px solid var(--accent);
            border-radius: 50px;
            backdrop-filter: blur(10px);
        }

        .viewer-control-btn {
            background: var(--bg-secondary);
            border: 2px solid var(--accent);
            color: var(--accent);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            padding: 0;
        }

        .viewer-control-btn:hover {
            background: var(--accent);
            color: #000000;
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.5);
        }

        .viewer-control-btn.active {
            background: var(--accent);
            color: #000000;
        }

        .zoom-level {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text);
            font-weight: 700;
            padding: 0 1rem;
            min-width: 80px;
            justify-content: center;
        }

        .input-container input:focus {
            border-color: var(--accent);
        }

        .send-btn {
            width: auto;
            padding: 1rem 2rem;
            background: var(--accent);
            color: #000000;
            font-weight: 700;
        }

        .send-btn:hover {
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.5);
            background: var(--accent-dim);
        }

        .error-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--danger);
            color: var(--text);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            font-weight: 700;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s;
            z-index: 1000;
            max-width: 300px;
        }

        .error-message.active {
            opacity: 1;
            transform: translateX(0);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-main);
            border: 2px solid var(--accent);
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            border-radius: 8px;
            animation: modalSlide 0.3s ease-out;
            box-shadow: 0 10px 40px rgba(0, 255, 65, 0.3);
        }

        .modal-content.danger {
            border-color: var(--danger);
        }

        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 1rem;
            text-transform: uppercase;
        }

        .modal-content.danger .modal-header {
            color: var(--danger);
        }

        .modal-body {
            margin-bottom: 1.5rem;
        }

        .modal-body label {
            display: block;
            color: var(--text-dim);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .modal-body input,
        .modal-body textarea,
        .modal-body select {
            width: 100%;
            padding: 0.8rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            color: var(--text);
            font-family: 'Space Mono', monospace;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            transition: border-color 0.3s;
        }

        .modal-body input:focus,
        .modal-body textarea:focus,
        .modal-body select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .modal-body textarea {
            min-height: 80px;
            resize: vertical;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
        }

        .modal-btn {
            flex: 1;
            padding: 0.8rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            color: var(--text);
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.3s;
        }

        .modal-btn:hover {
            border-color: var(--accent);
        }

        .modal-btn.primary {
            background: var(--accent);
            border-color: var(--accent);
            color: #000000;
        }

        .modal-btn.primary:hover {
            background: var(--accent-dim);
        }

        .modal-btn.danger {
            background: var(--danger);
            border-color: var(--danger);
            color: #ffffff;
        }

        .modal-btn.danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 51, 102, 0.4);
        }

        .user-list-item {
            padding: 0.8rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 4px;
            transition: border-color 0.2s;
        }

        .user-list-item:hover {
            border-color: var(--accent);
        }

        .user-list-info {
            flex: 1;
        }

        .user-list-name {
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.3rem;
        }

        .user-list-reason {
            font-size: 0.85rem;
            color: var(--text-dim);
            font-style: italic;
        }

        .unban-btn {
            padding: 0.5rem 1rem;
            background: var(--accent);
            border: 1px solid var(--accent);
            color: #000000;
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 0.8rem;
            transition: all 0.3s;
        }

        .unban-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 65, 0.5);
            background: var(--accent-dim);
        }

        .admin-controls {
            display: none;
            gap: 0.5rem;
            margin-left: 1rem;
        }

        .admin-controls.active {
            display: flex;
        }

        .admin-control-btn {
            padding: 0.4rem 0.8rem;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 0.75rem;
            transition: all 0.3s;
            width: auto;
        }

        .admin-control-btn:hover {
            border-color: var(--accent);
            background: rgba(0, 255, 65, 0.1);
        }

        .admin-control-btn.danger {
            border-color: var(--danger);
            color: var(--danger);
        }

        .admin-control-btn.danger:hover {
            /* background: rgba(255, 51, 102, 0.1); */
        }

        @media (max-width: 768px) {
            .online-users {
                width: 200px;
            }

            #chatScreen {
                margin-left: 200px;
            }

            .message {
                max-width: 500px;
            }
            
            .login-container {
                padding: 2rem;
            }

            .chat-header {
                padding: 1rem;
                flex-direction: column;
                align-items: flex-start;
            }

            .chat-header h2 {
                font-size: 1.2rem;
            }

            .user-info {
                width: 100%;
                justify-content: space-between;
            }
        }

        .modal {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.9);
    z-index: 10000;
    align-items: center;
    justify-content: center;
}
.modal.active { display: flex; }
.modal-content {
    background: var(--bg-main);
    border: 2px solid var(--accent);
    padding: 2rem;
    max-width: 500px;
    width: 90%;
}
.room-item {
    padding: 1rem;
    border: 1px solid var(--border-subtle);
    margin: 0.5rem 0;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
}
.room-item:hover { border-color: var(--accent); }
.room-locked::after { content: ''; font-family: 'Font Awesome 6 Free'; font-weight: 900; }

/* System notification styles */
.system-notification {
    text-align: center;
    padding: 0.5rem 1rem;
    margin: 1rem auto;
    background: rgba(0, 255, 65, 0.1);
    border: 1px solid var(--accent);
    border-radius: 20px;
    color: var(--accent);
    font-size: 0.85rem;
    max-width: 400px;
    animation: notificationSlide 0.4s ease-out;
}

@keyframes notificationSlide {
    from {
        opacity: 0;
        transform: scale(0.9);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

.system-notification.join {
    border-color: var(--accent);
    background: rgba(0, 255, 65, 0.1);
}

.system-notification.leave {
    border-color: var(--text-dim);
    background: rgba(153, 153, 153, 0.1);
    color: var(--text-dim);
}

/* Online Users List */
.online-users-section {
    margin-top: 1rem;
    border-top: 1px solid var(--border-subtle);
    padding-top: 1rem;
}

.online-users-title {
    color: var(--accent);
    font-size: 0.9rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.online-users-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    max-height: 300px;
    overflow-y: auto;
}

.online-user-item {
    background: var(--bg-main);
    padding: 0.5rem;
    border-left: 2px solid var(--accent);
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s;
}

.online-user-item:hover {
    background: var(--bg-message);
    transform: translateX(3px);
}

.online-user-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--accent);
    animation: pulse 2s infinite;
}

.online-user-name {
    flex: 1;
    color: var(--text);
    font-weight: 500;
}

.online-user-room {
    color: var(--text-dim);
    font-size: 0.75rem;
}

/* ========== TÍNH NĂNG GỬI FILE - CSS BỔ SUNG ========== */

/* File attachment button */
#fileAttachBtn {
    background: transparent;
    border: 2px solid var(--accent);
    color: var(--accent);
    padding: 0.85rem 1.25rem;
    cursor: pointer;
    transition: all 0.3s;
    width: auto;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

#fileAttachBtn:hover {
    background: var(--accent);
    color: #000000;
}

#fileAttachBtn i {
    font-size: 1.1rem;
}

#fileInput {
    display: none;
}

/* File preview trong input area */
.file-preview {
    margin-bottom: 0.5rem;
    padding: 0.75rem;
    background: rgba(0, 255, 65, 0.05);
    border: 1px solid var(--accent);
    border-radius: 4px;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.file-preview-icon {
    font-size: 1.5rem;
    color: var(--accent);
}

.file-preview-info {
    flex: 1;
}

.file-preview-name {
    font-size: 0.85rem;
    color: var(--text);
    margin-bottom: 0.25rem;
}

.file-preview-size {
    font-size: 0.75rem;
    color: var(--text-dim);
}

.file-preview-remove {
    background: transparent;
    border: 1px solid var(--danger);
    color: var(--danger);
    padding: 0.3rem 0.6rem;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.3s;
    width: auto;
}

.file-preview-remove:hover {
    background: var(--danger);
    color: #000000;
}

/* File attachments trong messages */
.message-file {
    margin-top: 0.75rem;
}

.message-file img {
    max-width: 100%;
    max-height: 400px;
    border: 2px solid var(--accent);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s;
}

.message-file img:hover {
    box-shadow: 0 0 20px rgba(0, 255, 65, 0.3);
    transform: scale(1.02);
}

.message-file audio,
.message-file video {
    width: 100%;
    max-width: 500px;
    margin-top: 0.5rem;
    border: 2px solid var(--accent);
    border-radius: 4px;
}

.file-download-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: transparent;
    border: 2px solid var(--accent);
    color: var(--accent);
    padding: 0.75rem 1.25rem;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.3s;
    width: auto;
    text-decoration: none;
    margin-top: 0.5rem;
}

.file-download-btn:hover {
    background: var(--accent);
    color: #000000;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 255, 65, 0.3);
}

.file-download-btn i {
    font-size: 1rem;
}

/* Upload progress */
.upload-progress {
    margin-bottom: 0.5rem;
    padding: 0.5rem;
    background: rgba(0, 255, 65, 0.1);
    border: 1px solid var(--accent);
    border-radius: 4px;
    text-align: center;
    font-size: 0.85rem;
}

.upload-progress-bar {
    width: 100%;
    height: 4px;
    background: var(--bg-main);
    border-radius: 2px;
    overflow: hidden;
    margin-top: 0.5rem;
}

.upload-progress-fill {
    height: 100%;
    background: var(--accent);
    transition: width 0.3s;
}

/* ========== KẾT THÚC CSS FILE ========== */

/* ========== MOBILE RESPONSIVE CSS ========== */
@media (max-width: 768px) {
    /* FIX CHAT SCREEN BỊ LỆCH - BỎ MARGIN LEFT */
    #chatScreen {
        margin-left: 0 !important;
        width: 100% !important;
    }

    /* ẨN ONLINE USERS SIDEBAR TRÊN MOBILE */
    .online-users {
        display: none !important;
    }

    /* ẨN CÁC NÚT PHÒNG CHAT VÀ ADMIN CONTROLS TRÊN MOBILE */
    .admin-control-btn,
    #backToMainBtn {
        display: none !important;
    }

    /* Chat header - đơn giản hơn trên mobile */
    .chat-header {
        padding: 1rem;
        gap: 0.5rem;
    }

    .chat-header h2 {
        font-size: 1.2rem;
        letter-spacing: 1px;
    }

    /* Header controls - chỉ giữ nút logout */
    .header-controls {
        gap: 0.5rem;
    }

    .header-btn {
        padding: 0.6rem 0.9rem;
        font-size: 0.85rem;
    }

    /* Messages Container - giảm padding */
    .messages-container {
        padding: 1rem;
        gap: 0.75rem;
    }

    /* Message - tối ưu kích thước */
    .message {
        max-width: 100%;
        padding: 0.5rem 0.75rem;
        font-size: 0.9rem;
    }

    .message-sender {
        font-size: 0.85rem;
    }

    .message-time {
        font-size: 0.7rem;
    }

    /* Input Container - giảm padding */
    .input-container {
        padding: 1rem;
        gap: 0.75rem;
    }

    .input-wrapper {
        gap: 0.5rem;
    }

    .input-container input {
        font-size: 0.9rem;
        padding: 0.85rem;
    }

    /* Media Buttons - nhỏ hơn trên mobile */
    .media-button,
    #fileAttachBtn {
        padding: 0.75rem;
        font-size: 1rem;
    }

    button {
        padding: 0.85rem 1rem;
        font-size: 0.9rem;
        letter-spacing: 1px;
    }

    /* Modal - full width trên mobile */
    .modal-content {
        width: 95%;
        max-width: 95%;
        padding: 1.5rem;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-content h3 {
        font-size: 1.3rem;
    }

    /* Room items */
    .room-item {
        padding: 0.75rem;
        gap: 0.5rem;
    }

    .room-item h4 {
        font-size: 0.95rem;
    }

    .room-item p {
        font-size: 0.75rem;
    }

    /* Admin controls - stack vertically */
    .admin-controls {
        flex-direction: column;
        gap: 0.5rem;
    }

    /* User Info - smaller text */
    .user-info {
        font-size: 0.85rem;
    }

    /* Error Popup */
    .error-popup {
        width: 90%;
        max-width: 90%;
        padding: 1rem;
        font-size: 0.9rem;
    }

    /* Kick Popup */
    .kick-popup {
        width: 95%;
        padding: 1.5rem;
    }

    .kick-popup h2 {
        font-size: 1.5rem;
    }

    .kick-popup p {
        font-size: 0.9rem;
    }

    /* Image previews trong message */
    .message-image img {
        max-width: 100%;
        max-height: 300px;
    }

    .image-preview img {
        max-width: 80px;
        max-height: 80px;
    }

    /* File attachments */
    .message-file {
        font-size: 0.8rem;
    }

    .file-download-btn {
        padding: 0.6rem 1rem;
        font-size: 0.8rem;
    }

    /* Reaction picker - adjust position */
    .reaction-picker {
        left: 50%;
        transform: translateX(-50%);
        width: max-content;
        padding: 0.25rem;
        gap: 0.25rem;
    }

    .reaction-option {
        font-size: 1.1rem;
    }

    /* Reactions - gọn hơn trên mobile */
    .message-reactions {
        gap: 0.2rem;
        margin-top: 0.2rem;
    }

    .reaction {
        padding: 0.1rem 0.3rem;
        font-size: 0.7rem;
        gap: 0.15rem;
        border-radius: 8px;
    }

    .reaction span {
        font-size: 0.65rem;
    }

    /* Message actions buttons */
    .delete-msg-btn,
    .message-actions button {
        padding: 0.4rem 0.7rem;
        font-size: 0.75rem;
    }

    /* Form inputs trong modal */
    .modal-content input,
    .modal-content textarea {
        font-size: 0.9rem;
        padding: 0.8rem;
    }

    .modal-content label {
        font-size: 0.85rem;
    }

    /* Checkbox containers */
    .checkbox-container {
        font-size: 0.85rem;
    }

    /* Scroll behavior */
    .messages-container {
        -webkit-overflow-scrolling: touch;
    }

    /* Touch targets - larger for better mobile UX */
    button,
    .header-btn {
        min-height: 44px;
        min-width: 44px;
    }

    /* Notification badges */
    .notification-badge {
        font-size: 0.7rem;
        padding: 0.15rem 0.4rem;
    }

    /* Online users list in modal */
    .online-users-list {
        max-height: 200px;
    }

    .online-user-item {
        font-size: 0.8rem;
        padding: 0.4rem;
    }
}

/* ========== SMALL MOBILE (width < 400px) ========== */
@media (max-width: 400px) {
    .chat-header h2 {
        font-size: 1rem;
    }

    .messages-container {
        padding: 0.75rem;
    }

    .message {
        padding: 0.4rem 0.6rem;
        font-size: 0.85rem;
    }

    .input-container {
        padding: 0.75rem;
    }

    .input-container input {
        font-size: 0.85rem;
        padding: 0.75rem;
    }

    .media-button,
    #fileAttachBtn {
        padding: 0.65rem;
        font-size: 0.9rem;
    }

    button {
        font-size: 0.85rem;
        padding: 0.75rem;
    }

    .modal-content {
        padding: 1rem;
    }

    .header-btn {
        padding: 0.5rem 0.7rem;
        font-size: 0.8rem;
    }
}
    </style>
</head>
<body>
    <!-- Kick Overlay - Che toàn bộ màn hình khi bị kick -->
    <div class="kick-overlay" id="kickOverlay"></div>
    
    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="login-container">
            <h1>ntdChat v2</h1>
            <p>Trò chuyện không giới hạn</p>
            
            <div class="admin-notice" id="adminNotice">
                <i class="fas fa-shield-alt"></i> Chế độ Admin được kích hoạt
            </div>
            
            <input 
                type="text" 
                id="usernameInput" 
                placeholder="Nhập tên của bạn..."
                maxlength="20"
                autocomplete="off"
            >
            
            <input 
                type="password" 
                id="adminPasswordInput" 
                placeholder="Mật khẩu admin..."
                autocomplete="off"
            >
            
            <button onclick="handleLogin()">
                <span>Tham gia ngay</span>
            </button>
        </div>
    </div>

    <!-- Chat Screen -->
    <div class="online-users">
        <span class="online-users-label"><i class="fas fa-bolt"></i> ONLINE USERS</span>
        <div id="onlineUsersList"></div>
    </div>

    <div id="chatScreen">
        <div class="chat-header">
            <h2><i class="fas fa-circle" style="color: var(--accent);"></i> ntdChat v2</h2>
            <div class="admin-controls" id="adminControls">
                <button class="admin-control-btn danger" onclick="showKickModal()">
                    <i class="fas fa-exclamation-triangle"></i> Kick User
                </button>
                <button class="admin-control-btn" onclick="showUnbanModal()">
                    <i class="fas fa-check-circle"></i> Unban
                </button>
            </div>
            <div class="user-info">
                <span class="admin-badge" id="adminBadge">ADMIN</span>
                <span class="user-name" id="userName"></span>
                <div class="status-indicator"></div>
                <button class="logout-btn" onclick="handleLogout()">
                    <span>Đăng xuất</span>
                </button>
            </div>
            <!-- Room Selection Modal -->
            <div id="roomModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header"><i class="fas fa-door-open"></i> CHỌN/TẠO PHÒNG CHAT</div>
                    <div class="modal-body">
                        <label>Danh sách phòng:</label>
                        <div id="roomsList" style="max-height: 300px; overflow-y: auto; margin-bottom: 2rem;">
                            <p style="color: var(--text-dim); text-align: center;">Đang tải...</p>
                        </div>
                        
                        <label>Tạo phòng mới:</label>
                        <input type="text" id="newRoomName" placeholder="Tên phòng...">
                        <input type="password" id="newRoomPassword" placeholder="Mật khẩu (để trống = công khai)">
                    </div>
                    <div class="modal-actions">
                        <button class="modal-btn" onclick="document.getElementById('roomModal').classList.remove('active')">Đóng</button>
                        <button class="modal-btn primary" onclick="createRoom()">Tạo Phòng</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="messages-container" id="messagesContainer">
            <div style="text-align: center; color: var(--text-dim); padding: 2rem;">
                Chưa có tin nhắn nào. Hãy bắt đầu cuộc trò chuyện! <i class="fas fa-rocket"></i>
            </div>
        </div>

        <div class="input-container">
            <div class="preview-container" id="previewContainer"></div>
            <div class="input-wrapper">
                <div class="media-btn-container">
                    <button class="media-button" onclick="toggleMediaMenu()" title="Gửi media">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <div class="media-menu" id="mediaMenu">
                        <button class="media-menu-item" onclick="selectMediaType('image')">
                            <i class="fas fa-image"></i> Gửi ảnh
                        </button>
                        <button class="media-menu-item" onclick="selectMediaType('video')">
                            <i class="fas fa-video"></i> Gửi video
                        </button>
                        <button class="media-menu-item" onclick="selectMediaType('audio')">
                            <i class="fas fa-microphone"></i> Gửi audio
                        </button>
                        <!-- THÊM OPTION GỬI FILE KHÁC -->
                        <button class="media-menu-item" onclick="selectMediaType('document')">
                            <i class="fas fa-file-alt"></i> Gửi file khác
                        </button>
                    </div>
                </div>
                <input type="file" id="imageInput" accept="image/*" onchange="handleImageSelect(event)" style="display: none;">
                <input type="file" id="videoInput" accept="video/*" onchange="handleVideoSelect(event)" style="display: none;">
                <input type="file" id="audioInput" accept="audio/*" onchange="handleAudioSelect(event)" style="display: none;">
                <!-- THÊM INPUT CHO CÁC FILE KHÁC -->
                <input type="file" id="documentInput" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.zip,.rar,.7z" onchange="handleDocumentSelect(event)" style="display: none;">
                <input 
                    type="text" 
                    id="messageInput" 
                    placeholder="Nhập tin nhắn..."
                    onkeypress="handleKeyPress(event)"
                    autocomplete="off"
                >
                <button class="send-btn" onclick="sendMessage()">
                    <span>Gửi <i class="fas fa-arrow-right"></i></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Message Modal -->
    <div class="modal" id="deleteMessageModal">
        <div class="modal-content danger">
            <div class="modal-header"><i class="fas fa-trash-alt"></i> Xóa tin nhắn</div>
            <div class="modal-body">
                <label>Lý do xóa tin nhắn:</label>
                <textarea id="deleteReasonInput" placeholder="Nhập lý do xóa tin nhắn này..."></textarea>
            </div>
            <div class="modal-actions">
                <button class="modal-btn" onclick="closeDeleteModal()">Hủy</button>
                <button class="modal-btn danger" onclick="confirmDeleteMessage()">Xóa</button>
            </div>
        </div>
    </div>

    <!-- Kick User Modal -->
    <div class="modal" id="kickUserModal">
        <div class="modal-content danger">
            <div class="modal-header"><i class="fas fa-exclamation-triangle"></i> Kick người dùng</div>
            <div class="modal-body">
                <label>Chọn người dùng:</label>
                <select id="kickUserSelect">
                    <option value="">-- Chọn người dùng --</option>
                </select>
                
                <label>Lý do kick:</label>
                <textarea id="kickReasonInput" placeholder="Nhập lý do kick người dùng này..."></textarea>
            </div>
            <div class="modal-actions">
                <button class="modal-btn" onclick="closeKickModal()">Hủy</button>
                <button class="modal-btn danger" onclick="confirmKickUser()">Kick</button>
            </div>
        </div>
    </div>

    <!-- Unban User Modal -->
    <div class="modal" id="unbanUserModal">
        <div class="modal-content">
            <div class="modal-header"><i class="fas fa-check-circle"></i> Unban người dùng</div>
            <div class="modal-body">
                <label>Danh sách người dùng bị kick:</label>
                <div id="bannedUsersList" style="max-height: 300px; overflow-y: auto;">
                    <div style="text-align: center; color: var(--text-dim); padding: 1rem;">
                        Đang tải...
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn" onclick="closeUnbanModal()">Đóng</button>
            </div>
        </div>
    </div>

    <!-- Image Viewer Modal -->
    <div class="image-viewer-modal" id="imageViewerModal">
        <div class="image-viewer-container">
            <div class="image-viewer-header">
                <div class="image-viewer-title"><i class="fas fa-image"></i> Image Viewer</div>
                <button class="image-viewer-close" onclick="closeImageViewer()">×</button>
            </div>
            
            <div class="image-viewer-content" id="imageViewerContent">
                <img id="viewerImage" class="image-viewer-image" src="" alt="Viewing image">
            </div>
            
            <div class="image-viewer-controls">
                <button class="viewer-control-btn" onclick="zoomOut()" title="Thu nhỏ">-</button>
                <div class="zoom-level" id="zoomLevel">100%</div>
                <button class="viewer-control-btn" onclick="zoomIn()" title="Phóng to">+</button>
                <button class="viewer-control-btn" onclick="rotateLeft()" title="Xoay trái"><i class="fas fa-undo"></i></button>
                <button class="viewer-control-btn" onclick="rotateRight()" title="Xoay phải"><i class="fas fa-redo"></i></button>
                <button class="viewer-control-btn" onclick="resetImage()" title="Reset"><i class="fas fa-sync-alt"></i></button>
                <button class="viewer-control-btn" onclick="downloadImage()" title="Tải xuống"><i class="fas fa-download"></i></button>
            </div>
        </div>
    </div>

    <div class="error-message" id="errorMessage"></div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://gdbtjzebjwnbwbvktcue.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdkYnRqemVianduYndidmt0Y3VlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NDYyMzYsImV4cCI6MjA4NTUyMjIzNn0.FxHP1_wOzNuc7eb3PhuAJ8T6L8RSPjSh6Vw3cskVjiE';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        /* 
         * IMPORTANT: To enable UNBAN functionality, you need to add RLS policies in Supabase:
         * 
         * For 'kicks' table, add these policies:
         * 
         * 1. Allow UPDATE for admins:
         * CREATE POLICY "Admins can update kicks" ON kicks
         * FOR UPDATE USING (
         *   EXISTS (
         *     SELECT 1 FROM users 
         *     WHERE users.id = auth.uid() 
         *     AND users.is_admin = true
         *   )
         * );
         * 
         * 2. OR Allow DELETE for admins:
         * CREATE POLICY "Admins can delete kicks" ON kicks
         * FOR DELETE USING (
         *   EXISTS (
         *     SELECT 1 FROM users 
         *     WHERE users.id = auth.uid() 
         *     AND users.is_admin = true
         *   )
         * );
         * 
         * Note: Since we're using anon key (not authenticated users), 
         * you may need to allow public UPDATE/DELETE on kicks table:
         * 
         * CREATE POLICY "Allow public to update kicks" ON kicks FOR UPDATE USING (true);
         * CREATE POLICY "Allow public to delete kicks" ON kicks FOR DELETE USING (true);
         */

        // State
        let currentUser = null;
        let isAdmin = false;
        let presenceChannel = null;
        let messagesSubscription = null;
        let kicksSubscription = null;
        let currentDeleteMessageId = null;
        let selectedImage = null;
        let isLockedMode = false; // True khi login qua URL parameter
        let currentRoomId = null; // ID của phòng hiện tại
        let currentRoomName = null; // Tên của phòng hiện tại
        
        // Image viewer state
        let currentZoom = 1;
        let currentRotation = 0;
        let currentImageUrl = '';
        let isDragging = false;
        let startX = 0;
        let startY = 0;
        let translateX = 0;
        let translateY = 0;

        // Get URL parameters
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // Check and auto-login from URL
        function checkAutoLogin() {
            const nameFromUrl = getUrlParameter('q');
            
            if (nameFromUrl) {
                const usernameInput = document.getElementById('usernameInput');
                usernameInput.value = nameFromUrl;
                
                // Check if it's admin username - don't auto-login, show password field
                if (nameFromUrl === 'nthdat2937') {
                    // Show admin password field but don't lock or auto-login
                    const passwordInput = document.getElementById('adminPasswordInput');
                    const adminNotice = document.getElementById('adminNotice');
                    const container = document.querySelector('.login-container');
                    
                    passwordInput.classList.add('active');
                    adminNotice.classList.add('active');
                    container.classList.add('admin-mode');
                    
                    // Don't disable input, allow password entry
                    usernameInput.disabled = false;
                    isLockedMode = false;
                } else {
                    // Regular user - auto-login in locked mode
                    isLockedMode = true;
                    usernameInput.disabled = true;
                    usernameInput.style.opacity = '0.7';
                    handleLogin();
                }
            } else {
                // Normal mode - check localStorage
                const savedUsername = localStorage.getItem('savedUsername');
                if (savedUsername) {
                    document.getElementById('usernameInput').value = savedUsername;
                }
            }
        }

        // Check admin username
        document.getElementById('usernameInput').addEventListener('input', function(e) {
            const username = e.target.value.trim();
            const passwordInput = document.getElementById('adminPasswordInput');
            const adminNotice = document.getElementById('adminNotice');
            const container = document.querySelector('.login-container');
            
            if (username === 'nthdat2937') {
                passwordInput.classList.add('active');
                adminNotice.classList.add('active');
                container.classList.add('admin-mode');
            } else {
                passwordInput.classList.remove('active');
                adminNotice.classList.remove('active');
                container.classList.remove('admin-mode');
                passwordInput.value = '';
            }
        });

        // Login handler
        async function handleLogin() {
            const username = document.getElementById('usernameInput').value.trim();
            const adminPassword = document.getElementById('adminPasswordInput').value.trim();
            
            if (!username) {
                showError('Vui lòng nhập tên của bạn');
                return;
            }

            try {
                // Check if trying to login as admin
                if (username === 'nthdat2937') {
                    if (!adminPassword) {
                        showError('Vui lòng nhập mật khẩu admin');
                        return;
                    }

                    // Verify admin password
                    const { data: adminData, error: adminError } = await supabaseClient
                        .from('admins')
                        .select('*')
                        .eq('username', username)
                        .eq('password', adminPassword)
                        .single();

                    if (adminError || !adminData) {
                        showError('Mật khẩu admin không đúng');
                        return;
                    }

                    isAdmin = true;
                }

                // Save username to localStorage (only in normal mode)
                if (!isLockedMode) {
                    localStorage.setItem('savedUsername', username);
                }

                // Create or get user
                const { data: existingUser, error: fetchError } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('username', username)
                    .single();

                if (fetchError && fetchError.code !== 'PGRST116') {
                    throw fetchError;
                }

                let userId;
                if (existingUser) {
                    currentUser = existingUser;
                    userId = existingUser.id;
                } else {
                    const { data: newUser, error: insertError } = await supabaseClient
                        .from('users')
                        .insert([{ 
                            username, 
                            is_admin: isAdmin 
                        }])
                        .select()
                        .single();

                    if (insertError) throw insertError;
                    currentUser = newUser;
                    userId = newUser.id;
                }

                // Check if user is kicked (unless admin)
                if (!isAdmin) {
                    try {
                        const { data: kickData, error: kickError } = await supabaseClient
                            .from('kicks')
                            .select('*')
                            .eq('user_id', userId)
                            .eq('active', true)
                            .maybeSingle();

                        if (kickData) {
                            showError(`Bạn đã bị kick khỏi chat!\nLý do: ${kickData.reason}`, true);
                            return;
                        }
                    } catch (kickCheckError) {
                        console.warn('Could not check kick status:', kickCheckError);
                        // Continue login even if kick check fails
                    }
                }

                // Save to localStorage
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                localStorage.setItem('isAdmin', isAdmin);

                // Show chat screen
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('chatScreen').style.display = 'flex';
                document.querySelector('.online-users').classList.add('active');
                document.getElementById('userName').textContent = currentUser.username;

                // Hide logout button in locked mode
                if (isLockedMode) {
                    document.querySelector('.logout-btn').style.display = 'none';
                }

                // Show admin badge if admin
                if (isAdmin) {
                    document.getElementById('adminBadge').classList.add('active');
                    document.querySelector('.chat-header').classList.add('admin-header');
                    document.getElementById('adminControls').classList.add('active');
                }

                // Initialize chat
                await initializeChat();
            } catch (error) {
                console.error('Login error:', error);
                showError('Đã xảy ra lỗi khi đăng nhập');
            }
        }

        // Initialize chat
        async function initializeChat() {
            try {
                // Setup presence
                presenceChannel = supabaseClient.channel('online-users', {
                    config: { presence: { key: currentUser.id } }
                });

                presenceChannel
                    .on('presence', { event: 'sync' }, () => {
                        const state = presenceChannel.presenceState();
                        updateOnlineUsers(state);
                        
                        // Update kick user list if admin
                        if (isAdmin) {
                            updateKickUserList(state);
                        }
                    })
                    .on('presence', { event: 'join' }, ({ key, newPresences }) => {
                        // Tắt thông báo join - chỉ theo dõi qua online users list
                    })
                    .on('presence', { event: 'leave' }, ({ key, leftPresences }) => {
                        // Tắt thông báo leave - chỉ theo dõi qua online users list
                    })
                    .on('broadcast', { event: 'user-kicked' }, ({ payload }) => {
                        console.log('Kick event received:', payload);
                        if (payload.userId === currentUser.id) {
                            // Show kick popup with countdown
                            showKickPopup(payload.reason, payload.kickedBy);
                        }
                    })
                    .on('broadcast', { event: 'chat-cleared' }, ({ payload }) => {
                        console.log('Chat cleared by admin:', payload.clearedBy);
                        // Reload page for all users when admin clears chat
                        setTimeout(() => {
                            window.location.reload();
                        }, 500);
                    })
                    .subscribe(async (status) => {
                        if (status === 'SUBSCRIBED') {
                            await presenceChannel.track({
                                user_id: currentUser.id,
                                username: currentUser.username,
                                online_at: new Date().toISOString(),
                                room_id: currentRoomId,
                                room_name: currentRoomName || 'Chính'
                            });
                        }
                    });

                // Load messages
                await loadMessages();

                // Subscribe to messages for current room (or main chat)
                await subscribeToMessagesForRoom();

                // Subscribe to kicks table for realtime kick detection
                kicksSubscription = supabaseClient
                    .channel('kicks-channel')
                    .on('postgres_changes', {
                        event: 'INSERT',
                        schema: 'public',
                        table: 'kicks',
                        filter: `user_id=eq.${currentUser.id}`
                    }, async (payload) => {
                        console.log('Kick detected via database:', payload);
                        if (payload.new.active === true) {
                            const kickReason = payload.new.reason;
                            // Dùng popup thay vì alert
                            showKickPopup(kickReason, 'Admin');
                        }
                    })
                    .subscribe();

                // Subscribe to rooms changes
                subscribeToRooms();

                // Add room button to header
                addRoomButton();

                scrollToBottom();
            } catch (error) {
                console.error('Error initializing chat:', error);
                showError('Không thể kết nối đến chat');
            }
        }

        // Load messages
        async function loadMessages() {
            try {
                let query = supabaseClient
                    .from('messages')
                    .select('*')
                    .order('created_at', { ascending: true })
                    .limit(100);

                // Filter by room if in a room
                if (currentRoom) {
                    query = query.eq('room_id', currentRoom.id);
                } else {
                    // Load messages without room (legacy/default chat)
                    query = query.is('room_id', null);
                }

                const { data, error } = await query;

                if (error) throw error;

                const container = document.getElementById('messagesContainer');
                container.innerHTML = '';

                if (data && data.length > 0) {
                    data.forEach(message => displayMessage(message));
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; color: var(--text-dim); padding: 2rem;">
                            Chưa có tin nhắn nào. Hãy bắt đầu cuộc trò chuyện! <i class="fas fa-rocket"></i>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading messages:', error);
                showError('Không thể tải tin nhắn');
            }
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (!content && !selectedImage) return;

            try {
                // Check if this is a private command that shouldn't be shown in chat
                const isPrivateCommand = content.toLowerCase().startsWith('/createroom') || 
                                        content.toLowerCase().startsWith('/join') ||
                                        content.toLowerCase().startsWith('/exitroom');
                
                let imageUrl = null;
                
                // Upload image if selected
                if (selectedImage) {
                    const fileExt = selectedImage.name.split('.').pop();
                    const fileName = `${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;
                    const filePath = `chat-images/${fileName}`;

                    // Xác định contentType dựa vào loại file
                    const uploadOptions = {
                        contentType: selectedImage.type || 'application/octet-stream',
                        cacheControl: '3600',
                        upsert: false
                    };

                    const { error: uploadError } = await supabaseClient.storage
                        .from('images')
                        .upload(filePath, selectedImage, uploadOptions);

                    if (uploadError) {
                        console.error('Upload error:', uploadError);
                        showError('Không thể tải file lên');
                        return;
                    }

                    const { data: urlData } = supabaseClient.storage
                        .from('images')
                        .getPublicUrl(filePath);

                    imageUrl = urlData.publicUrl;
                }

                // Only send message to database if it's not a private command
                if (!isPrivateCommand) {
                    const { error } = await supabaseClient
                        .from('messages')
                        .insert([{
                            user_id: currentUser.id,
                            username: currentUser.username,
                            content: content || '',
                            image_url: imageUrl,
                            reactions: {},
                            room_id: currentRoom ? currentRoom.id : null
                        }]);

                    if (error) throw error;
                }

                // Bot command handler
                if (content.startsWith('/')) {
                    const command = content.toLowerCase().trim();
                    
                    setTimeout(async () => {
                        let botResponse = '';
                        let shouldSendResponse = true;
                        
                        if (command === '/time') {
                            // /time command - show current time
                            const now = new Date();
                            const vietnamTime = now.toLocaleString('vi-VN', {
                                timeZone: 'Asia/Ho_Chi_Minh',
                                weekday: 'long',
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit'
                            });
                            botResponse = `⏰ Thời gian hiện tại:\n${vietnamTime}`;
                            
                        } else if (command === '/help') {
                            // /help command - show available commands
                            const adminCommands = isAdmin ? `🗑️ /clear - Xóa tất cả tin nhắn (chỉ admin, chỉ chat chung)\n` : '';
                            botResponse = `📚 DANH SÁCH LỆNH:\n\n` +
                                `⏰ /time - Hiển thị thời gian hiện tại (giờ Việt Nam)\n` +
                                `📚 /help - Hiển thị danh sách lệnh này\n` +
                                `🚪 /createroom <tên> <mật khẩu> - Tạo phòng chat mới (mật khẩu tùy chọn)\n` +
                                `📋 /room - Xem danh sách phòng chat hiện có\n` +
                                `🔑 /join <số> <mật khẩu> - Vào phòng nhanh (mật khẩu nếu có)\n` +
                                `🚶 /exitroom - Thoát khỏi phòng và quay về phòng chính\n` +
                                adminCommands +
                                `\n💡 Cách dùng: Gõ lệnh bắt đầu bằng dấu / và gửi tin nhắn`;
                            
                        } else if (command === '/clear') {
                            // /clear command - clear all messages (admin only, main chat only)
                            shouldSendResponse = false;
                            
                            if (!isAdmin) {
                                botResponse = `❌ Bạn không có quyền sử dụng lệnh này!\n\nChỉ admin mới có thể xóa tin nhắn.`;
                                shouldSendResponse = true;
                            } else if (currentRoom) {
                                botResponse = `❌ Lệnh /clear chỉ hoạt động trên chat chung!\n\nKhông thể xóa tin nhắn trong phòng chat riêng.`;
                                shouldSendResponse = true;
                            } else {
                                // Admin và đang ở chat chung - thực hiện xóa
                                try {
                                    // Delete all messages in main chat (room_id is null)
                                    const { error: deleteError } = await supabaseClient
                                        .from('messages')
                                        .delete()
                                        .is('room_id', null);
                                    
                                    if (deleteError) throw deleteError;
                                    
                                    // Broadcast reload signal to all users
                                    if (presenceChannel) {
                                        await presenceChannel.send({
                                            type: 'broadcast',
                                            event: 'chat-cleared',
                                            payload: { 
                                                clearedBy: currentUser.username 
                                            }
                                        });
                                    }
                                    
                                    // Reload page after a short delay
                                    setTimeout(() => {
                                        window.location.reload();
                                    }, 500);
                                } catch (error) {
                                    console.error('Error clearing messages:', error);
                                    botResponse = `❌ Lỗi khi xóa tin nhắn!\n\nVui lòng thử lại.`;
                                    shouldSendResponse = true;
                                }
                            }
                            
                        } else if (command === '/botngu') {
                            botResponse = `Ngu bà nội mày, chém chết giờ!`
                        } else if (content.toLowerCase().startsWith('/createroom')) {
                            // /createroom command - tạo phòng chat nhanh
                            shouldSendResponse = false;
                            const parts = content.slice(11).trim().split(/\s+/);
                            const roomName = parts[0] || currentUser.username;
                            const roomPassword = parts[1] || null;
                            
                            try {
                                // Check if room name already exists
                                const { data: existingRoom, error: checkError } = await supabaseClient
                                    .from('chat_rooms')
                                    .select('name')
                                    .eq('name', roomName)
                                    .single();

                                if (existingRoom) {
                                    botResponse = `❌ Tên phòng "${roomName}" đã tồn tại!\n\n💡 Vui lòng chọn tên khác.`;
                                    shouldSendResponse = true;
                                } else {
                                    // Create new room
                                    const { data: newRoom, error } = await supabaseClient
                                        .from('chat_rooms')
                                        .insert([{
                                            name: roomName,
                                            password: roomPassword,
                                            created_by: currentUser.username
                                        }])
                                        .select()
                                        .single();
                                    
                                    if (error) throw error;
                                    
                                    // Auto join the new room
                                    await joinRoom(newRoom.id, roomPassword);
                                    
                                    // Don't send bot response, joinRoom already shows notification
                                    shouldSendResponse = false;
                                }
                            } catch (error) {
                                console.error('Error creating room:', error);
                                botResponse = `❌ Lỗi khi tạo phòng!\n\n${error.message}`;
                                shouldSendResponse = true;
                            }
                        } else if (command === '/room') {
                            // /room command - hiển thị danh sách phòng
                            shouldSendResponse = false;
                            
                            try {
                                const { data: rooms, error } = await supabaseClient
                                    .from('chat_rooms')
                                    .select('*')
                                    .order('created_at', { ascending: false });
                                
                                if (error) throw error;
                                
                                if (!rooms || rooms.length === 0) {
                                    botResponse = `📋 DANH SÁCH PHÒNG CHAT\n\n` +
                                        `Chưa có phòng chat nào.\n\n` +
                                        `💡 Dùng /createroom để tạo phòng mới!`;
                                } else {
                                    botResponse = `📋 DANH SÁCH PHÒNG CHAT (${rooms.length} phòng)\n\n`;
                                    rooms.forEach((room, index) => {
                                        const lockIcon = room.password ? '🔒' : '🔓';
                                        botResponse += `${index + 1}. ${lockIcon} ${room.name}\n`;
                                    });
                                    botResponse += `\n💡 Dùng /join <số> để vào phòng nhanh!`;
                                }
                                shouldSendResponse = true;
                            } catch (error) {
                                console.error('Error loading rooms:', error);
                                botResponse = `❌ Lỗi khi tải danh sách phòng!\n\n${error.message}`;
                                shouldSendResponse = true;
                            }
                        } else if (content.toLowerCase().startsWith('/join')) {
                            // /join command - vào phòng nhanh
                            shouldSendResponse = false;
                            const parts = content.slice(5).trim().split(/\s+/);
                            const roomNumber = parseInt(parts[0]);
                            const enteredPassword = parts[1] || null;
                            
                            if (!roomNumber || isNaN(roomNumber)) {
                                botResponse = `❌ Vui lòng nhập số thứ tự phòng!\n\n💡 Ví dụ: /join 1 hoặc /join 1 matkhau`;
                                shouldSendResponse = true;
                            } else {
                                try {
                                    // Get all rooms
                                    const { data: rooms, error } = await supabaseClient
                                        .from('chat_rooms')
                                        .select('*')
                                        .order('created_at', { ascending: false });
                                    
                                    if (error) throw error;
                                    
                                    if (!rooms || rooms.length === 0) {
                                        botResponse = `❌ Không có phòng chat nào!\n\n💡 Dùng /createroom để tạo phòng mới!`;
                                        shouldSendResponse = true;
                                    } else if (roomNumber < 1 || roomNumber > rooms.length) {
                                        botResponse = `❌ Số thứ tự không hợp lệ!\n\n📋 Hiện có ${rooms.length} phòng. Dùng /room để xem danh sách.`;
                                        shouldSendResponse = true;
                                    } else {
                                        const selectedRoom = rooms[roomNumber - 1];
                                        
                                        // Check password
                                        if (selectedRoom.password && selectedRoom.password !== enteredPassword) {
                                            botResponse = `❌ Mật khẩu không đúng!\n\n🔒 Phòng "${selectedRoom.name}" có mật khẩu.\n💡 Dùng: /join ${roomNumber} <mật khẩu>`;
                                            shouldSendResponse = true;
                                        } else {
                                            // Join room
                                            await joinRoom(selectedRoom.id, selectedRoom.password);
                                            // Don't send bot response, joinRoom already shows notification
                                            shouldSendResponse = false;
                                        }
                                    }
                                } catch (error) {
                                    console.error('Error joining room:', error);
                                    botResponse = `❌ Lỗi khi vào phòng!\n\n${error.message}`;
                                    shouldSendResponse = true;
                                }
                            }
                        } else if (command === '/exitroom') {
                            // /exitroom command - thoát khỏi phòng và quay về phòng chính (reload page)
                            shouldSendResponse = false;
                            
                            if (!currentRoom) {
                                botResponse = `❌ Bạn đang ở phòng chính rồi!\n\n💡 Dùng /join để vào phòng chat khác.`;
                                shouldSendResponse = true;
                            } else {
                                // Just reload the page to exit room
                                setTimeout(() => {
                                    window.location.reload();
                                }, 500); // Small delay to let the command message send
                            }
                        } else {
                            // Unknown command
                            botResponse = `❌ Lệnh không tồn tại!\n\nNhập /help để xem các lệnh có sẵn.`;
                        }
                        
                        // Send bot response
                        if (shouldSendResponse && botResponse) {
                            await supabaseClient
                                .from('messages')
                                .insert([{
                                    user_id: 'bot-system',
                                    username: '🤖 BOT',
                                    content: botResponse,
                                    reactions: {},
                                    room_id: currentRoom ? currentRoom.id : null
                                }]);
                        }
                    }, 500); // Delay 500ms để bot reply tự nhiên hơn
                }

                input.value = '';
                selectedImage = null;
                document.getElementById('previewContainer').innerHTML = '';
                document.getElementById('previewContainer').classList.remove('active');
                document.getElementById('imageInput').value = '';
                document.getElementById('videoInput').value = '';
                document.getElementById('audioInput').value = '';
            } catch (error) {
                console.error('Error sending message:', error);
                showError('Không thể gửi tin nhắn');
            }
        }

        // Handle new message
        function handleNewMessage(payload) {
            console.log('handleNewMessage called with payload:', payload);
            console.log('Current room:', currentRoom);
            
            const newMessage = payload.new;
            
            // Filter: only show message if it belongs to current room
            if (currentRoom) {
                // In a room: only show messages with matching room_id
                if (newMessage.room_id !== currentRoom.id) {
                    console.log('Ignoring message - wrong room_id');
                    return;
                }
            } else {
                // In main chat: only show messages with null room_id
                if (newMessage.room_id !== null) {
                    console.log('Ignoring message - has room_id but we are in main chat');
                    return;
                }
            }
            
            const container = document.getElementById('messagesContainer');
            
            if (container.innerHTML.includes('Chưa có tin nhắn')) {
                container.innerHTML = '';
            }
            
            displayMessage(newMessage);
            scrollToBottom();
        }

        // Handle message update
        function handleMessageUpdate(payload) {
            console.log('handleMessageUpdate called with payload:', payload);
            console.log('Current room:', currentRoom);
            
            const updatedMessage = payload.new;
            
            // Filter: only update message if it belongs to current room
            if (currentRoom) {
                // In a room: only update messages with matching room_id
                if (updatedMessage.room_id !== currentRoom.id) {
                    console.log('Ignoring update - wrong room_id');
                    return;
                }
            } else {
                // In main chat: only update messages with null room_id
                if (updatedMessage.room_id !== null) {
                    console.log('Ignoring update - has room_id but we are in main chat');
                    return;
                }
            }
            
            const messageElement = document.querySelector(`[data-message-id="${updatedMessage.id}"]`);
            if (messageElement) {
                if (updatedMessage.deleted) {
                    // Update deleted message
                    messageElement.classList.add('deleted');
                    const contentDiv = messageElement.querySelector('.message-content');
                    contentDiv.classList.add('deleted-content');
                    contentDiv.innerHTML = `
                        <em>Tin nhắn đã bị xóa bởi admin</em>
                        ${updatedMessage.delete_reason ? `<div class="delete-reason">Lý do: ${escapeHtml(updatedMessage.delete_reason)}</div>` : ''}
                    `;
                } else {
                    updateMessageReactions(messageElement, updatedMessage.reactions);
                }
            }
        }

        // Display message
        function displayMessage(message) {
            const container = document.getElementById('messagesContainer');
            
            // Handle system kick notification messages (identified by special user_id)
            if (message.user_id === 'system-kick-notification') {
                const systemDiv = document.createElement('div');
                systemDiv.className = 'system-message kick-message';
                systemDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i> ${escapeHtml(message.content)}
                `;
                container.appendChild(systemDiv);
                return;
            }
            
            const messageDiv = document.createElement('div');
            const isBotMessage = message.user_id === 'bot-system';
            messageDiv.className = `message ${message.user_id === currentUser.id ? 'own' : ''} ${message.deleted ? 'deleted' : ''} ${isBotMessage ? 'bot-message' : ''}`;
            messageDiv.setAttribute('data-message-id', message.id);

            const time = new Date(message.created_at).toLocaleTimeString('vi-VN', {
                timeZone: 'Asia/Ho_Chi_Minh',
                hour: '2-digit',
                minute: '2-digit'
            });

            let contentHtml;
            if (message.deleted) {
                contentHtml = `
                    <em>Tin nhắn đã bị xóa bởi admin</em>
                    ${message.delete_reason ? `<div class="delete-reason">Lý do: ${escapeHtml(message.delete_reason)}</div>` : ''}
                `;
            } else {
                contentHtml = message.content ? escapeHtml(message.content) : '';
            }

            // Add image/video/audio if exists
            let mediaHtml = '';
            if (message.image_url && !message.deleted) {
                const url = message.image_url;
                // Xác định loại media dựa vào extension
                const urlLower = url.toLowerCase();
                
                // Check for video
                if (urlLower.includes('.mp4') || urlLower.includes('.webm') || 
                    urlLower.includes('.mov') || urlLower.includes('.avi') ||
                    urlLower.includes('video')) {
                    mediaHtml = `<video src="${url}" controls class="message-video" preload="metadata" controlsList="nodownload"></video>`;
                }
                // Check for audio - bổ sung thêm nhiều định dạng
                else if (urlLower.includes('.mp3') || urlLower.includes('.wav') || 
                         urlLower.includes('.ogg') || urlLower.includes('.m4a') ||
                         urlLower.includes('.aac') || urlLower.includes('.flac') ||
                         urlLower.includes('audio')) {
                    mediaHtml = `<audio src="${url}" controls class="message-audio" preload="metadata" controlsList="nodownload"></audio>`;
                }
                // ========== THÊM XỬ LÝ CHO FILE DOCUMENTS ==========
                // Check for documents (pdf, docx, xlsx, zip, etc.)
                else if (urlLower.includes('.pdf') || urlLower.includes('.doc') || 
                         urlLower.includes('.xls') || urlLower.includes('.ppt') ||
                         urlLower.includes('.zip') || urlLower.includes('.rar') ||
                         urlLower.includes('.txt') || urlLower.includes('.csv') ||
                         urlLower.includes('.7z')) {
                    // Extract file name from URL
                    const fileName = url.split('/').pop().split('?')[0];
                    const ext = fileName.split('.').pop().toLowerCase();
                    
                    // Get icon based on file type
                    let fileIcon = 'fa-file';
                    const iconMap = {
                        'pdf': 'fa-file-pdf',
                        'doc': 'fa-file-word', 'docx': 'fa-file-word',
                        'xls': 'fa-file-excel', 'xlsx': 'fa-file-excel',
                        'ppt': 'fa-file-powerpoint', 'pptx': 'fa-file-powerpoint',
                        'zip': 'fa-file-archive', 'rar': 'fa-file-archive', '7z': 'fa-file-archive',
                        'txt': 'fa-file-alt',
                        'csv': 'fa-file-csv'
                    };
                    if (iconMap[ext]) {
                        fileIcon = iconMap[ext];
                    }
                    
                    mediaHtml = `
                        <div class="message-file" style="margin-top: 0.5rem;">
                            <a href="${url}" download="${fileName}" target="_blank" 
                               style="display: inline-flex; align-items: center; gap: 0.5rem; 
                                      background: transparent; border: 2px solid var(--accent); 
                                      color: var(--accent); padding: 0.75rem 1.25rem; 
                                      text-decoration: none; transition: all 0.3s; border-radius: 4px;"
                               onmouseover="this.style.background='var(--accent)'; this.style.color='#000000';"
                               onmouseout="this.style.background='transparent'; this.style.color='var(--accent)';">
                                <i class="fas ${fileIcon}" style="font-size: 1rem;"></i>
                                <span>${fileName}</span>
                                <i class="fas fa-download"></i>
                            </a>
                        </div>
                    `;
                }
                // ========== KẾT THÚC XỬ LÝ DOCUMENTS ==========
                // Default to image
                else {
                    mediaHtml = `<img src="${url}" alt="Image" class="message-image" onclick="openImageViewer('${url}')">`;
                }
            }

            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-sender">${escapeHtml(message.username)}</span>
                    <span class="message-time">${time}</span>
                </div>
                <div class="message-content ${message.deleted ? 'deleted-content' : ''}">
                    ${message.deleted ? contentHtml : `
                        ${contentHtml ? `<div class="message-text" style="white-space: pre-line; margin-bottom: ${mediaHtml ? '0.5rem' : '0'};">${contentHtml}</div>` : ''}
                        ${mediaHtml}
                    `}
                    ${!message.deleted && !isBotMessage ? `
                    <div class="reaction-picker" id="picker-${message.id}">
                        <span class="reaction-option" onclick="addReaction(${message.id}, '❤️')"><i class="fas fa-heart"></i></span>
                        <span class="reaction-option" onclick="addReaction(${message.id}, '👍')"><i class="fas fa-thumbs-up"></i></span>
                        <span class="reaction-option" onclick="addReaction(${message.id}, '😂')"><i class="fas fa-laugh"></i></span>
                        <span class="reaction-option" onclick="addReaction(${message.id}, '🔥')"><i class="fas fa-fire"></i></span>
                        <span class="reaction-option" onclick="addReaction(${message.id}, '✨')"><i class="fas fa-sparkles"></i></span>
                    </div>
                    ` : ''}
                </div>
                ${!isBotMessage ? `
                <div class="message-footer">
                    <div class="message-reactions" id="reactions-${message.id}"></div>
                    ${!message.deleted ? `
                    <div class="message-actions">
                        <button class="react-btn" onclick="toggleReactionPicker(${message.id})"><i class="fas fa-heart"></i></button>
                        <button class="delete-msg-btn ${isAdmin && message.user_id !== currentUser.id ? 'visible' : ''}" onclick="showDeleteModal(${message.id})"><i class="fas fa-trash"></i></button>
                    </div>
                    ` : ''}
                </div>
                ` : ''}
            `;

            container.appendChild(messageDiv);
            
            if (message.reactions && !message.deleted && !isBotMessage) {
                updateMessageReactions(messageDiv, message.reactions);
            }
        }

        // Show delete message modal
        function showDeleteModal(messageId) {
            currentDeleteMessageId = messageId;
            document.getElementById('deleteMessageModal').classList.add('active');
            document.getElementById('deleteReasonInput').value = '';
        }

        // Close delete modal
        function closeDeleteModal() {
            document.getElementById('deleteMessageModal').classList.remove('active');
            currentDeleteMessageId = null;
        }

        // Confirm delete message
        async function confirmDeleteMessage() {
            const reason = document.getElementById('deleteReasonInput').value.trim();
            
            if (!reason) {
                showError('Vui lòng nhập lý do xóa tin nhắn');
                return;
            }

            if (!currentDeleteMessageId) return;

            try {
                const { error } = await supabaseClient
                    .from('messages')
                    .update({ 
                        deleted: true,
                        delete_reason: reason,
                        deleted_by: currentUser.id,
                        deleted_at: new Date().toISOString()
                    })
                    .eq('id', currentDeleteMessageId);

                if (error) throw error;

                closeDeleteModal();
                showError('Đã xóa tin nhắn', false);
            } catch (error) {
                console.error('Error deleting message:', error);
                showError('Không thể xóa tin nhắn');
            }
        }

        // Show kick user modal
        function showKickModal() {
            if (!isAdmin) return;
            document.getElementById('kickUserModal').classList.add('active');
            document.getElementById('kickReasonInput').value = '';
        }

        // Close kick modal
        function closeKickModal() {
            document.getElementById('kickUserModal').classList.remove('active');
        }

        // Update kick user list
        function updateKickUserList(presenceState) {
            const select = document.getElementById('kickUserSelect');
            select.innerHTML = '<option value="">-- Chọn người dùng --</option>';

            Object.values(presenceState).forEach(presences => {
                presences.forEach(presence => {
                    if (presence.username && presence.user_id !== currentUser.id) {
                        const option = document.createElement('option');
                        option.value = presence.user_id;
                        option.textContent = presence.username;
                        select.appendChild(option);
                    }
                });
            });
        }

        // Confirm kick user
        async function confirmKickUser() {
            const userId = document.getElementById('kickUserSelect').value;
            const reason = document.getElementById('kickReasonInput').value.trim();
            
            if (!userId) {
                showError('Vui lòng chọn người dùng');
                return;
            }

            if (!reason) {
                showError('Vui lòng nhập lý do kick');
                return;
            }

            try {
                // Get username of kicked user
                const select = document.getElementById('kickUserSelect');
                const kickedUsername = select.options[select.selectedIndex].text;

                // Record kick in database with active = true
                const { error: kickError } = await supabaseClient
                    .from('kicks')
                    .insert([{
                        user_id: userId,
                        kicked_by: currentUser.id,
                        reason: reason,
                        active: true
                    }]);

                if (kickError) throw kickError;

                // Send kick notification message to chat
                const { error: msgError } = await supabaseClient
                    .from('messages')
                    .insert([{
                        username: 'SYSTEM',
                        content: `⚠️ ${kickedUsername} đã bị kick bởi ${currentUser.username}. Lý do: ${reason}`,
                        user_id: 'system-kick-notification',
                        room_id: currentRoom ? currentRoom.id : null
                    }]);

                if (msgError) console.error('Error sending kick notification:', msgError);

                // Send broadcast to kick user
                if (presenceChannel) {
                    console.log('Broadcasting kick event to user:', userId);
                    await presenceChannel.send({
                        type: 'broadcast',
                        event: 'user-kicked',
                        payload: { 
                            userId: userId,
                            reason: reason,
                            kickedBy: currentUser.username
                        }
                    });
                    console.log('Kick broadcast sent successfully');
                }

                closeKickModal();
                showError('✅ Đã kick người dùng! Họ sẽ bị văng khỏi chat ngay lập tức.', false);
            } catch (error) {
                console.error('Error kicking user:', error);
                showError('Không thể kick người dùng');
            }
        }

        // Show unban user modal
        async function showUnbanModal() {
            if (!isAdmin) return;
            document.getElementById('unbanUserModal').classList.add('active');
            await loadBannedUsers();
        }

        // Close unban modal
        function closeUnbanModal() {
            document.getElementById('unbanUserModal').classList.remove('active');
        }

        // Load banned users
        async function loadBannedUsers() {
            try {
                const { data: kicks, error } = await supabaseClient
                    .from('kicks')
                    .select('*')
                    .eq('active', true)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const container = document.getElementById('bannedUsersList');
                
                if (!kicks || kicks.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; color: var(--text-dim); padding: 1rem;">
                            Không có người dùng nào bị kick
                        </div>
                    `;
                    return;
                }

                container.innerHTML = '';
                
                // Fetch user details for each kick
                for (const kick of kicks) {
                    try {
                        const { data: user } = await supabaseClient
                            .from('users')
                            .select('username')
                            .eq('id', kick.user_id)
                            .single();

                        const item = document.createElement('div');
                        item.className = 'user-list-item';
                        item.innerHTML = `
                            <div class="user-list-info">
                                <div class="user-list-name">${escapeHtml(user?.username || 'Unknown User')}</div>
                                <div class="user-list-reason">Lý do: ${escapeHtml(kick.reason)}</div>
                            </div>
                            <div>
                            <button class="unban-btn" onclick="unbanUser('${kick.id}', '${kick.user_id}')">
                                Unban
                            </button>
                            </div>
                        `;
                        container.appendChild(item);
                    } catch (userError) {
                        console.warn('Could not load user for kick:', userError);
                    }
                }
            } catch (error) {
                console.error('Error loading banned users:', error);
                const container = document.getElementById('bannedUsersList');
                container.innerHTML = `
                    <div style="text-align: center; color: var(--text-dim); padding: 1rem;">
                        Không thể tải danh sách. Vui lòng thử lại.
                    </div>
                `;
            }
        }

        // Unban user - Global function
        window.unbanUser = async function(kickId, userId) {
            try {
                console.log('Attempting to unban:', { kickId, userId, type: typeof kickId });
                
                // First, check if the record exists
                const { data: existingKick, error: fetchError } = await supabaseClient
                    .from('kicks')
                    .select('*')
                    .eq('id', kickId)
                    .single();

                console.log('Existing kick record:', { existingKick, fetchError });

                if (fetchError || !existingKick) {
                    showError('Không tìm thấy bản ghi kick này. Có thể đã được unban rồi.');
                    await loadBannedUsers();
                    return;
                }

                // Try to update active = false
                const { data: updateData, error: updateError } = await supabaseClient
                    .from('kicks')
                    .update({ active: false })
                    .eq('id', kickId)
                    .select();

                console.log('Update result:', { updateData, updateError });

                if (updateError) {
                    console.error('Update error:', updateError);
                    throw updateError;
                }

                if (updateData && updateData.length > 0) {
                    showError('Đã unban người dùng thành công! Người dùng có thể đăng nhập lại.', false);
                    await loadBannedUsers();
                    return;
                }

                // If update returns empty array (RLS policy issue), try delete
                console.log('Update returned empty, trying delete instead...');
                
                const { data: deleteData, error: deleteError } = await supabaseClient
                    .from('kicks')
                    .delete()
                    .eq('id', kickId)
                    .select();

                console.log('Delete result:', { deleteData, deleteError });

                if (deleteError) {
                    console.error('Delete error:', deleteError);
                    throw deleteError;
                }

                if (deleteData && deleteData.length > 0) {
                    showError('Đã unban người dùng thành công! Người dùng có thể đăng nhập lại.', false);
                    await loadBannedUsers();
                    return;
                }

                // If both failed, it's likely an RLS policy issue
                showError('Không thể unban: Vui lòng kiểm tra RLS policies trong Supabase cho bảng kicks (cần cho phép UPDATE hoặc DELETE)');
                
            } catch (error) {
                console.error('Error unbanning user:', error);
                showError('Lỗi khi unban: ' + error.message);
            }
        }

        // Toggle reaction picker
        function toggleReactionPicker(messageId) {
            const picker = document.getElementById(`picker-${messageId}`);
            const allPickers = document.querySelectorAll('.reaction-picker');
            
            allPickers.forEach(p => {
                if (p.id !== `picker-${messageId}`) {
                    p.classList.remove('active');
                }
            });
            
            picker.classList.toggle('active');
        }

        // Add reaction
        async function addReaction(messageId, emoji) {
            try {
                const { data: message, error: fetchError } = await supabaseClient
                    .from('messages')
                    .select('reactions')
                    .eq('id', messageId)
                    .single();

                if (fetchError) throw fetchError;

                const reactions = message.reactions || {};
                
                if (!reactions[emoji]) {
                    reactions[emoji] = [];
                }

                const userIndex = reactions[emoji].indexOf(currentUser.id);
                if (userIndex > -1) {
                    reactions[emoji].splice(userIndex, 1);
                    if (reactions[emoji].length === 0) {
                        delete reactions[emoji];
                    }
                } else {
                    reactions[emoji].push(currentUser.id);
                }

                const { error: updateError } = await supabaseClient
                    .from('messages')
                    .update({ reactions })
                    .eq('id', messageId);

                if (updateError) throw updateError;

                document.getElementById(`picker-${messageId}`).classList.remove('active');
            } catch (error) {
                console.error('Error adding reaction:', error);
                showError('Không thể thêm reaction');
            }
        }

        // Update message reactions
        function emojiToIcon(emoji) {
            const emojiMap = {
                '❤️': '<i class="fas fa-heart"></i>',
                '👍': '<i class="fas fa-thumbs-up"></i>',
                '😂': '<i class="fas fa-laugh"></i>',
                '🔥': '<i class="fas fa-fire"></i>',
                '✨': '<i class="fas fa-sparkles"></i>'
            };
            return emojiMap[emoji] || emoji;
        }

        function updateMessageReactions(messageElement, reactions) {
            const reactionsContainer = messageElement.querySelector('.message-reactions');
            reactionsContainer.innerHTML = '';

            if (!reactions) return;

            Object.entries(reactions).forEach(([emoji, userIds]) => {
                if (userIds.length > 0) {
                    const reactionDiv = document.createElement('div');
                    reactionDiv.className = `reaction ${userIds.includes(currentUser.id) ? 'active' : ''}`;
                    reactionDiv.innerHTML = `${emojiToIcon(emoji)} <span>${userIds.length}</span>`;
                    reactionDiv.onclick = () => {
                        const messageId = messageElement.getAttribute('data-message-id');
                        addReaction(parseInt(messageId), emoji);
                    };
                    reactionsContainer.appendChild(reactionDiv);
                }
            });
        }

        // Update online users
        function updateOnlineUsers(state) {
            const container = document.getElementById('onlineUsersList');
            container.innerHTML = '';

            Object.values(state).forEach(presences => {
                presences.forEach(presence => {
                    if (presence.username) {
                        const userDiv = document.createElement('div');
                        userDiv.className = 'online-user-item';
                        
                        const roomName = presence.room_name || 'Chính';
                        
                        userDiv.innerHTML = `
                            <div class="online-user-indicator"></div>
                            <span class="online-user-name">${escapeHtml(presence.username)}</span>
                            <span class="online-user-room">(${escapeHtml(roomName)})</span>
                        `;
                        container.appendChild(userDiv);
                    }
                });
            });
        }

        // Image Viewer Functions
        function openImageViewer(imageUrl) {
            currentImageUrl = imageUrl;
            currentZoom = 1;
            currentRotation = 0;
            translateX = 0;
            translateY = 0;
            
            const modal = document.getElementById('imageViewerModal');
            const img = document.getElementById('viewerImage');
            
            img.src = imageUrl;
            modal.classList.add('active');
            
            updateImageTransform();
            updateZoomLevel();
            
            // Add drag functionality
            setupDragListeners();
        }

        function closeImageViewer() {
            const modal = document.getElementById('imageViewerModal');
            modal.classList.remove('active');
            removeDragListeners();
        }

        function zoomIn() {
            currentZoom = Math.min(currentZoom + 0.25, 5);
            updateImageTransform();
            updateZoomLevel();
        }

        function zoomOut() {
            currentZoom = Math.max(currentZoom - 0.25, 0.25);
            updateImageTransform();
            updateZoomLevel();
        }

        function rotateLeft() {
            currentRotation -= 90;
            updateImageTransform();
        }

        function rotateRight() {
            currentRotation += 90;
            updateImageTransform();
        }

        function resetImage() {
            currentZoom = 1;
            currentRotation = 0;
            translateX = 0;
            translateY = 0;
            updateImageTransform();
            updateZoomLevel();
        }

        function updateImageTransform() {
            const img = document.getElementById('viewerImage');
            img.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentZoom}) rotate(${currentRotation}deg)`;
        }

        function updateZoomLevel() {
            document.getElementById('zoomLevel').textContent = Math.round(currentZoom * 100) + '%';
        }

        function downloadImage() {
            const link = document.createElement('a');
            link.href = currentImageUrl;
            link.download = 'image_' + Date.now() + '.jpg';
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Drag functionality
        function setupDragListeners() {
            const img = document.getElementById('viewerImage');
            
            img.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', endDrag);
            
            // Touch support
            img.addEventListener('touchstart', startDragTouch);
            document.addEventListener('touchmove', dragTouch);
            document.addEventListener('touchend', endDrag);
        }

        function removeDragListeners() {
            const img = document.getElementById('viewerImage');
            
            img.removeEventListener('mousedown', startDrag);
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', endDrag);
            
            img.removeEventListener('touchstart', startDragTouch);
            document.removeEventListener('touchmove', dragTouch);
            document.removeEventListener('touchend', endDrag);
        }

        function startDrag(e) {
            if (currentZoom <= 1) return;
            isDragging = true;
            startX = e.clientX - translateX;
            startY = e.clientY - translateY;
            e.preventDefault();
        }

        function startDragTouch(e) {
            if (currentZoom <= 1) return;
            isDragging = true;
            const touch = e.touches[0];
            startX = touch.clientX - translateX;
            startY = touch.clientY - translateY;
            e.preventDefault();
        }

        function drag(e) {
            if (!isDragging) return;
            translateX = e.clientX - startX;
            translateY = e.clientY - startY;
            updateImageTransform();
        }

        function dragTouch(e) {
            if (!isDragging) return;
            const touch = e.touches[0];
            translateX = touch.clientX - startX;
            translateY = touch.clientY - startY;
            updateImageTransform();
        }

        function endDrag() {
            isDragging = false;
        }

        // Close viewer on ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeImageViewer();
            }
        });

        // Mouse wheel zoom
        document.getElementById('imageViewerModal').addEventListener('wheel', function(e) {
            if (!document.getElementById('imageViewerModal').classList.contains('active')) return;
            
            e.preventDefault();
            if (e.deltaY < 0) {
                zoomIn();
            } else {
                zoomOut();
            }
        });

        // Toggle media menu
        function toggleMediaMenu() {
            const menu = document.getElementById('mediaMenu');
            menu.classList.toggle('active');
            
            // Close menu when clicking outside
            if (menu.classList.contains('active')) {
                setTimeout(() => {
                    document.addEventListener('click', closeMediaMenuOnClickOutside);
                }, 0);
            }
        }

        function closeMediaMenuOnClickOutside(event) {
            const menu = document.getElementById('mediaMenu');
            const button = event.target.closest('.media-button');
            const menuItem = event.target.closest('.media-menu-item');
            
            if (!button && !menuItem) {
                menu.classList.remove('active');
                document.removeEventListener('click', closeMediaMenuOnClickOutside);
            }
        }

        function selectMediaType(type) {
            const menu = document.getElementById('mediaMenu');
            menu.classList.remove('active');
            document.removeEventListener('click', closeMediaMenuOnClickOutside);
            
            switch(type) {
                case 'image':
                    document.getElementById('imageInput').click();
                    break;
                case 'video':
                    document.getElementById('videoInput').click();
                    break;
                case 'audio':
                    document.getElementById('audioInput').click();
                    break;
                // THÊM CASE DOCUMENT
                case 'document':
                    document.getElementById('documentInput').click();
                    break;
            }
        }

        // Handle video selection
        function handleVideoSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Check if file is a video
            if (!file.type.startsWith('video/')) {
                showError('Vui lòng chọn file video');
                return;
            }

            // Check file size (max 50MB)
            if (file.size > 50 * 1024 * 1024) {
                showError('Video quá lớn. Vui lòng chọn video nhỏ hơn 50MB');
                return;
            }

            selectedImage = file; // Reuse selectedImage variable for media files

            // Show preview
            const previewContainer = document.getElementById('previewContainer');
            previewContainer.innerHTML = `
                <div class="image-preview">
                    <div style="padding: 1rem; border: 2px solid var(--accent); border-radius: 4px; background: var(--bg-secondary);">
                        <i class="fas fa-video" style="font-size: 2rem; color: var(--accent);"></i>
                        <p style="margin-top: 0.5rem; font-size: 0.85rem;">${file.name}</p>
                        <p style="font-size: 0.75rem; color: var(--text-dim);">${(file.size / (1024 * 1024)).toFixed(2)} MB</p>
                    </div>
                    <button class="remove-image" onclick="removeImage()">×</button>
                </div>
                <div style='
                    color: rgba(255, 255, 255, 0.6);
                    font-family: sans-serif;
                    font-style: italic;
                '>Web cần thời gian để tải Video lên! Video hiện ngay lập tức sau khi tải lên nên vui lòng không spam!</div>
            `;
            previewContainer.classList.add('active');
        }

        // Handle audio selection
        function handleAudioSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Check if file is audio
            if (!file.type.startsWith('audio/')) {
                showError('Vui lòng chọn file audio');
                return;
            }

            // Check file size (max 20MB)
            if (file.size > 20 * 1024 * 1024) {
                showError('Audio quá lớn. Vui lòng chọn audio nhỏ hơn 20MB');
                return;
            }

            selectedImage = file; // Reuse selectedImage variable for media files

            // Show preview
            const previewContainer = document.getElementById('previewContainer');
            previewContainer.innerHTML = `
                <div class="image-preview">
                    <div style="padding: 1rem; border: 2px solid var(--accent); border-radius: 4px; background: var(--bg-secondary);">
                        <i class="fas fa-microphone" style="font-size: 2rem; color: var(--accent);"></i>
                        <p style="margin-top: 0.5rem; font-size: 0.85rem;">${file.name}</p>
                        <p style="font-size: 0.75rem; color: var(--text-dim);">${(file.size / (1024 * 1024)).toFixed(2)} MB</p>
                    </div>
                    <button class="remove-image" onclick="removeImage()">×</button>
                </div>
                <div style='
                    color: rgba(255, 255, 255, 0.6);
                    font-family: sans-serif;
                    font-style: italic;
                '>Web cần thời gian để tải Audio lên! Audio hiện ngay lập tức sau khi tải lên nên vui lòng không spam!</div>
            `;
            previewContainer.classList.add('active');
        }

        // ========== THÊM HÀM XỬ LÝ FILE DOCUMENTS ==========
        // Handle document selection (pdf, docx, xlsx, zip, etc.)
        function handleDocumentSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Check file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                showError('File quá lớn. Vui lòng chọn file nhỏ hơn 10MB');
                return;
            }

            selectedImage = file; // Reuse selectedImage variable for all file types

            // Get file icon based on extension
            const fileName = file.name;
            const ext = fileName.split('.').pop().toLowerCase();
            let fileIcon = 'fa-file';
            
            const iconMap = {
                'pdf': 'fa-file-pdf',
                'doc': 'fa-file-word', 'docx': 'fa-file-word',
                'xls': 'fa-file-excel', 'xlsx': 'fa-file-excel',
                'ppt': 'fa-file-powerpoint', 'pptx': 'fa-file-powerpoint',
                'zip': 'fa-file-archive', 'rar': 'fa-file-archive', '7z': 'fa-file-archive',
                'txt': 'fa-file-alt',
                'csv': 'fa-file-csv'
            };
            
            if (iconMap[ext]) {
                fileIcon = iconMap[ext];
            }

            // Show preview
            const previewContainer = document.getElementById('previewContainer');
            previewContainer.innerHTML = `
                <div class="image-preview">
                    <div style="padding: 1rem; border: 2px solid var(--accent); border-radius: 4px; background: var(--bg-secondary); text-align: center;">
                        <i class="fas ${fileIcon}" style="font-size: 2rem; color: var(--accent);"></i>
                        <p style="margin-top: 0.5rem; font-size: 0.85rem;">${file.name}</p>
                        <p style="font-size: 0.75rem; color: var(--text-dim);">${(file.size / (1024 * 1024)).toFixed(2)} MB</p>
                    </div>
                    <button class="remove-image" onclick="removeImage()">×</button>
                </div>
                <div style='
                    color: rgba(255, 255, 255, 0.6);
                    font-family: sans-serif;
                    font-style: italic;
                '>Web cần thời gian để tải File lên! File hiện ngay lập tức sau khi tải lên nên vui lòng không spam!</div>
            `;
            previewContainer.classList.add('active');
        }
        // ========== KẾT THÚC HÀM XỬ LÝ DOCUMENTS ==========

        // Handle image selection
        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Check if file is an image
            if (!file.type.startsWith('image/')) {
                showError('Vui lòng chọn file ảnh');
                return;
            }

            // Check file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showError('Ảnh quá lớn. Vui lòng chọn ảnh nhỏ hơn 5MB');
                return;
            }

            selectedImage = file;

            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewContainer = document.getElementById('previewContainer');
                previewContainer.innerHTML = `
                    <div class="image-preview">
                        <img src="${e.target.result}" alt="Preview">
                        <button class="remove-image" onclick="removeImage()">×</button>
                    </div>
                    <div style='
                        color: rgba(255, 255, 255, 0.6);
                    font-family: sans-serif;
                    font-style: italic;
                    '>Web cần thời gian để tải Ảnh lên! Ảnh hiện ngay lập tức sau khi tải lên nên vui lòng không spam!</div>
                `;
                previewContainer.classList.add('active');
            };
            reader.readAsDataURL(file);
        }

        // Remove selected image
        function removeImage() {
            selectedImage = null;
            document.getElementById('previewContainer').innerHTML = '';
            document.getElementById('previewContainer').classList.remove('active');
            document.getElementById('imageInput').value = '';
            document.getElementById('videoInput').value = '';
            document.getElementById('audioInput').value = '';
        }

        // Handle key press
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Logout
        // Show kick popup with countdown
        function showKickPopup(reason, kickedBy) {
            // Ẩn màn hình chat
            const chatScreen = document.getElementById('chatScreen');
            if (chatScreen) {
                chatScreen.style.display = 'none';
            }
            
            // Hiện overlay để che toàn bộ nội dung
            const overlay = document.getElementById('kickOverlay');
            if (overlay) {
                overlay.classList.add('active');
            }
            
            // Create popup element
            const popup = document.createElement('div');
            popup.className = 'kick-popup';
            popup.innerHTML = `
                <h2><i class="fas fa-exclamation-triangle"></i> BẠN ĐÃ BỊ KICK!</h2>
                <div class="kick-info">
                    <strong>Bị kick bởi:</strong> ${escapeHtml(kickedBy)}
                </div>
                <div class="kick-reason">
                    <strong>Lý do:</strong><br>
                    ${escapeHtml(reason)}
                </div>
                <div class="kick-action" style="margin-top: 2rem; text-align: center;">
                    <p style="color: var(--warning); margin-bottom: 1rem;">
                        <i class="fas fa-info-circle"></i> Bạn cần đăng xuất để tiếp tục sử dụng
                    </p>
                    <button onclick="handleLogout()" style="width: auto; padding: 1rem 2rem; margin: 0 auto; display: inline-block; background: var(--danger); border-color: var(--danger);">
                        <span><i class="fas fa-sign-out-alt"></i> Đăng xuất ngay</span>
                    </button>
                </div>
            `;
            
            document.body.appendChild(popup);
        }

        async function handleLogout() {
            // Prevent logout in locked mode
            if (isLockedMode) {
                showError('Không thể đăng xuất trong chế độ này');
                return;
            }

            if (presenceChannel) {
                await presenceChannel.untrack();
                await presenceChannel.unsubscribe();
            }
            if (messagesSubscription) {
                await messagesSubscription.unsubscribe();
            }
            if (kicksSubscription) {
                await kicksSubscription.unsubscribe();
            }

            localStorage.removeItem('currentUser');
            localStorage.removeItem('isAdmin');
            // Keep savedUsername for next login
            location.reload();
        }

        // Utility functions
        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function showError(message, isError = true) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.background = isError ? 'var(--danger)' : 'var(--accent)';
            errorDiv.classList.add('active');
            
            setTimeout(() => {
                errorDiv.classList.remove('active');
            }, 4000);
        }

        // Show system notification
        function showSystemNotification(message, type = 'join') {
            const container = document.getElementById('messagesContainer');
            const notification = document.createElement('div');
            notification.className = `system-notification ${type}`;
            notification.textContent = message;
            container.appendChild(notification);
            scrollToBottom();
        }

        // ========== ROOM CHAT FUNCTIONALITY ==========
        let currentRoom = null;
        let roomsSubscription = null;

        // Show room modal
        function showRoomModal() {
            document.getElementById('roomModal').classList.add('active');
            loadRooms();
        }

        // Load rooms list
        async function loadRooms() {
            try {
                const { data: rooms, error } = await supabaseClient
                    .from('chat_rooms')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const roomsList = document.getElementById('roomsList');
                if (!rooms || rooms.length === 0) {
                    roomsList.innerHTML = '<p style="color: var(--text-dim); padding: 1rem; text-align: center;">Chưa có phòng nào. Hãy tạo phòng đầu tiên!</p>';
                    return;
                }

                roomsList.innerHTML = rooms.map(room => {
                    // Check if current user can delete this room
                    const canDelete = isAdmin || room.created_by === currentUser.username;
                    
                    return `
                        <div class="room-item ${room.password ? 'room-locked' : ''}" style="display: flex; align-items: center; gap: 1rem;">
                            <div onclick="selectRoom('${room.id}', ${room.password ? 'true' : 'false'})" style="flex: 1; cursor: pointer;">
                                <div>
                                    <strong>${escapeHtml(room.name)}</strong>
                                    <div style="font-size: 0.85rem; color: var(--text-dim);">Tạo bởi: ${escapeHtml(room.created_by)}</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                ${room.password ? '<span><i class="fas fa-lock"></i></span>' : ''}
                                ${canDelete ? `
                                    <button 
                                        onclick="event.stopPropagation(); confirmDeleteRoom('${room.id}', '${escapeHtml(room.name).replace(/'/g, "\\'")}');" 
                                        style="
                                            padding: 0.3rem 0.6rem;
                                            background: var(--danger);
                                            border: 1px solid var(--danger);
                                            color: white;
                                            cursor: pointer;
                                            font-size: 0.8rem;
                                            font-family: 'Space Mono', monospace;
                                            transition: all 0.3s;
                                            border-radius: 10px;
                                        "
                                        onmouseover="this.style.opacity='0.8'"
                                        onmouseout="this.style.opacity='1'"
                                    >
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading rooms:', error);
                showError('Lỗi khi tải danh sách phòng');
            }
        }

        // Create new room
        async function createRoom() {
            const roomName = document.getElementById('newRoomName').value.trim();
            const roomPassword = document.getElementById('newRoomPassword').value.trim();

            if (!roomName) {
                showError('Vui lòng nhập tên phòng');
                return;
            }

            try {
                // Check if room name already exists
                const { data: existingRoom, error: checkError } = await supabaseClient
                    .from('chat_rooms')
                    .select('name')
                    .eq('name', roomName)
                    .single();

                if (existingRoom) {
                    showError('Tên phòng đã tồn tại! Vui lòng chọn tên khác.');
                    return;
                }

                // Create new room
                const { data: newRoom, error } = await supabaseClient
                    .from('chat_rooms')
                    .insert([{
                        name: roomName,
                        password: roomPassword || null,
                        created_by: currentUser.username
                    }])
                    .select()
                    .single();

                if (error) throw error;

                showError('Tạo phòng thành công!', false);
                document.getElementById('newRoomName').value = '';
                document.getElementById('newRoomPassword').value = '';

                // Auto join the new room
                joinRoom(newRoom.id, roomPassword);
            } catch (error) {
                console.error('Error creating room:', error);
                showError('Lỗi khi tạo phòng');
            }
        }

        // Select room (check password if needed)
        async function selectRoom(roomId, hasPassword) {
            try {
                const { data: room, error } = await supabaseClient
                    .from('chat_rooms')
                    .select('*')
                    .eq('id', roomId)
                    .single();

                if (error) throw error;

                if (hasPassword) {
                    const enteredPassword = prompt('Nhập mật khẩu phòng:');
                    if (!enteredPassword) return;

                    if (enteredPassword !== room.password) {
                        showError('Mật khẩu không đúng!');
                        return;
                    }
                }

                joinRoom(roomId, room.password);
            } catch (error) {
                console.error('Error selecting room:', error);
                showError('Lỗi khi vào phòng');
            }
        }

        // Join room
        async function joinRoom(roomId, password) {
            try {
                // Get room info
                const { data: room, error } = await supabaseClient
                    .from('chat_rooms')
                    .select('*')
                    .eq('id', roomId)
                    .single();

                if (error) throw error;

                // Unsubscribe from old messages subscription
                if (messagesSubscription) {
                    messagesSubscription.unsubscribe();
                    // Small delay to ensure cleanup
                    await new Promise(resolve => setTimeout(resolve, 200));
                }

                currentRoom = room;
                currentRoomId = room.id;
                currentRoomName = room.name;

                // Update presence với room mới
                if (presenceChannel) {
                    await presenceChannel.track({
                        user_id: currentUser.id,
                        username: currentUser.username,
                        online_at: new Date().toISOString(),
                        room_id: currentRoomId,
                        room_name: currentRoomName
                    });
                }

                // Update chat header with room name
                document.querySelector('.chat-header h2').innerHTML = `<i class="fas fa-circle" style="color: var(--accent);"></i> ${room.name}`;

                // Close modal
                document.getElementById('roomModal').classList.remove('active');

                // Reload messages for this room
                document.getElementById('messagesContainer').innerHTML = '';
                await loadMessages();

                // Subscribe to messages for this room
                subscribeToMessagesForRoom();
                
                // Small delay to ensure subscription is ready
                await new Promise(resolve => setTimeout(resolve, 200));

                showError(`Đã vào phòng: ${room.name}`, false);
                scrollToBottom();
            } catch (error) {
                console.error('Error joining room:', error);
                showError('Lỗi khi vào phòng');
            }
        }

        // Confirm delete room
        function confirmDeleteRoom(roomId, roomName) {
            if (confirm(`Bạn có chắc muốn xóa phòng "${roomName}"?\n\nTất cả tin nhắn trong phòng cũng sẽ bị xóa!`)) {
                deleteRoom(roomId);
            }
        }

        // Delete room
        async function deleteRoom(roomId) {
            try {
                const { error } = await supabaseClient
                    .from('chat_rooms')
                    .delete()
                    .eq('id', roomId);

                if (error) throw error;

                showError('Đã xóa phòng thành công!', false);

                // If user is currently in this room, redirect to default chat
                if (currentRoom && currentRoom.id === roomId) {
                    currentRoom = null;
                    document.querySelector('.chat-header h2').innerHTML = '<i class="fas fa-circle" style="color: var(--accent);"></i> ntdChat v2';
                    document.getElementById('messagesContainer').innerHTML = '';
                    await loadMessages();
                    subscribeToMessagesForRoom();
                }

                // Reload rooms list
                loadRooms();
            } catch (error) {
                console.error('Error deleting room:', error);
                showError('Lỗi khi xóa phòng');
            }
        }

        // Subscribe to messages for specific room
        async function subscribeToMessagesForRoom() {
            // Unsubscribe first if already subscribed
            if (messagesSubscription) {
                await messagesSubscription.unsubscribe();
                // Small delay to ensure cleanup
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            const channelName = currentRoom ? `messages-room-${currentRoom.id}` : 'messages-default';
            console.log('Subscribing to channel:', channelName, 'currentRoom:', currentRoom);
            
            // Subscribe to ALL messages, filter on client side in handleNewMessage
            messagesSubscription = supabaseClient
                .channel(channelName)
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'messages'
                    // Remove filter - we'll filter in handleNewMessage instead
                }, (payload) => {
                    console.log('New message received:', payload);
                    handleNewMessage(payload);
                })
                .on('postgres_changes', {
                    event: 'UPDATE',
                    schema: 'public',
                    table: 'messages'
                    // Remove filter - we'll filter in handleMessageUpdate instead
                }, (payload) => {
                    console.log('Message updated:', payload);
                    handleMessageUpdate(payload);
                })
                .subscribe((status) => {
                    console.log('Subscription status:', status);
                });
        }

        // Subscribe to rooms changes
        function subscribeToRooms() {
            roomsSubscription = supabaseClient
                .channel('rooms_channel')
                .on('postgres_changes', 
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'chat_rooms'
                    }, 
                    () => {
                        // Reload rooms if modal is open
                        const modal = document.getElementById('roomModal');
                        if (modal && modal.classList.contains('active')) {
                            loadRooms();
                        }
                    }
                )
                .subscribe();
        }

        // Add button to show room modal in chat header
        function addRoomButton() {
            const chatHeader = document.querySelector('.chat-header');
            const h2 = chatHeader.querySelector('h2');
            
            // Create room button
            const roomBtn = document.createElement('button');
            roomBtn.className = 'admin-control-btn';
            roomBtn.innerHTML = '<i class="fas fa-door-open"></i> Phòng Chat';
            roomBtn.onclick = showRoomModal;
            roomBtn.style.display = 'inline-block';
            roomBtn.style.marginLeft = '1rem';
            
            // Create "Back to main" button
            const backBtn = document.createElement('button');
            backBtn.className = 'admin-control-btn';
            backBtn.innerHTML = '<i class="fas fa-home"></i> Phòng Chính';
            backBtn.onclick = backToMainRoom;
            backBtn.style.display = 'inline-block';
            backBtn.style.marginLeft = '0.5rem';
            backBtn.id = 'backToMainBtn';
            
            // Insert after h2
            h2.after(roomBtn);
            roomBtn.after(backBtn);
        }

        // Back to main room (default chat without room)
        async function backToMainRoom() {
            try {
                // Simply reload the page - this will keep the username in localStorage
                // and automatically go back to main chat
                window.location.reload();
            } catch (error) {
                console.error('Error going back to main room:', error);
                showError('Lỗi khi quay về phòng chính');
            }
        }

        // Exit current room and return to main chat (reload page)
        async function exitCurrentRoom() {
            window.location.reload();
        }

        // ========== END ROOM CHAT FUNCTIONALITY ==========

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            // Check for URL parameter login first
            checkAutoLogin();
            
            // If not URL login, check localStorage
            if (!isLockedMode) {
                const savedUser = localStorage.getItem('currentUser');
                const savedIsAdmin = localStorage.getItem('isAdmin');
                
                if (savedUser) {
                    const user = JSON.parse(savedUser);
                    document.getElementById('usernameInput').value = user.username;
                    
                    // Trigger input event to show admin fields if needed
                    if (savedIsAdmin === 'true') {
                        document.getElementById('usernameInput').dispatchEvent(new Event('input'));
                    }
                }
            }
        });
    </script>
</body>
</html>