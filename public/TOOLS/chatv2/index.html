<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ntdChat v2</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Archivo+Black&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --bg-main: #000000;
            --bg-secondary: #0a0a0a;
            --bg-message: #1a1a1a;
            --accent: #00ff41;
            --accent-dim: #00cc33;
            --text: #ffffff;
            --text-dim: #999999;
            --border: #00ff41;
            --border-subtle: #333333;
            --danger: #ff3366;
            --warning: #ffaa00;
            --admin: #ff00ff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Mono', monospace;
            background: var(--bg-main);
            color: var(--text);
            overflow: hidden;
            height: 100vh;
        }

        #loginScreen {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: linear-gradient(135deg, #000000 0%, #0a0a0a 100%);
            position: relative;
            overflow: hidden;
        }

        #loginScreen::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: repeating-linear-gradient(0deg,
                    transparent,
                    transparent 2px,
                    rgba(0, 255, 65, 0.03) 2px,
                    rgba(0, 255, 65, 0.03) 4px);
            animation: scanlines 8s linear infinite;
        }

        @keyframes scanlines {
            0% {
                transform: translateY(0);
            }

            100% {
                transform: translateY(50px);
            }
        }

        .login-container {
            background: var(--bg-main);
            border: 2px solid var(--accent);
            padding: 3rem;
            max-width: 400px;
            width: 90%;
            position: relative;
            box-shadow: 0 0 30px rgba(0, 255, 65, 0.3);
            animation: slideIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @media (max-width: 768px) {
            .login-container {
                padding: 2rem 1.5rem;
                width: 95%;
            }

            .login-container h1 {
                font-size: 2rem;
                letter-spacing: 2px;
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.9);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .login-container h1 {
            font-family: 'Archivo Black', sans-serif;
            font-size: 2.5rem;
            color: var(--accent);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
        }

        .login-container p {
            color: var(--text-dim);
            margin-bottom: 2rem;
            font-size: 0.9rem;
        }

        .auth-tabs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .auth-tab-btn {
            width: 100%;
            padding: 0.65rem 0.5rem;
            letter-spacing: 0.5px;
            text-transform: none;
            font-size: 0.9rem;
            border: 1px solid var(--border-subtle);
            background: transparent;
            color: var(--text-dim);
            box-shadow: none;
        }

        .auth-tab-btn::before {
            display: none;
        }

        .auth-tab-btn.active {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(0, 255, 65, 0.08);
        }

        .auth-tab-btn:hover {
            transform: none;
            box-shadow: none;
            border-color: var(--accent);
            color: var(--accent);
        }

        .auth-form {
            display: none;
            animation: fadeIn 0.2s ease;
        }

        .auth-form.active {
            display: block;
        }

        .verification-screen {
            display: none;
            border: 1px solid var(--border-subtle);
            background: rgba(0, 255, 65, 0.04);
            padding: 1rem;
            margin-top: 1rem;
            animation: fadeIn 0.2s ease;
        }

        .verification-screen.active {
            display: block;
        }

        .verification-screen h3 {
            color: var(--accent);
            margin-bottom: 0.6rem;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .verification-screen p {
            margin-bottom: 0.6rem;
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        .verification-email {
            color: var(--text);
            font-weight: 700;
            word-break: break-all;
            margin-bottom: 0.8rem;
        }

        .verification-actions {
            display: grid;
            gap: 0.5rem;
        }

        .verification-btn {
            width: 100%;
            padding: 0.7rem 0.8rem;
            font-size: 0.82rem;
            letter-spacing: 0.5px;
        }

        .verification-btn.secondary {
            background: transparent;
            color: var(--accent);
            border-color: var(--accent);
        }

        .verification-btn.secondary:hover {
            color: #000;
            background: var(--accent);
        }

        .verification-btn.ghost {
            background: transparent;
            color: var(--text-dim);
            border-color: var(--border-subtle);
        }

        .verification-btn.ghost:hover {
            color: var(--text);
            border-color: var(--text-dim);
            box-shadow: none;
            transform: none;
        }

        .auth-note {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-top: 0.8rem;
            text-align: center;
        }

        .auth-switch {
            font-size: 0.8rem;
            color: var(--text-dim);
            text-align: center;
            margin-top: 0.6rem;
        }

        .auth-switch a {
            color: var(--accent);
            text-decoration: none;
        }

        .auth-switch a:hover {
            text-decoration: underline;
        }

        input {
            width: 100%;
            padding: 1rem;
            background: var(--bg-main);
            border: 2px solid var(--border-subtle);
            color: var(--text);
            font-family: 'Space Mono', monospace;
            font-size: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s;
        }

        input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.3);
        }

        button {
            width: 100%;
            padding: 1rem;
            background: var(--accent);
            border: 2px solid var(--accent);
            color: #000000;
            font-family: 'Space Mono', monospace;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            /* background: var(--accent-dim); */
            transform: translate(-50%, -50%);
            transition: width 0.4s, height 0.4s;
            border-radius: 50%;
        }

        button:hover::before {
            width: 300px;
            height: 300px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 255, 65, 0.4);
        }

        button span {
            position: relative;
            z-index: 1;
        }

        #chatScreen {
            display: none;
            height: 100vh;
            flex-direction: column;
            margin-left: 250px;
        }

        .chat-header {
            background: var(--bg-main);
            border-bottom: 2px solid var(--accent);
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        @media (max-width: 768px) {
            .chat-header {
                padding: 1rem;
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .chat-header h2 {
                font-size: 1.2rem;
                letter-spacing: 1px;
            }

            .chat-header .header-controls {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
        }

        .chat-header.admin-header {
            border-bottom-color: var(--admin);
        }

        .chat-header h2 {
            font-family: 'Archivo Black', sans-serif;
            color: var(--accent);
            font-size: 1.5rem;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .admin-header h2 {
            color: var(--admin);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid var(--border-subtle);
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-message);
            flex-shrink: 0;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .user-avatar.has-image img {
            display: block;
        }

        .user-avatar-fallback {
            color: var(--text-dim);
            font-size: 0.75rem;
            font-weight: 700;
        }

        .user-avatar.has-image .user-avatar-fallback {
            display: none;
        }

        .user-name {
            color: var(--text);
            font-weight: 700;
        }

        .admin-badge {
            background: var(--admin);
            color: var(--bg-main);
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            border-radius: 3px;
            display: none;
        }

        .admin-badge.active {
            display: inline-block;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            background: var(--accent);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.5;
                transform: scale(1.2);
            }
        }

        .logout-btn {
            width: auto;
            padding: 0.5rem 1rem;
            background: transparent;
            border: 2px solid var(--danger);
            color: var(--danger);
            font-size: 0.8rem;
        }

        .logout-btn:hover {
            background: var(--danger);
            color: var(--text);
        }

        .online-users {
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            width: 250px;
            background: var(--bg-main);
            border-right: 2px solid var(--accent);
            padding: 1.5rem;
            display: none;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto;
            z-index: 100;
        }

        .online-users.active {
            display: flex;
        }

        .online-users-label {
            color: var(--accent);
            font-size: 0.9rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--accent);
        }

        .online-user {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 0.8rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 5px;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .online-user:hover {
            border-color: var(--accent);
            background: rgba(0, 255, 65, 0.05);
        }

        .online-users::-webkit-scrollbar {
            width: 6px;
        }

        .online-users::-webkit-scrollbar-track {
            background: var(--bg-main);
        }

        .online-users::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 3px;
        }

        .online-dot {
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            background: var(--bg-main);
        }

        .messages-container::-webkit-scrollbar {
            width: 8px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 4px;
        }

        .message {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
            padding: 0.5rem 1rem 0.25rem 1rem;
            background: var(--bg-message);
            border: 1px solid var(--border-subtle);
            border-left: 3px solid var(--accent);
            border-radius: 8px;
            max-width: 600px;
            width: fit-content;
            position: relative;
            animation: messageSlide 0.3s ease-out;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            margin-left: 2.25rem;
            overflow: visible;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .message.own {
            align-self: flex-end;
            border-left: 1px solid var(--border-subtle);
            border-right: 3px solid red;
            margin-left: 0;
        }

        .message.deleted {
            opacity: 0.5;
            background: rgba(255, 51, 102, 0.1);
            border-left-color: var(--danger);
        }

        .message-header {
            display: flex;
            justify-content: center;
            align-items: center;
            position: absolute;
            left: -2.1rem;
            bottom: 0.3rem;
            width: 1.7rem;
        }

        .message-header.hidden {
            display: none;
        }

        .message.own .message-header {
            display: none;
        }

        .message-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 1px solid var(--border-subtle);
            background: var(--bg-main);
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .message-avatar.has-image img {
            display: block;
        }

        .message-avatar-fallback {
            color: var(--text-dim);
            font-size: 0.68rem;
            font-weight: 700;
        }

        .message-avatar.has-image .message-avatar-fallback {
            display: none;
        }

        .message-time {
            color: var(--text-dim);
            font-size: 0.75rem;
        }

        .message-time-bottom {
            display: block;
            width: 100%;
            text-align: right;
            margin-top: 0.2rem;
        }

        .message-content {
            color: var(--text);
            line-height: 1.5;
            word-wrap: break-word;
            position: relative;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .message-text {
            display: block;
            width: 100%;
            word-wrap: break-word;
        }

        .message.bot-message .bot-typing-target.typing::after {
            content: '▋';
            color: var(--accent);
            margin-left: 2px;
            animation: botCaretBlink 1s steps(1, end) infinite;
        }

        @keyframes botCaretBlink {
            50% {
                opacity: 0;
            }
        }

        .private-message-toggle {
            background: rgba(255, 255, 255, 0.04);
            border: 1px dashed var(--accent);
            color: var(--text-dim);
            cursor: pointer;
            font-size: 0.9rem;
            padding: 0.25rem 0.35rem;
            text-align: center;
            border-radius: 6px;
            transition: all 0.2s ease;
            width: fit-content;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .private-message-toggle:not(.revealed) {
            font-size: 0.82rem;
            line-height: 1;
            border-radius: 4px;
        }

        .private-message-toggle:hover {
            color: var(--accent);
            border-color: var(--text);
            background: rgba(255, 255, 255, 0.08);
        }

        .private-message-toggle.revealed {
            border-style: solid;
            color: var(--text);
            background: rgba(255, 255, 255, 0.02);
            width: fit-content;
            max-width: 100%;
            display: inline-block;
            text-align: left;
            padding: 0.45rem 0.6rem;
            overflow-wrap: anywhere;
            word-break: break-word;
        }

        .message-content.deleted-content {
            font-style: italic;
            color: var(--text-dim);
            display: block;
        }

        .delete-reason {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: rgba(255, 51, 102, 0.1);
            border-left: 2px solid var(--danger);
            font-size: 0.8rem;
            color: var(--danger);
        }

        .message-footer {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.25rem;
            flex-wrap: wrap;
        }

        .message-time-inline {
            white-space: nowrap;
            margin-left: auto;
        }

        .message-actions {
            display: inline-flex;
            gap: 0.3rem;
            opacity: 0;
            transition: opacity 0.2s;
            flex-shrink: 0;
            align-items: center;
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .react-btn,
        .delete-msg-btn {
            background: transparent;
            border: 1px solid white;
            color: var(--text);
            padding: 0.3rem 0.6rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            width: auto;
            min-width: 32px;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .react-btn:hover {
            color: var(--accent);
            border-color: var(--accent);
        }

        .delete-msg-btn {
            border-color: var(--danger);
            color: var(--danger);
            display: none;
        }

        .delete-msg-btn.visible {
            display: inline-block;
        }

        .delete-msg-btn:hover {
            color: var(--danger);
            border-color: var(--danger);
        }

        .reaction-picker {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 0;
            background: var(--bg-secondary);
            border: 2px solid var(--accent);
            padding: 0.3rem;
            gap: 0.3rem;
            border-radius: 6px;
            margin-bottom: 0.3rem;
            z-index: 10;
        }

        .reaction-picker.active {
            display: flex;
        }

        .reaction-option {
            font-size: 1.2rem;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .reaction-option:hover {
            transform: scale(1.2);
        }

        .message-reactions {
            display: inline-flex;
            gap: 0.25rem;
            flex-wrap: wrap;
            margin-top: 0;
            align-items: center;
        }

        .reaction {
            display: flex;
            align-items: center;
            gap: 0.2rem;
            padding: 0.15rem 0.35rem;
            background: var(--bg-main);
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .reaction:hover {
            border-color: var(--accent);
            background: rgba(0, 255, 65, 0.1);
        }

        .reaction.active {
            background: var(--accent);
            color: var(--bg-main);
            border-color: var(--accent);
        }

        .reaction span {
            font-size: 0.7rem;
            font-weight: 700;
        }

        /* Kick notification styles */
        .system-message {
            background: rgba(0, 255, 65, 0.1);
            border-left: 3px solid var(--accent);
            padding: 0.8rem;
            margin: 0.5rem 0;
            font-style: italic;
            color: var(--text-dim);
            animation: slideInMessage 0.3s ease;
        }

        .system-message.kick-message {
            background: rgba(255, 51, 102, 0.1);
            border-left: 3px solid var(--danger);
            color: var(--danger);
            font-weight: 600;
        }

        /* Bot message style */
        .message.bot-message {
            background: rgba(0, 255, 65, 0.05);
            border-left: 3px solid yellow;

        }

        .message.bot-message .message-avatar {
            border-color: var(--accent);
        }

        .kick-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-main);
            border: 3px solid var(--danger);
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            z-index: 10000;
            box-shadow: 0 0 50px rgba(255, 51, 102, 0.5);
            animation: kickPopupSlide 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        /* Overlay để che toàn bộ nội dung khi bị kick */
        .kick-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            display: none;
        }

        .kick-overlay.active {
            display: block;
        }

        @keyframes kickPopupSlide {
            from {
                opacity: 0;
                transform: translate(-50%, -60%) scale(0.8);
            }

            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .kick-popup h2 {
            color: var(--danger);
            font-family: 'Archivo Black', sans-serif;
            font-size: 1.8rem;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(255, 51, 102, 0.5);
        }

        .kick-popup .kick-info {
            margin-bottom: 1rem;
        }

        .kick-popup .kick-reason {
            background: rgba(255, 51, 102, 0.1);
            border: 1px solid var(--danger);
            padding: 1rem;
            margin: 1rem 0;
            color: var(--text);
            word-wrap: break-word;
        }

        .kick-popup .kick-timer {
            color: var(--text-dim);
            font-size: 0.9rem;
            text-align: center;
            margin-top: 1rem;
        }

        .input-container {
            padding: 1.5rem;
            background: var(--bg-main);
            border-top: 2px solid var(--accent);
            display: flex;
            gap: 1rem;
            flex-direction: column;
        }

        .preview-container {
            display: none;
            padding: 0.5rem 0;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .preview-container.active {
            display: flex;
        }

        .image-preview {
            position: relative;
            display: inline-block;
        }

        .image-preview img {
            max-width: 100px;
            max-height: 100px;
            border: 2px solid var(--accent);
            border-radius: 4px;
        }

        .image-preview .remove-image {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            font-weight: 700;
        }

        .input-wrapper {
            display: flex;
            gap: 1rem;
        }

        .input-container input {
            flex: 1;
            margin-bottom: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
        }

        .media-btn-container {
            position: relative;
            flex-shrink: 0;
        }

        .media-button {
            background: var(--bg-secondary);
            border: 2px solid var(--accent);
            color: var(--accent);
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.2rem;
            width: auto;
        }

        .media-button:hover {
            background: var(--accent);
            color: #000000;
            transform: none;
            box-shadow: none;
        }

        .media-menu {
            position: absolute;
            bottom: 100%;
            left: 0;
            background: var(--bg-main);
            border: 2px solid var(--accent);
            margin-bottom: 0.5rem;
            display: none;
            flex-direction: column;
            min-width: 180px;
            box-shadow: 0 5px 20px rgba(0, 255, 65, 0.3);
            z-index: 1000;
        }

        .media-menu.active {
            display: flex;
        }

        .media-menu-item {
            padding: 0.75rem 1rem;
            background: transparent;
            border: none;
            color: var(--accent);
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Space Mono', monospace;
            font-size: 0.85rem;
            text-align: left;
            border-bottom: 1px solid var(--border-subtle);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .media-menu-item:last-child {
            border-bottom: none;
        }

        .media-menu-item:hover {
            background: var(--accent);
            color: #000000;
        }

        .media-menu-item i {
            margin-right: 0.5rem;
            width: 20px;
            display: inline-block;
        }

        #imageInput,
        #videoInput,
        #audioInput {
            display: none;
        }

        .message-image {
            max-width: 300px;
            max-height: 300px;
            border-radius: 4px;
            margin-top: 0.5rem;
            cursor: pointer;
            border: 2px solid var(--border-subtle);
            display: block;
        }

        .message-image:hover {
            border-color: var(--accent);
        }

        .message-video,
        .message-audio {
            min-width: 400px;
            max-width: 400px;
            width: 100%;
            margin-top: 0.5rem;
            border-radius: 4px;
            border: 2px solid var(--border-subtle);
            display: block;
            background: var(--bg-secondary);
        }

        .message-audio {
            min-height: 54px;
            height: 54px;
        }

        /* Đảm bảo controls của audio hiển thị đầy đủ */
        .message-audio::-webkit-media-controls-panel {
            display: flex;
            align-items: center;
            height: 50px;
        }

        .message-audio::-webkit-media-controls-enclosure {
            height: 50px;
        }

        .message-video:hover,
        .message-audio:hover {
            border-color: var(--accent);
        }

        /* Image Viewer Dialog */
        .image-viewer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .image-viewer-modal.active {
            display: flex;
        }

        .image-viewer-container {
            position: relative;
            width: 90%;
            height: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .image-viewer-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.8), transparent);
            z-index: 10;
        }

        .image-viewer-title {
            color: var(--accent);
            font-family: 'Archivo Black', sans-serif;
            font-size: 1.2rem;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .image-viewer-close {
            background: var(--danger);
            border: 2px solid var(--danger);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            padding: 0;
        }

        .image-viewer-close:hover {
            transform: rotate(90deg) scale(1.1);
            box-shadow: 0 0 20px rgba(255, 51, 102, 0.6);
        }

        .image-viewer-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            width: 100%;
        }

        .image-viewer-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: transform 0.3s ease;
            cursor: move;
        }

        .image-viewer-controls {
            position: absolute;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 1rem;
            background: rgba(0, 0, 0, 0.8);
            padding: 1rem 2rem;
            border: 2px solid var(--accent);
            border-radius: 50px;
            backdrop-filter: blur(10px);
        }

        .viewer-control-btn {
            background: var(--bg-secondary);
            border: 2px solid var(--accent);
            color: var(--accent);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            padding: 0;
        }

        .viewer-control-btn:hover {
            background: var(--accent);
            color: #000000;
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.5);
        }

        .viewer-control-btn.active {
            background: var(--accent);
            color: #000000;
        }

        .zoom-level {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text);
            font-weight: 700;
            padding: 0 1rem;
            min-width: 80px;
            justify-content: center;
        }

        .input-container input:focus {
            border-color: var(--accent);
        }

        .send-btn {
            width: auto;
            padding: 1rem 2rem;
            background: var(--accent);
            color: #000000;
            font-weight: 700;
        }

        .send-btn:hover {
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.5);
            background: var(--accent-dim);
        }

        .error-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--danger);
            color: var(--text);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            font-weight: 700;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s;
            z-index: 1000;
            max-width: 300px;
        }

        .error-message.active {
            opacity: 1;
            transform: translateX(0);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-main);
            border: 2px solid var(--accent);
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            border-radius: 8px;
            animation: modalSlide 0.3s ease-out;
            box-shadow: 0 10px 40px rgba(0, 255, 65, 0.3);
        }

        .modal-content.danger {
            border-color: var(--danger);
        }

        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 1rem;
            text-transform: uppercase;
        }

        .modal-content.danger .modal-header {
            color: var(--danger);
        }

        .modal-body {
            margin-bottom: 1.5rem;
        }

        .modal-body label {
            display: block;
            color: var(--text-dim);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .modal-body input,
        .modal-body textarea,
        .modal-body select {
            width: 100%;
            padding: 0.8rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            color: var(--text);
            font-family: 'Space Mono', monospace;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            transition: border-color 0.3s;
        }

        .modal-body input:focus,
        .modal-body textarea:focus,
        .modal-body select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .modal-body textarea {
            min-height: 80px;
            resize: vertical;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
        }

        .modal-btn {
            flex: 1;
            padding: 0.8rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            color: var(--text);
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.3s;
        }

        .modal-btn:hover {
            border-color: var(--accent);
        }

        .modal-btn.primary {
            background: var(--accent);
            border-color: var(--accent);
            color: #000000;
        }

        .modal-btn.primary:hover {
            background: var(--accent-dim);
        }

        .modal-btn.danger {
            background: var(--danger);
            border-color: var(--danger);
            color: #ffffff;
        }

        .modal-btn.danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 51, 102, 0.4);
        }

        .theme-color-controls {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            margin-bottom: 0.7rem;
        }

        .theme-color-controls input[type="color"] {
            width: 54px;
            min-width: 54px;
            height: 44px;
            padding: 0.2rem;
            margin-bottom: 0;
            border: 1px solid var(--border-subtle);
            background: var(--bg-secondary);
            cursor: pointer;
        }

        .theme-color-controls input[type="text"] {
            margin-bottom: 0;
        }

        .theme-settings-hint {
            color: var(--text-dim);
            font-size: 0.8rem;
            line-height: 1.4;
        }

        .user-list-item {
            padding: 0.8rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 4px;
            transition: border-color 0.2s;
        }

        .user-list-item:hover {
            border-color: var(--accent);
        }

        .user-list-info {
            flex: 1;
        }

        .user-list-name {
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.3rem;
        }

        .user-list-reason {
            font-size: 0.85rem;
            color: var(--text-dim);
            font-style: italic;
        }

        .unban-btn {
            padding: 0.5rem 1rem;
            background: var(--accent);
            border: 1px solid var(--accent);
            color: #000000;
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 0.8rem;
            transition: all 0.3s;
        }

        .unban-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 65, 0.5);
            background: var(--accent-dim);
        }

        .chat-actions-menu {
            position: relative;
            margin-left: auto;
        }

        .chat-actions-toggle {
            width: auto;
            padding: 0.5rem 0.9rem;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            font-size: 0.8rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            display: inline-flex;
            align-items: center;
            gap: 0.45rem;
        }

        .chat-actions-toggle::before {
            display: none;
        }

        .chat-actions-toggle:hover {
            border-color: var(--accent);
            background: rgba(0, 255, 65, 0.1);
            box-shadow: none;
            transform: none;
        }

        .chat-actions-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 0.45rem);
            right: 0;
            min-width: 210px;
            background: var(--bg-main);
            border: 1px solid var(--border);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.45);
            padding: 0.3rem;
            z-index: 300;
        }

        .chat-actions-dropdown.active {
            display: grid;
            gap: 0.25rem;
        }

        .chat-actions-item {
            width: 100%;
            padding: 0.5rem 0.7rem;
            background: transparent;
            border: 1px solid var(--border-subtle);
            color: var(--text);
            font-size: 0.78rem;
            text-transform: none;
            letter-spacing: 0.4px;
            display: inline-flex;
            align-items: center;
            justify-content: flex-start;
            gap: 0.45rem;
        }

        .chat-actions-item::before {
            display: none;
        }

        .chat-actions-item:hover {
            border-color: var(--accent);
            background: rgba(0, 255, 65, 0.12);
            box-shadow: none;
            transform: none;
        }

        .chat-actions-item.admin-only {
            display: none;
        }

        .chat-actions-menu.active .chat-actions-item.admin-only {
            display: inline-flex;
        }

        .chat-actions-item.danger {
            border-color: var(--danger);
            color: var(--danger);
        }

        .chat-actions-item.danger:hover {
            background: rgba(255, 51, 102, 0.12);
            border-color: var(--danger);
            color: var(--danger);
        }

        @media (max-width: 768px) {
            .online-users {
                width: 200px;
            }

            #chatScreen {
                margin-left: 200px;
            }

            .message {
                max-width: 500px;
            }

            .login-container {
                padding: 2rem;
            }

            .chat-header {
                padding: 1rem;
                flex-direction: column;
                align-items: flex-start;
            }

            .chat-header h2 {
                font-size: 1.2rem;
            }

            .chat-actions-menu {
                margin-left: 0;
            }

            .user-info {
                width: 100%;
                justify-content: space-between;
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-main);
            border: 2px solid var(--accent);
            padding: 2rem;
            max-width: 500px;
            width: 90%;
        }

        .room-item {
            padding: 1rem;
            border: 1px solid var(--border-subtle);
            margin: 0.5rem 0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
        }

        .room-item:hover {
            border-color: var(--accent);
        }

        .room-locked::after {
            content: '';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
        }

        /* System notification styles */
        .system-notification {
            text-align: center;
            padding: 0.5rem 1rem;
            margin: 1rem auto;
            background: rgba(0, 255, 65, 0.1);
            border: 1px solid var(--accent);
            border-radius: 20px;
            color: var(--accent);
            font-size: 0.85rem;
            max-width: 400px;
            animation: notificationSlide 0.4s ease-out;
        }

        @keyframes notificationSlide {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .system-notification.join {
            border-color: var(--accent);
            background: rgba(0, 255, 65, 0.1);
        }

        .system-notification.leave {
            border-color: var(--text-dim);
            background: rgba(153, 153, 153, 0.1);
            color: var(--text-dim);
        }

        /* Online Users List */
        .online-users-section {
            margin-top: 1rem;
            border-top: 1px solid var(--border-subtle);
            padding-top: 1rem;
        }

        .online-users-title {
            color: var(--accent);
            font-size: 0.9rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .online-users-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .online-user-item {
            background: var(--bg-main);
            padding: 0.5rem;
            border-left: 2px solid var(--accent);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
        }

        .online-user-item:hover {
            background: var(--bg-message);
            transform: translateX(3px);
        }

        .online-user-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent);
            animation: pulse 2s infinite;
        }

        .online-user-name {
            flex: 1;
            color: var(--text);
            font-weight: 500;
        }

        .online-user-avatar {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid var(--border-subtle);
            flex-shrink: 0;
        }

        .online-user-avatar-fallback {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 1px solid var(--border-subtle);
            background: var(--bg-message);
            color: var(--text-dim);
            font-size: 0.65rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-weight: 700;
        }

        .online-user-room {
            color: var(--text-dim);
            font-size: 0.75rem;
        }

        /* ========== TÍNH NĂNG GỬI FILE - CSS BỔ SUNG ========== */

        /* File attachment button */
        #fileAttachBtn {
            background: transparent;
            border: 2px solid var(--accent);
            color: var(--accent);
            padding: 0.85rem 1.25rem;
            cursor: pointer;
            transition: all 0.3s;
            width: auto;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        #fileAttachBtn:hover {
            background: var(--accent);
            color: #000000;
        }

        #fileAttachBtn i {
            font-size: 1.1rem;
        }

        #fileInput {
            display: none;
        }

        /* File preview trong input area */
        .file-preview {
            margin-bottom: 0.5rem;
            padding: 0.75rem;
            background: rgba(0, 255, 65, 0.05);
            border: 1px solid var(--accent);
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .file-preview-icon {
            font-size: 1.5rem;
            color: var(--accent);
        }

        .file-preview-info {
            flex: 1;
        }

        .file-preview-name {
            font-size: 0.85rem;
            color: var(--text);
            margin-bottom: 0.25rem;
        }

        .file-preview-size {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .file-preview-remove {
            background: transparent;
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 0.3rem 0.6rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
            width: auto;
        }

        .file-preview-remove:hover {
            background: var(--danger);
            color: #000000;
        }

        /* File attachments trong messages */
        .message-file {
            margin-top: 0.75rem;
        }

        .message-file img {
            max-width: 100%;
            max-height: 400px;
            border: 2px solid var(--accent);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .message-file img:hover {
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.3);
            transform: scale(1.02);
        }

        .message-file audio,
        .message-file video {
            width: 100%;
            max-width: 500px;
            margin-top: 0.5rem;
            border: 2px solid var(--accent);
            border-radius: 4px;
        }

        .file-download-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: transparent;
            border: 2px solid var(--accent);
            color: var(--accent);
            padding: 0.75rem 1.25rem;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
            width: auto;
            text-decoration: none;
            margin-top: 0.5rem;
        }

        .file-download-btn:hover {
            background: var(--accent);
            color: #000000;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 65, 0.3);
        }

        .file-download-btn i {
            font-size: 1rem;
        }

        /* Upload progress */
        .upload-progress {
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background: rgba(0, 255, 65, 0.1);
            border: 1px solid var(--accent);
            border-radius: 4px;
            text-align: center;
            font-size: 0.85rem;
        }

        .upload-progress-bar {
            width: 100%;
            height: 4px;
            background: var(--bg-main);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .upload-progress-fill {
            height: 100%;
            background: var(--accent);
            transition: width 0.3s;
        }

        /* ========== KẾT THÚC CSS FILE ========== */

        /* ========== MOBILE RESPONSIVE CSS ========== */
        @media (max-width: 768px) {

            /* FIX CHAT SCREEN BỊ LỆCH - BỎ MARGIN LEFT */
            #chatScreen {
                margin-left: 0 !important;
                width: 100% !important;
            }

            /* ẨN ONLINE USERS SIDEBAR TRÊN MOBILE */
            .online-users {
                display: none !important;
            }

            /* Chat header - đơn giản hơn trên mobile */
            .chat-header {
                padding: 1rem;
                gap: 0.5rem;
            }

            .chat-header h2 {
                font-size: 1.2rem;
                letter-spacing: 1px;
            }

            .chat-actions-dropdown {
                right: auto;
                left: 0;
                min-width: 190px;
            }

            /* Header controls - chỉ giữ nút logout */
            .header-controls {
                gap: 0.5rem;
            }

            .header-btn {
                padding: 0.6rem 0.9rem;
                font-size: 0.85rem;
            }

            /* Messages Container - giảm padding */
            .messages-container {
                padding: 1rem;
                gap: 0.75rem;
            }

            /* Message - tối ưu kích thước */
            .message {
                max-width: 100%;
                padding: 0.5rem 0.75rem;
                font-size: 0.9rem;
                margin-left: 2rem;
            }

            .message.own {
                margin-left: 0;
            }

            .message-header {
                left: -1.85rem;
                bottom: 0.25rem;
                width: 1.6rem;
            }

            .message-avatar {
                width: 24px;
                height: 24px;
            }

            .message-time {
                font-size: 0.7rem;
            }

            /* Input Container - giảm padding */
            .input-container {
                padding: 1rem;
                gap: 0.75rem;
            }

            .input-wrapper {
                gap: 0.5rem;
            }

            .input-container input {
                font-size: 0.9rem;
                padding: 0.85rem;
            }

            /* Media Buttons - nhỏ hơn trên mobile */
            .media-button,
            #fileAttachBtn {
                padding: 0.75rem;
                font-size: 1rem;
            }

            button {
                padding: 0.85rem 1rem;
                font-size: 0.9rem;
                letter-spacing: 1px;
            }

            /* Modal - full width trên mobile */
            .modal-content {
                width: 95%;
                max-width: 95%;
                padding: 1.5rem;
                max-height: 90vh;
                overflow-y: auto;
            }

            .modal-content h3 {
                font-size: 1.3rem;
            }

            /* Room items */
            .room-item {
                padding: 0.75rem;
                gap: 0.5rem;
            }

            .room-item h4 {
                font-size: 0.95rem;
            }

            .room-item p {
                font-size: 0.75rem;
            }

            /* Admin controls - stack vertically */
            .admin-controls {
                flex-direction: column;
                gap: 0.5rem;
            }

            /* User Info - smaller text */
            .user-info {
                font-size: 0.85rem;
            }

            /* Error Popup */
            .error-popup {
                width: 90%;
                max-width: 90%;
                padding: 1rem;
                font-size: 0.9rem;
            }

            /* Kick Popup */
            .kick-popup {
                width: 95%;
                padding: 1.5rem;
            }

            .kick-popup h2 {
                font-size: 1.5rem;
            }

            .kick-popup p {
                font-size: 0.9rem;
            }

            /* Image previews trong message */
            .message-image img {
                max-width: 100%;
                max-height: 300px;
            }

            .image-preview img {
                max-width: 80px;
                max-height: 80px;
            }

            /* File attachments */
            .message-file {
                font-size: 0.8rem;
            }

            .file-download-btn {
                padding: 0.6rem 1rem;
                font-size: 0.8rem;
            }

            /* Reaction picker - adjust position */
            .reaction-picker {
                left: 50%;
                transform: translateX(-50%);
                width: max-content;
                padding: 0.25rem;
                gap: 0.25rem;
            }

            .reaction-option {
                font-size: 1.1rem;
            }

            /* Reactions - gọn hơn trên mobile */
            .message-reactions {
                gap: 0.2rem;
                margin-top: 0.2rem;
            }

            .reaction {
                padding: 0.1rem 0.3rem;
                font-size: 0.7rem;
                gap: 0.15rem;
                border-radius: 8px;
            }

            .reaction span {
                font-size: 0.65rem;
            }

            /* Message actions buttons */
            .delete-msg-btn,
            .message-actions button {
                padding: 0.4rem 0.7rem;
                font-size: 0.75rem;
            }

            /* Form inputs trong modal */
            .modal-content input,
            .modal-content textarea {
                font-size: 0.9rem;
                padding: 0.8rem;
            }

            .modal-content label {
                font-size: 0.85rem;
            }

            /* Checkbox containers */
            .checkbox-container {
                font-size: 0.85rem;
            }

            /* Scroll behavior */
            .messages-container {
                -webkit-overflow-scrolling: touch;
            }

            /* Touch targets - larger for better mobile UX */
            button,
            .header-btn {
                min-height: 30px;
                min-width: 30px;
            }

            /* Notification badges */
            .notification-badge {
                font-size: 0.7rem;
                padding: 0.15rem 0.4rem;
            }

            /* Online users list in modal */
            .online-users-list {
                max-height: 200px;
            }

            .online-user-item {
                font-size: 0.8rem;
                padding: 0.4rem;
            }
        }

        /* ========== SMALL MOBILE (width < 400px) ========== */
        @media (max-width: 400px) {
            .chat-header h2 {
                font-size: 1rem;
            }

            .messages-container {
                padding: 0.75rem;
            }

            .message {
                padding: 0.4rem 0.6rem;
                font-size: 0.85rem;
            }

            .input-container {
                padding: 0.75rem;
            }

            .input-container input {
                font-size: 0.85rem;
                padding: 0.75rem;
            }

            .media-button,
            #fileAttachBtn {
                padding: 0.65rem;
                font-size: 0.9rem;
            }

            button {
                font-size: 0.85rem;
                padding: 0.75rem;
            }

            .modal-content {
                padding: 1rem;
            }

            .header-btn {
                padding: 0.5rem 0.7rem;
                font-size: 0.8rem;
            }
        }

        /* ========== REPLY & EDIT STYLES ========== */

        /* Reply indicator */
        .reply-indicator {
            display: none;
            padding: 0.75rem 1rem;
            background: rgba(0, 255, 65, 0.1);
            border-left: 3px solid var(--accent);
            margin: 0 1rem 0.5rem 1rem;
            position: relative;
            animation: slideDown 0.3s ease;
        }

        .reply-indicator.active {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .reply-indicator .reply-to {
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-bottom: 0.25rem;
        }

        .reply-indicator .reply-content {
            font-size: 0.9rem;
            color: var(--text);
            font-style: italic;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .reply-indicator .cancel-reply {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: transparent;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            padding: 0.2rem 0.5rem;
            font-size: 1rem;
        }

        .reply-indicator .cancel-reply:hover {
            color: var(--danger);
        }

        /* Replied message display in message */
        .replied-message {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-left: 2px solid var(--accent);
            font-size: 0.85rem;
            font-style: italic;
        }

        .replied-message .replied-user {
            color: var(--accent);
            font-weight: 700;
        }

        .replied-message .replied-content {
            color: var(--text-dim);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Edit mode */
        .message.editing .message-text {
            display: none !important;
        }

        .message.editing .edit-input {
            display: block !important;
        }

        .edit-input {
            display: none;
            width: 100%;
            padding: 0.5rem;
            background: var(--bg-main);
            border: 2px solid var(--accent);
            color: var(--text);
            font-family: 'Space Mono', monospace;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            resize: vertical;
            min-height: 60px;
        }

        .edit-actions {
            display: none;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .message.editing .edit-actions {
            display: flex;
        }

        .edit-actions button {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            background: transparent;
            border: 2px solid var(--accent);
            color: var(--accent);
            cursor: pointer;
            font-family: 'Space Mono', monospace;
            transition: all 0.3s;
            font-weight: 700;
        }

        .edit-actions button:hover {
            background: var(--accent);
            color: #000;
        }

        .edit-actions button:last-child {
            border-color: var(--danger);
            color: var(--danger);
        }

        .edit-actions button:last-child:hover {
            background: var(--danger);
            color: #fff;
        }

        /* Edited label */
        .edited-label {
            font-size: 0.75rem;
            color: var(--text-dim);
            font-style: italic;
            margin-left: 0.5rem;
        }

        /* Reply/Edit buttons in message actions */
        .message-actions .reply-btn,
        .message-actions .edit-btn {
            background: transparent;
            border: 1px solid white;
            color: var(--text);
            padding: 0.3rem 0.6rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 4px;
            min-width: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .message-actions .reply-btn:hover {
            border-color: lightseagreen;
            color: lightseagreen;
        }

        .message-actions .edit-btn:hover {
            border-color: var(--warning);
            background: rgba(255, 170, 0, 0.1);
            color: var(--warning);
        }
    </style>
</head>

<body>
    <!-- Kick Overlay - Che toàn bộ màn hình khi bị kick -->
    <div class="kick-overlay" id="kickOverlay"></div>

    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="login-container">
            <h1>ntdChat v2</h1>
            <p>Đăng nhập bằng tài khoản dùng chung với ntdMusic</p>

            <div class="auth-tabs">
                <button type="button" id="loginTabBtn" class="auth-tab-btn active" onclick="switchAuthTab('login')">
                    Đăng nhập
                </button>
                <button type="button" id="registerTabBtn" class="auth-tab-btn" onclick="switchAuthTab('register')">
                    Đăng ký
                </button>
            </div>

            <form id="loginForm" class="auth-form active" onsubmit="handleLogin(event)">
                <input type="email" id="loginEmail" placeholder="Email" autocomplete="email" required>
                <input type="password" id="loginPassword" placeholder="Mật khẩu" autocomplete="current-password" required>
                <button type="submit">
                    <span>Đăng nhập</span>
                </button>
                <div class="auth-switch">
                    Chưa có tài khoản?
                    <a href="#" onclick="event.preventDefault(); switchAuthTab('register')">Đăng ký ngay</a>
                </div>
            </form>

            <form id="registerForm" class="auth-form" onsubmit="handleRegister(event)">
                <input type="text" id="registerDisplayName" placeholder="Tên hiển thị (3-20 ký tự)" maxlength="20" autocomplete="nickname" required>
                <input type="email" id="registerEmail" placeholder="Email" autocomplete="email" required>
                <input type="tel" id="registerPhone" placeholder="Số điện thoại (VD: 0912345678)" autocomplete="tel" required>
                <input type="password" id="registerPassword" placeholder="Mật khẩu (tối thiểu 6 ký tự)" autocomplete="new-password" required>
                <input type="password" id="registerConfirmPassword" placeholder="Nhập lại mật khẩu" autocomplete="new-password" required>
                <button type="submit">
                    <span>Tạo tài khoản</span>
                </button>
                <div class="auth-switch">
                    Đã có tài khoản?
                    <a href="#" onclick="event.preventDefault(); switchAuthTab('login')">Đăng nhập</a>
                </div>
            </form>

            <div id="verificationScreen" class="verification-screen">
                <h3><i class="fas fa-envelope-open-text"></i> Chờ xác minh email</h3>
                <p id="verificationDescription">
                    Tài khoản của bạn chưa xác minh. Mở email và bấm vào liên kết xác minh để tiếp tục.
                </p>
                <div class="verification-email" id="verificationEmail"></div>
                <div class="verification-actions">
                    <button type="button" class="verification-btn" onclick="openGmailInbox()">
                        <span><i class="fas fa-envelope-open-text"></i> Truy cập Gmail</span>
                    </button>
                    <button type="button" id="resendVerificationBtn" class="verification-btn secondary"
                        onclick="handleResendVerificationEmail()">
                        <span>Gửi lại email xác minh</span>
                    </button>
                    <button type="button" class="verification-btn secondary" onclick="handleVerificationChecked()">
                        <span>Tôi đã xác minh, kiểm tra lại</span>
                    </button>
                    <button type="button" class="verification-btn ghost" onclick="switchAuthTab('login')">
                        <span>Quay lại đăng nhập</span>
                    </button>
                </div>
            </div>

            <div class="auth-note" id="authNote">Dữ liệu tài khoản được đồng bộ với tools ntdMusic.</div>
        </div>
    </div>

    <!-- Chat Screen -->
    <div class="online-users">
        <span class="online-users-label"><i class="fas fa-bolt"></i> ONLINE USERS</span>
        <div id="onlineUsersList"></div>
    </div>

        <div id="chatScreen">
            <div class="chat-header">
                <h2><i class="fas fa-circle" style="color: var(--accent);"></i> ntdChat v2</h2>
                <div class="chat-actions-menu" id="adminControls">
                    <button type="button" class="chat-actions-toggle" onclick="toggleChatActionsMenu(event)">
                        <i class="fas fa-bars"></i> Menu
                    </button>
                    <div class="chat-actions-dropdown" id="chatActionsDropdown">
                        <button type="button" class="chat-actions-item" onclick="showSettingsModal(); closeChatActionsMenu();">
                            <i class="fas fa-palette"></i> Cài đặt
                        </button>
                        <button type="button" class="chat-actions-item" onclick="showRoomModal(); closeChatActionsMenu();">
                            <i class="fas fa-door-open"></i> Phòng chat
                        </button>
                        <button type="button" class="chat-actions-item" onclick="backToMainRoom(); closeChatActionsMenu();">
                            <i class="fas fa-home"></i> Phòng chính
                        </button>
                        <button type="button" class="chat-actions-item admin-only danger" onclick="showKickModal(); closeChatActionsMenu();">
                            <i class="fas fa-exclamation-triangle"></i> Kick User
                        </button>
                        <button type="button" class="chat-actions-item admin-only" onclick="showUnbanModal(); closeChatActionsMenu();">
                            <i class="fas fa-check-circle"></i> Unban
                        </button>
                    </div>
                </div>
                <div class="user-info">
                    <span class="admin-badge" id="adminBadge">ADMIN</span>
                <div class="user-avatar" id="userAvatarContainer">
                    <img id="userAvatar" alt="Avatar">
                    <span class="user-avatar-fallback" id="userAvatarFallback">U</span>
                </div>
                <span class="user-name" id="userName"></span>
                <div class="status-indicator"></div>
                <button class="logout-btn" onclick="handleLogout()">
                    <span>Đăng xuất</span>
                </button>
            </div>
            <!-- Room Selection Modal -->
            <div id="roomModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header"><i class="fas fa-door-open"></i> CHỌN/TẠO PHÒNG CHAT</div>
                    <div class="modal-body">
                        <label>Danh sách phòng:</label>
                        <div id="roomsList" style="max-height: 300px; overflow-y: auto; margin-bottom: 2rem;">
                            <p style="color: var(--text-dim); text-align: center;">Đang tải...</p>
                        </div>

                        <label>Tạo phòng mới:</label>
                        <input type="text" id="newRoomName" placeholder="Tên phòng...">
                        <input type="password" id="newRoomPassword" placeholder="Mật khẩu (để trống = công khai)">
                    </div>
                    <div class="modal-actions">
                        <button class="modal-btn"
                            onclick="document.getElementById('roomModal').classList.remove('active')">Đóng</button>
                        <button class="modal-btn primary" onclick="createRoom()">Tạo Phòng</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="messages-container" id="messagesContainer">
            <div style="text-align: center; color: var(--text-dim); padding: 2rem;">
                Chưa có tin nhắn nào. Hãy bắt đầu cuộc trò chuyện! <i class="fas fa-rocket"></i>
            </div>
        </div>

        <div class="input-container">
            <div class="preview-container" id="previewContainer"></div>

            <!-- Reply Indicator -->
            <div class="reply-indicator" id="replyIndicator">
                <div class="reply-to">Đang trả lời:</div>
                <div class="reply-content" id="replyContent"></div>
                <button class="cancel-reply" onclick="cancelReply()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="input-wrapper">
                <div class="media-btn-container">
                    <button class="media-button" onclick="toggleMediaMenu()" title="Gửi media">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <div class="media-menu" id="mediaMenu">
                        <button class="media-menu-item" onclick="selectMediaType('image')">
                            <i class="fas fa-image"></i> Gửi ảnh
                        </button>
                        <button class="media-menu-item" onclick="selectMediaType('video')">
                            <i class="fas fa-video"></i> Gửi video
                        </button>
                        <button class="media-menu-item" onclick="selectMediaType('audio')">
                            <i class="fas fa-microphone"></i> Gửi audio
                        </button>
                        <!-- THÊM OPTION GỬI FILE KHÁC -->
                        <button class="media-menu-item" onclick="selectMediaType('document')">
                            <i class="fas fa-file-alt"></i> Gửi file khác
                        </button>
                    </div>
                </div>
                <input type="file" id="imageInput" accept="image/*" onchange="handleImageSelect(event)"
                    style="display: none;">
                <input type="file" id="videoInput" accept="video/*" onchange="handleVideoSelect(event)"
                    style="display: none;">
                <input type="file" id="audioInput" accept="audio/*" onchange="handleAudioSelect(event)"
                    style="display: none;">
                <!-- THÊM INPUT CHO CÁC FILE KHÁC -->
                <input type="file" id="documentInput" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.zip,.rar,.7z"
                    onchange="handleDocumentSelect(event)" style="display: none;">
                <input type="text" id="messageInput" placeholder="Nhập tin nhắn..." onkeypress="handleKeyPress(event)"
                    autocomplete="off">
                <button class="send-btn" onclick="sendMessage()">
                    <span>Gửi <i class="fas fa-arrow-right"></i></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Message Modal -->
    <div class="modal" id="deleteMessageModal">
        <div class="modal-content danger">
            <div class="modal-header"><i class="fas fa-trash-alt"></i> Xóa tin nhắn</div>
            <div class="modal-body">
                <label>Lý do xóa tin nhắn:</label>
                <textarea id="deleteReasonInput" placeholder="Nhập lý do xóa tin nhắn này..."></textarea>
            </div>
            <div class="modal-actions">
                <button class="modal-btn" onclick="closeDeleteModal()">Hủy</button>
                <button class="modal-btn danger" onclick="confirmDeleteMessage()">Xóa</button>
            </div>
        </div>
    </div>

    <!-- Kick User Modal -->
    <div class="modal" id="kickUserModal">
        <div class="modal-content danger">
            <div class="modal-header"><i class="fas fa-exclamation-triangle"></i> Kick người dùng</div>
            <div class="modal-body">
                <label>Chọn người dùng:</label>
                <select id="kickUserSelect">
                    <option value="">-- Chọn người dùng --</option>
                </select>

                <label>Lý do kick:</label>
                <textarea id="kickReasonInput" placeholder="Nhập lý do kick người dùng này..."></textarea>
            </div>
            <div class="modal-actions">
                <button class="modal-btn" onclick="closeKickModal()">Hủy</button>
                <button class="modal-btn danger" onclick="confirmKickUser()">Kick</button>
            </div>
        </div>
    </div>

    <!-- Unban User Modal -->
    <div class="modal" id="unbanUserModal">
        <div class="modal-content">
            <div class="modal-header"><i class="fas fa-check-circle"></i> Unban người dùng</div>
            <div class="modal-body">
                <label>Danh sách người dùng bị kick:</label>
                <div id="bannedUsersList" style="max-height: 300px; overflow-y: auto;">
                    <div style="text-align: center; color: var(--text-dim); padding: 1rem;">
                        Đang tải...
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn" onclick="closeUnbanModal()">Đóng</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header"><i class="fas fa-palette"></i> Cài đặt giao diện</div>
            <div class="modal-body">
                <label>Màu chủ đạo</label>
                <div class="theme-color-controls">
                    <input type="color" id="themeColorPicker" value="#00ff41" oninput="handleThemeColorPickerInput()">
                    <input type="text" id="themeColorHexInput" placeholder="#00FF41" maxlength="7" oninput="handleThemeColorHexInput()">
                </div>
                <div class="theme-settings-hint">
                    Hỗ trợ mã HEX dạng #RRGGBB. Bạn cũng có thể dùng lệnh <strong>/color #RRGGBB</strong>.
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn" onclick="closeSettingsModal()">Đóng</button>
                <button class="modal-btn" onclick="resetThemeColorFromSettings()">Mặc định</button>
                <button class="modal-btn primary" onclick="saveThemeColorFromSettings()">Lưu màu</button>
            </div>
        </div>
    </div>

    <!-- Image Viewer Modal -->
    <div class="image-viewer-modal" id="imageViewerModal">
        <div class="image-viewer-container">
            <div class="image-viewer-header">
                <div class="image-viewer-title"><i class="fas fa-image"></i> Image Viewer</div>
                <button class="image-viewer-close" onclick="closeImageViewer()">×</button>
            </div>

            <div class="image-viewer-content" id="imageViewerContent">
                <img id="viewerImage" class="image-viewer-image" src="" alt="Viewing image">
            </div>

            <div class="image-viewer-controls">
                <button class="viewer-control-btn" onclick="zoomOut()" title="Thu nhỏ">-</button>
                <div class="zoom-level" id="zoomLevel">100%</div>
                <button class="viewer-control-btn" onclick="zoomIn()" title="Phóng to">+</button>
                <button class="viewer-control-btn" onclick="rotateLeft()" title="Xoay trái"><i
                        class="fas fa-undo"></i></button>
                <button class="viewer-control-btn" onclick="rotateRight()" title="Xoay phải"><i
                        class="fas fa-redo"></i></button>
                <button class="viewer-control-btn" onclick="resetImage()" title="Reset"><i
                        class="fas fa-sync-alt"></i></button>
                <button class="viewer-control-btn" onclick="downloadImage()" title="Tải xuống"><i
                        class="fas fa-download"></i></button>
            </div>
        </div>
    </div>

    <div class="error-message" id="errorMessage"></div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://gdbtjzebjwnbwbvktcue.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdkYnRqemVianduYndidmt0Y3VlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NDYyMzYsImV4cCI6MjA4NTUyMjIzNn0.FxHP1_wOzNuc7eb3PhuAJ8T6L8RSPjSh6Vw3cskVjiE';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const AUTH_SUPABASE_URL = 'https://ktqdzlhvdkerjajffgfi.supabase.co';
        const AUTH_SUPABASE_PUBLISHABLE_KEY = 'sb_publishable_1wm-eXETyu07vl61sY4mBQ_xwYZVOCj';
        const authSupabaseClient = supabase.createClient(AUTH_SUPABASE_URL, AUTH_SUPABASE_PUBLISHABLE_KEY, {
            auth: {
                // Avoid Navigator LockManager timeout in multi-tab scenarios.
                lock: async (_name, _acquireTimeout, fn) => await fn()
            }
        });
        const DEFAULT_ACCENT_COLOR = '#00ff41';
        const DEFAULT_ACCENT_DIM_COLOR = '#00cc33';

        /* 
         * IMPORTANT: To enable UNBAN functionality, you need to add RLS policies in Supabase:
         * 
         * For 'kicks' table, add these policies:
         * 
         * 1. Allow UPDATE for admins:
         * CREATE POLICY "Admins can update kicks" ON kicks
         * FOR UPDATE USING (
         *   EXISTS (
         *     SELECT 1 FROM users 
         *     WHERE users.id = auth.uid() 
         *     AND users.is_admin = true
         *   )
         * );
         * 
         * 2. OR Allow DELETE for admins:
         * CREATE POLICY "Admins can delete kicks" ON kicks
         * FOR DELETE USING (
         *   EXISTS (
         *     SELECT 1 FROM users 
         *     WHERE users.id = auth.uid() 
         *     AND users.is_admin = true
         *   )
         * );
         * 
         * Note: Since we're using anon key (not authenticated users), 
         * you may need to allow public UPDATE/DELETE on kicks table:
         * 
         * CREATE POLICY "Allow public to update kicks" ON kicks FOR UPDATE USING (true);
         * CREATE POLICY "Allow public to delete kicks" ON kicks FOR DELETE USING (true);
         */

        // State
        let currentUser = null;
        let isAdmin = false;
        let presenceChannel = null;
        let messagesSubscription = null;
        let kicksSubscription = null;
        let currentDeleteMessageId = null;
        let selectedImage = null;
        let currentRoomId = null; // ID của phòng hiện tại
        let currentRoomName = null; // Tên của phòng hiện tại
        let currentAuthUser = null;
        let currentProfile = null;
        let pendingVerificationEmail = '';
        const messageAvatarCache = new Map(); // Map<username, avatarUrl>
        const pendingAvatarFetches = new Set(); // Set<username>

        // Reply and Edit state
        let replyToMessage = null;
        let editingMessageId = null;

        // Spam detection variables
        let userMessageHistory = new Map(); // Map<user_id, Array<{content, timestamp}>>
        let userSpamCount = new Map(); // Map<user_id, number>
        const SPAM_CHECK_LIMIT = 5; // Số tin nhắn gần nhất để kiểm tra
        const MAX_SPAM_COUNT = 10; // Số lần spam tối đa trước khi bị kick

        // Image viewer state
        let currentZoom = 1;
        let currentRotation = 0;
        let currentImageUrl = '';
        let isDragging = false;
        let startX = 0;
        let startY = 0;
        let translateX = 0;
        let translateY = 0;

        function switchAuthTab(tab) {
            const isLogin = tab === 'login';
            const isRegister = tab === 'register';

            hideVerificationScreen(true);
            document.getElementById('loginForm').classList.toggle('active', isLogin);
            document.getElementById('registerForm').classList.toggle('active', isRegister);
            document.getElementById('loginTabBtn').classList.toggle('active', isLogin);
            document.getElementById('registerTabBtn').classList.toggle('active', isRegister);
        }

        function setAuthFormDisabled(disabled) {
            document.querySelectorAll('.auth-tab-btn, #loginForm input, #loginForm button, #registerForm input, #registerForm button')
                .forEach(el => {
                    el.disabled = disabled;
                });
        }

        function toggleChatActionsMenu(event) {
            if (event) {
                event.stopPropagation();
            }
            const dropdown = document.getElementById('chatActionsDropdown');
            if (!dropdown) return;
            dropdown.classList.toggle('active');
        }

        function closeChatActionsMenu() {
            const dropdown = document.getElementById('chatActionsDropdown');
            if (!dropdown) return;
            dropdown.classList.remove('active');
        }

        function handleChatActionsOutsideClick(event) {
            const menuContainer = document.getElementById('adminControls');
            if (!menuContainer) return;
            if (menuContainer.contains(event.target)) return;
            closeChatActionsMenu();
        }

        function showVerificationScreen(email, source = 'login') {
            const normalizedEmail = (email || '').trim();
            pendingVerificationEmail = normalizedEmail;

            const authTabs = document.querySelector('.auth-tabs');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const authNote = document.getElementById('authNote');
            const verificationScreen = document.getElementById('verificationScreen');
            const verificationEmail = document.getElementById('verificationEmail');
            const verificationDescription = document.getElementById('verificationDescription');

            if (authTabs) authTabs.style.display = 'none';
            if (loginForm) loginForm.classList.remove('active');
            if (registerForm) registerForm.classList.remove('active');
            if (authNote) authNote.style.display = 'none';

            if (verificationDescription) {
                verificationDescription.textContent = source === 'register'
                    ? 'Đăng ký thành công. Vui lòng mở email xác minh để kích hoạt tài khoản trước khi vào chat.'
                    : 'Tài khoản này chưa xác minh. Vui lòng mở email và bấm liên kết xác minh để tiếp tục.';
            }

            if (verificationEmail) {
                verificationEmail.textContent = normalizedEmail || 'Không xác định email xác minh';
            }

            if (verificationScreen) {
                verificationScreen.classList.add('active');
            }
        }

        function hideVerificationScreen(keepPendingEmail = false) {
            const authTabs = document.querySelector('.auth-tabs');
            const authNote = document.getElementById('authNote');
            const verificationScreen = document.getElementById('verificationScreen');

            if (!keepPendingEmail) {
                pendingVerificationEmail = '';
            }

            if (authTabs) authTabs.style.display = '';
            if (authNote) authNote.style.display = '';
            if (verificationScreen) verificationScreen.classList.remove('active');
        }

        function openGmailInbox() {
            window.open('https://mail.google.com/mail/u/0/#inbox', '_blank', 'noopener');
        }

        async function handleResendVerificationEmail() {
            const email = (pendingVerificationEmail || '').trim();
            if (!email) {
                showError('Không tìm thấy email để gửi lại xác minh.');
                return;
            }

            const resendButton = document.getElementById('resendVerificationBtn');
            if (resendButton) resendButton.disabled = true;

            try {
                await resendSignupConfirmationEmail(email);
                showError('Đã gửi lại email xác minh. Vui lòng kiểm tra hộp thư.', false);
            } catch (error) {
                if (isRateLimitError(error)) {
                    const waitSeconds = getRateLimitWaitSeconds(error, 60);
                    showError(`Bạn thao tác quá nhanh. Vui lòng chờ khoảng ${waitSeconds} giây rồi thử lại.`);
                } else {
                    showError('Không thể gửi lại email xác minh. Vui lòng thử lại sau.');
                }
            } finally {
                if (resendButton) resendButton.disabled = false;
            }
        }

        async function handleVerificationChecked() {
            const loggedIn = await tryAutoLoginWithSession();
            if (loggedIn) return;

            const loginEmailInput = document.getElementById('loginEmail');
            if (loginEmailInput && pendingVerificationEmail) {
                loginEmailInput.value = pendingVerificationEmail;
            }

            hideVerificationScreen(true);
            switchAuthTab('login');
            showError('Nếu đã bấm link xác minh, vui lòng đăng nhập lại để vào chat.', false);
        }

        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        function isEmailNotConfirmedError(error) {
            const message = (error && error.message ? error.message : '').toLowerCase();
            return message.includes('email not confirmed') || message.includes('email_not_confirmed');
        }

        function getRateLimitWaitSeconds(error, fallbackSeconds = 60) {
            if (!error) return fallbackSeconds;

            const message = String(error.message || '');
            const lower = message.toLowerCase();
            if (!lower.includes('rate') && !lower.includes('too many')) {
                return fallbackSeconds;
            }

            const matched = message.match(/\d+/);
            if (!matched) return fallbackSeconds;

            const parsed = Number(matched[0]);
            return Number.isFinite(parsed) && parsed > 0 ? parsed : fallbackSeconds;
        }

        function isRateLimitError(error) {
            if (!error) return false;
            if (error.status === 429) return true;
            const message = String(error.message || '').toLowerCase();
            return message.includes('rate limit') || message.includes('too many requests');
        }

        function getAuthEmailRedirectUrl() {
            return `${window.location.origin}${window.location.pathname}`;
        }

        async function resendSignupConfirmationEmail(email) {
            const { error } = await authSupabaseClient.auth.resend({
                type: 'signup',
                email,
                options: {
                    emailRedirectTo: getAuthEmailRedirectUrl()
                }
            });

            if (error) {
                throw error;
            }
        }

        function getDisplayInitial(text) {
            const safeText = (text || '').trim();
            return safeText ? safeText.charAt(0).toUpperCase() : 'U';
        }

        function isValidHttpUrl(value) {
            try {
                const parsed = new URL(value);
                return parsed.protocol === 'http:' || parsed.protocol === 'https:';
            } catch (error) {
                return false;
            }
        }

        function normalizeHexColor(value) {
            const raw = String(value || '').trim();
            if (!raw) return null;

            const withoutHash = raw.startsWith('#') ? raw.slice(1) : raw;
            if (/^[0-9a-fA-F]{3}$/.test(withoutHash)) {
                return `#${withoutHash.split('').map(ch => ch + ch).join('').toLowerCase()}`;
            }

            if (/^[0-9a-fA-F]{6}$/.test(withoutHash)) {
                return `#${withoutHash.toLowerCase()}`;
            }

            return null;
        }

        function getThemeDimColor(hexColor) {
            const safeHex = normalizeHexColor(hexColor) || DEFAULT_ACCENT_COLOR;
            if (safeHex === DEFAULT_ACCENT_COLOR) {
                return DEFAULT_ACCENT_DIM_COLOR;
            }

            const red = parseInt(safeHex.slice(1, 3), 16);
            const green = parseInt(safeHex.slice(3, 5), 16);
            const blue = parseInt(safeHex.slice(5, 7), 16);
            const darken = (channel) => Math.max(0, Math.min(255, Math.round(channel * 0.78)));
            const toHex = (channel) => darken(channel).toString(16).padStart(2, '0');

            return `#${toHex(red)}${toHex(green)}${toHex(blue)}`;
        }

        function getProfileThemeColor(profile = currentProfile) {
            if (!profile || typeof profile !== 'object') return '';
            const normalized = normalizeHexColor(profile.color);
            return normalized || '';
        }

        function syncThemeSettingsInputs(colorHex) {
            const safeColor = normalizeHexColor(colorHex) || DEFAULT_ACCENT_COLOR;
            const colorPicker = document.getElementById('themeColorPicker');
            const colorHexInput = document.getElementById('themeColorHexInput');

            if (colorPicker) {
                colorPicker.value = safeColor;
            }

            if (colorHexInput) {
                colorHexInput.value = safeColor.toUpperCase();
            }
        }

        function applyThemeColor(colorHex) {
            const safeColor = normalizeHexColor(colorHex) || DEFAULT_ACCENT_COLOR;
            const root = document.documentElement;
            root.style.setProperty('--accent', safeColor);
            root.style.setProperty('--border', safeColor);
            root.style.setProperty('--accent-dim', getThemeDimColor(safeColor));
            syncThemeSettingsInputs(safeColor);
            return safeColor;
        }

        function getCurrentThemeColor() {
            const current = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
            return normalizeHexColor(current) || DEFAULT_ACCENT_COLOR;
        }

        function getProfileAvatarUrl(profile = currentProfile) {
            if (!profile || typeof profile !== 'object') return '';
            return (profile.avatar || '').toString().trim();
        }

        function getMessageAvatarUrl(message) {
            if (!message) return '';

            if (message.user_id === currentUser?.id) {
                return getProfileAvatarUrl();
            }

            const username = (message.username || '').trim();
            if (!username) return '';

            return messageAvatarCache.get(username) || '';
        }

        function applyAvatarToMessageElementsByUsername(username, avatarUrl) {
            if (!username) return;

            const safeUrl = (avatarUrl || '').trim();
            const hasImage = safeUrl && isValidHttpUrl(safeUrl);

            document.querySelectorAll('.message-avatar').forEach(avatarEl => {
                if (avatarEl.getAttribute('data-username') !== username) return;

                const img = avatarEl.querySelector('img');
                if (!img) return;

                if (hasImage) {
                    img.src = safeUrl;
                    avatarEl.classList.add('has-image');
                    img.onerror = () => {
                        avatarEl.classList.remove('has-image');
                    };
                } else {
                    img.removeAttribute('src');
                    avatarEl.classList.remove('has-image');
                }
            });
        }

        async function fetchAvatarForUsername(username) {
            const normalizedUsername = (username || '').trim();
            if (!normalizedUsername) return;

            if (messageAvatarCache.has(normalizedUsername) || pendingAvatarFetches.has(normalizedUsername)) {
                return;
            }

            pendingAvatarFetches.add(normalizedUsername);
            try {
                const { data, error } = await authSupabaseClient
                    .from('profiles')
                    .select('avatar')
                    .eq('display_name', normalizedUsername)
                    .maybeSingle();

                const avatar = !error && data && data.avatar
                    ? data.avatar.toString().trim()
                    : '';

                messageAvatarCache.set(normalizedUsername, avatar);
                applyAvatarToMessageElementsByUsername(normalizedUsername, avatar);
            } catch (error) {
                messageAvatarCache.set(normalizedUsername, '');
                applyAvatarToMessageElementsByUsername(normalizedUsername, '');
            } finally {
                pendingAvatarFetches.delete(normalizedUsername);
            }
        }

        function updateCurrentUserIdentityUI() {
            const username = currentUser && currentUser.username ? currentUser.username : '';
            const avatarUrl = getProfileAvatarUrl();
            const avatarContainer = document.getElementById('userAvatarContainer');
            const avatarImg = document.getElementById('userAvatar');
            const avatarFallback = document.getElementById('userAvatarFallback');
            const userNameEl = document.getElementById('userName');

            if (userNameEl) {
                userNameEl.textContent = username;
            }

            if (avatarFallback) {
                avatarFallback.textContent = getDisplayInitial(username);
            }

            if (avatarContainer && avatarImg) {
                if (avatarUrl && isValidHttpUrl(avatarUrl)) {
                    avatarImg.src = avatarUrl;
                    avatarContainer.classList.add('has-image');
                    avatarImg.onerror = () => {
                        avatarContainer.classList.remove('has-image');
                    };
                } else {
                    avatarImg.removeAttribute('src');
                    avatarContainer.classList.remove('has-image');
                }
            }

            if (username) {
                messageAvatarCache.set(username, avatarUrl || '');
                applyAvatarToMessageElementsByUsername(username, avatarUrl || '');
            }
        }

        async function updatePresenceTracking() {
            if (!presenceChannel || !currentUser) return;

            await presenceChannel.track({
                user_id: currentUser.id,
                username: currentUser.username,
                avatar_url: getProfileAvatarUrl() || null,
                online_at: new Date().toISOString(),
                room_id: currentRoomId,
                room_name: currentRoomName || 'Main'
            });
        }

        async function updateAvatarProfile(avatarUrl) {
            const sanitizedAvatar = avatarUrl ? avatarUrl.trim() : '';
            const userId = currentAuthUser && currentAuthUser.id;
            if (!userId) {
                throw new Error('Không tìm thấy tài khoản đăng nhập.');
            }

            const { data: updatedProfile, error: profileError } = await authSupabaseClient
                .from('profiles')
                .update({ avatar: sanitizedAvatar || null })
                .eq('id', userId)
                .select('*')
                .maybeSingle();

            const metadataPatch = { ...((currentAuthUser && currentAuthUser.user_metadata) || {}) };
            if (sanitizedAvatar) {
                metadataPatch.avatar_url = sanitizedAvatar;
            } else {
                delete metadataPatch.avatar_url;
            }

            const { data: authUpdateData, error: authUpdateError } = await authSupabaseClient.auth.updateUser({
                data: metadataPatch
            });

            if (authUpdateError && !updatedProfile) {
                throw authUpdateError;
            }

            if (authUpdateData && authUpdateData.user) {
                currentAuthUser = authUpdateData.user;
            }

            if (updatedProfile) {
                currentProfile = updatedProfile;
            } else if (!currentProfile) {
                currentProfile = await fetchProfileByUserId(userId);
            }

            updateCurrentUserIdentityUI();
            await updatePresenceTracking();

            if (profileError && !updatedProfile && !authUpdateError) {
                throw profileError;
            }
        }

        async function updateThemeColorProfile(colorHex) {
            const normalizedColor = normalizeHexColor(colorHex);
            if (!normalizedColor) {
                throw new Error('Màu không hợp lệ. Hãy nhập mã HEX dạng #RRGGBB.');
            }

            const userId = currentAuthUser && currentAuthUser.id;
            if (!userId) {
                throw new Error('Không tìm thấy tài khoản đăng nhập.');
            }

            const colorToStore = normalizedColor === DEFAULT_ACCENT_COLOR ? null : normalizedColor;
            const { data: updatedProfile, error } = await authSupabaseClient
                .from('profiles')
                .update({ color: colorToStore })
                .eq('id', userId)
                .select('*')
                .maybeSingle();

            if (error) {
                throw error;
            }

            if (updatedProfile) {
                currentProfile = updatedProfile;
            } else {
                if (!currentProfile) currentProfile = {};
                currentProfile.color = colorToStore;
            }

            applyThemeColor(normalizedColor);
        }

        function showSettingsModal() {
            closeChatActionsMenu();
            const modal = document.getElementById('settingsModal');
            if (!modal) return;

            const currentColor = getProfileThemeColor() || getCurrentThemeColor();
            syncThemeSettingsInputs(currentColor);
            modal.classList.add('active');
        }

        function closeSettingsModal() {
            const modal = document.getElementById('settingsModal');
            if (!modal) return;
            modal.classList.remove('active');
        }

        function handleThemeColorPickerInput() {
            const colorPicker = document.getElementById('themeColorPicker');
            const colorHexInput = document.getElementById('themeColorHexInput');
            if (!colorPicker || !colorHexInput) return;
            colorHexInput.value = colorPicker.value.toUpperCase();
        }

        function handleThemeColorHexInput() {
            const colorHexInput = document.getElementById('themeColorHexInput');
            const colorPicker = document.getElementById('themeColorPicker');
            if (!colorHexInput || !colorPicker) return;

            const normalized = normalizeHexColor(colorHexInput.value);
            if (normalized) {
                colorPicker.value = normalized;
            }
        }

        async function saveThemeColorFromSettings() {
            const colorHexInput = document.getElementById('themeColorHexInput');
            const colorPicker = document.getElementById('themeColorPicker');
            const value = (colorHexInput && colorHexInput.value.trim()) || (colorPicker && colorPicker.value) || '';

            try {
                await updateThemeColorProfile(value);
                showError('Đã cập nhật màu chủ đạo.', false);
                closeSettingsModal();
            } catch (error) {
                showError(error.message || 'Không thể cập nhật màu chủ đạo.');
            }
        }

        async function resetThemeColorFromSettings() {
            try {
                await updateThemeColorProfile(DEFAULT_ACCENT_COLOR);
                showError('Đã đặt lại màu chủ đạo mặc định.', false);
                closeSettingsModal();
            } catch (error) {
                showError(error.message || 'Không thể đặt lại màu chủ đạo.');
            }
        }

        async function fetchProfileByUserId(userId) {
            const { data, error } = await authSupabaseClient
                .from('profiles')
                .select('*')
                .eq('id', userId)
                .maybeSingle();

            if (error) {
                throw error;
            }

            return data;
        }

        async function ensureProfile(user, fallbackData = {}) {
            let profile = await fetchProfileByUserId(user.id);
            if (profile) {
                return profile;
            }

            const metadata = user.user_metadata || {};
            const fallbackName = (fallbackData.displayName || metadata.display_name || (user.email || '').split('@')[0] || '').trim();
            const displayName = fallbackName.slice(0, 20);

            if (!displayName || displayName.length < 3) {
                throw new Error('Tài khoản chưa có tên hiển thị hợp lệ. Vui lòng cập nhật trong ntdMusic.');
            }

            const { data, error } = await authSupabaseClient
                .from('profiles')
                .upsert([{
                    id: user.id,
                    display_name: displayName,
                    email: fallbackData.email || user.email || '',
                    phone: fallbackData.phone || metadata.phone || '',
                    role: 'Member'
                }], {
                    onConflict: 'id'
                })
                .select('*')
                .single();

            if (error) {
                const duplicateMessage = String(error.message || '').toLowerCase();
                const isDuplicate = error.code === '23505' || error.status === 409 || duplicateMessage.includes('duplicate');
                if (isDuplicate) {
                    const existingProfile = await fetchProfileByUserId(user.id);
                    if (existingProfile) {
                        return existingProfile;
                    }
                    if (duplicateMessage.includes('display_name') || duplicateMessage.includes('display name')) {
                        throw new Error('Tên hiển thị này đã được sử dụng. Vui lòng chọn tên khác.');
                    }
                    throw new Error('Hồ sơ tài khoản đã tồn tại. Vui lòng đăng nhập lại.');
                }
                throw error;
            }

            return data;
        }

        async function completeChatLogin(profile, authUser) {
            const username = (profile?.display_name || '').trim();
            if (!username) {
                showError('Không tìm thấy tên hiển thị. Vui lòng cập nhật profile ntdMusic.');
                return;
            }

            hideVerificationScreen();
            isAdmin = profile.role === 'Admin';
            currentAuthUser = authUser;
            currentProfile = profile;
            applyThemeColor(getProfileThemeColor(profile) || DEFAULT_ACCENT_COLOR);

            const { data: existingUser, error: fetchError } = await supabaseClient
                .from('users')
                .select('*')
                .eq('username', username)
                .maybeSingle();

            if (fetchError) {
                throw fetchError;
            }

            let chatUser = existingUser;
            if (chatUser) {
                const shouldUpdateAdmin = !!chatUser.is_admin !== isAdmin;
                if (shouldUpdateAdmin) {
                    const { error: updateUserError } = await supabaseClient
                        .from('users')
                        .update({ is_admin: isAdmin })
                        .eq('id', chatUser.id);

                    if (updateUserError) {
                        throw updateUserError;
                    }

                    chatUser = { ...chatUser, is_admin: isAdmin };
                }
            } else {
                const { data: newUser, error: insertError } = await supabaseClient
                    .from('users')
                    .insert([{
                        username,
                        is_admin: isAdmin
                    }])
                    .select()
                    .single();

                if (insertError) {
                    throw insertError;
                }

                chatUser = newUser;
            }

            if (!isAdmin) {
                try {
                    const { data: kickData, error: kickError } = await supabaseClient
                        .from('kicks')
                        .select('*')
                        .eq('user_id', chatUser.id)
                        .eq('active', true)
                        .maybeSingle();

                    if (kickError) {
                        throw kickError;
                    }

                    if (kickData) {
                        showError(`Bạn đã bị kick khỏi chat!\nLý do: ${kickData.reason}`, true);
                        return;
                    }
                } catch (kickCheckError) {
                    // Continue login even if kick check fails
                }
            }

            currentUser = chatUser;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('chatScreen').style.display = 'flex';
            document.querySelector('.online-users').classList.add('active');
            updateCurrentUserIdentityUI();
            document.getElementById('adminBadge').classList.toggle('active', isAdmin);
            document.querySelector('.chat-header').classList.toggle('admin-header', isAdmin);
            document.getElementById('adminControls').classList.toggle('active', isAdmin);

            await initializeChat();
        }

        async function handleLogin(event) {
            event.preventDefault();

            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showError('Vui lòng nhập đầy đủ email và mật khẩu');
                return;
            }

            setAuthFormDisabled(true);

            try {
                const { data, error } = await authSupabaseClient.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) {
                    if (isEmailNotConfirmedError(error)) {
                        showVerificationScreen(email, 'login');
                        try {
                            await resendSignupConfirmationEmail(email);
                            showError('Email chưa xác minh. Đã gửi lại email xác nhận.', false);
                        } catch (resendError) {
                            if (isRateLimitError(resendError)) {
                                const waitSeconds = getRateLimitWaitSeconds(resendError, 60);
                                showError(`Email chưa xác minh. Có thể gửi lại sau ${waitSeconds} giây.`);
                            } else {
                                showError('Email chưa xác minh. Vui lòng mở email và bấm link xác nhận.', false);
                            }
                        }
                        return;
                    }
                    if (error.message === 'Invalid login credentials') {
                        showError('Thông tin đăng nhập không đúng');
                    } else {
                        showError(`Đăng nhập thất bại: ${error.message}`);
                    }
                    return;
                }

                if (!data || !data.user) {
                    showError('Không tìm thấy thông tin tài khoản sau khi đăng nhập.');
                    return;
                }

                if (!data.user.email_confirmed_at) {
                    showVerificationScreen(email, 'login');
                    showError('Email chưa xác minh. Vui lòng mở email và bấm link xác nhận.', false);
                    return;
                }

                const profile = await ensureProfile(data.user, { email });
                await completeChatLogin(profile, data.user);
                document.getElementById('loginForm').reset();
            } catch (error) {
                showError('Đã xảy ra lỗi khi đăng nhập');
            } finally {
                setAuthFormDisabled(false);
            }
        }

        async function handleRegister(event) {
            event.preventDefault();

            const displayName = document.getElementById('registerDisplayName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const phone = document.getElementById('registerPhone').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;

            if (displayName.length < 3) {
                showError('Tên hiển thị quá ngắn (tối thiểu 3 ký tự)');
                return;
            }

            if (displayName.length > 20) {
                showError('Tên hiển thị tối đa 20 ký tự');
                return;
            }

            const phoneRegex = /^0\d{9}$/;
            if (!phoneRegex.test(phone)) {
                showError('Số điện thoại không hợp lệ (VD: 0912345678)');
                return;
            }

            if (password.length < 6) {
                showError('Mật khẩu phải có ít nhất 6 ký tự');
                return;
            }

            if (password !== confirmPassword) {
                showError('Mật khẩu xác nhận không khớp');
                return;
            }

            setAuthFormDisabled(true);

            try {
                const { data: existingUsers, error: checkError } = await authSupabaseClient
                    .from('profiles')
                    .select('id')
                    .eq('display_name', displayName);

                if (checkError) {
                    throw checkError;
                }

                if (existingUsers && existingUsers.length > 0) {
                    showError('Tên hiển thị này đã được sử dụng');
                    return;
                }

                const { data: authData, error: authError } = await authSupabaseClient.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            display_name: displayName,
                            phone
                        },
                        emailRedirectTo: getAuthEmailRedirectUrl()
                    }
                });

                if (authError) {
                    if (isRateLimitError(authError)) {
                        const waitSeconds = getRateLimitWaitSeconds(authError, 60);
                        showError(`Bạn thao tác quá nhanh. Vui lòng chờ khoảng ${waitSeconds} giây rồi thử lại.`);
                        return;
                    }
                    if (authError.message && authError.message.includes('already registered')) {
                        showError('Email này đã được đăng ký');
                    } else {
                        showError(`Đăng ký thất bại: ${authError.message}`);
                    }
                    return;
                }

                if (!authData.user) {
                    showError('Không thể tạo tài khoản');
                    return;
                }

                const isEmailConfirmed = !!authData.user.email_confirmed_at;

                if (!isEmailConfirmed || !authData.session) {
                    document.getElementById('loginEmail').value = email;
                    showVerificationScreen(email, 'register');
                    showError('Đăng ký thành công. Vui lòng xác minh email để tiếp tục.', false);
                } else {
                    const profile = await ensureProfile(authData.user, {
                        displayName,
                        email,
                        phone
                    });
                    await completeChatLogin(profile, authData.user);
                    showError('Đăng ký thành công.', false);
                }

                document.getElementById('registerForm').reset();
            } catch (error) {
                showError('Đã xảy ra lỗi khi đăng ký');
            } finally {
                setAuthFormDisabled(false);
            }
        }

        async function tryAutoLoginWithSession() {
            try {
                const { data: { session }, error } = await authSupabaseClient.auth.getSession();
                if (error || !session || !session.user) {
                    return false;
                }

                const authUser = session.user;
                const profile = await ensureProfile(authUser, { email: authUser.email || '' });
                await completeChatLogin(profile, authUser);
                return true;
            } catch (error) {
                return false;
            }
        }

        // Initialize chat
        async function initializeChat() {
            try {
                // Setup presence
                presenceChannel = supabaseClient.channel('online-users', {
                    config: { presence: { key: currentUser.id } }
                });

                presenceChannel
                    .on('presence', { event: 'sync' }, () => {
                        const state = presenceChannel.presenceState();
                        updateOnlineUsers(state);

                        // Update kick user list if admin
                        if (isAdmin) {
                            updateKickUserList(state);
                        }
                    })
                    .on('presence', { event: 'join' }, ({ key, newPresences }) => {
                        // Tắt thông báo join - chỉ theo dõi qua online users list
                    })
                    .on('presence', { event: 'leave' }, ({ key, leftPresences }) => {
                        // Tắt thông báo leave - chỉ theo dõi qua online users list
                    })
                    .on('broadcast', { event: 'user-kicked' }, ({ payload }) => {
                        if (payload.userId === currentUser.id) {
                            // Show kick popup with countdown
                            showKickPopup(payload.reason, payload.kickedBy);
                        }
                    })
                    .on('broadcast', { event: 'chat-cleared' }, ({ payload }) => {
                        const targetRoomId = payload && payload.roomId ? payload.roomId : null;
                        const isCurrentTargetRoom = targetRoomId
                            ? (currentRoom && currentRoom.id === targetRoomId)
                            : !currentRoom;

                        if (isCurrentTargetRoom) {
                            setTimeout(() => {
                                window.location.reload();
                            }, 500);
                        }
                    })
                    .subscribe(async (status) => {
                        if (status === 'SUBSCRIBED') {
                            await updatePresenceTracking();
                        }
                    });

                // Load messages
                await loadMessages();

                // Subscribe to messages for current room (or main chat)
                await subscribeToMessagesForRoom();

                // Subscribe to kicks table for realtime kick detection
                kicksSubscription = supabaseClient
                    .channel('kicks-channel')
                    .on('postgres_changes', {
                        event: 'INSERT',
                        schema: 'public',
                        table: 'kicks',
                        filter: `user_id=eq.${currentUser.id}`
                    }, async (payload) => {
                        if (payload.new.active === true) {
                            const kickReason = payload.new.reason;
                            // Dùng popup thay vì alert
                            showKickPopup(kickReason, 'Admin');
                        }
                    })
                    .subscribe();

                // Subscribe to rooms changes
                subscribeToRooms();

                scrollToBottom();
            } catch (error) {
                showError('Không thể kết nối đến chat');
            }
        }

        // Load messages
        async function loadMessages() {
            try {
                let query = supabaseClient
                    .from('messages')
                    .select('*')
                    .order('created_at', { ascending: true })
                    .limit(100);

                // Filter by room if in a room
                if (currentRoom) {
                    query = query.eq('room_id', currentRoom.id);
                } else {
                    // Load messages without room (legacy/default chat)
                    query = query.is('room_id', null);
                }

                const { data, error } = await query;

                if (error) throw error;

                const container = document.getElementById('messagesContainer');
                container.innerHTML = '';

                if (data && data.length > 0) {
                    data.forEach(message => displayMessage(message));
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; color: var(--text-dim); padding: 2rem;">
                            Chưa có tin nhắn nào. Hãy bắt đầu cuộc trò chuyện! <i class="fas fa-rocket"></i>
                        </div>
                    `;
                }
            } catch (error) {
                showError('Không thể tải tin nhắn');
            }
        }

        // Check spam function
        function checkSpam(userId, content) {

            // Khởi tạo lịch sử nếu chưa có
            if (!userMessageHistory.has(userId)) {
                userMessageHistory.set(userId, []);
                userSpamCount.set(userId, 0);
            }

            const history = userMessageHistory.get(userId);
            const trimmedContent = content.trim();


            // Thêm tin nhắn mới vào lịch sử TRƯỚC
            history.push({ content: trimmedContent, timestamp: Date.now() });

            // Giữ lại chỉ 5 tin nhắn gần nhất
            while (history.length > SPAM_CHECK_LIMIT) {
                history.shift();
            }


            // Kiểm tra spam nếu đã có đủ 5 tin nhắn
            if (history.length >= SPAM_CHECK_LIMIT) {
                // Lấy 5 tin nhắn gần nhất
                const last5 = history.slice(-SPAM_CHECK_LIMIT);

                // Kiểm tra xem tất cả 5 tin có giống nhau không
                const firstContent = last5[0].content;
                const allSame = last5.every(h => h.content === firstContent) && firstContent !== '';


                if (allSame) {
                    const spamCount = userSpamCount.get(userId) + 1;
                    userSpamCount.set(userId, spamCount);


                    // Nếu spam >= 10 lần thì kick ngay lập tức
                    if (spamCount >= MAX_SPAM_COUNT) {
                        kickUserForSpam(userId);
                        return true; // Blocked - đã bị kick
                    }

                    // Hiển thị cảnh báo
                    showSpamWarning(spamCount);
                }
            }

            return false; // Không block
        }

        // Show spam warning dialog
        function showSpamWarning(count) {
            const warningMsg = `⚠️ CẢNH BÁO SPAM!\n\nBạn đã spam ${count}/${MAX_SPAM_COUNT} lần.\nNếu tiếp tục spam, bạn sẽ bị kick khỏi chat!`;

            // Tạo dialog cảnh báo
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: fadeIn 0.3s;
            `;

            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: var(--bg-main);
                border: 3px solid var(--warning);
                padding: 2rem;
                max-width: 400px;
                text-align: center;
                box-shadow: 0 0 50px rgba(255, 170, 0, 0.5);
            `;

            dialog.innerHTML = `
                <div style="font-size: 3rem; margin-bottom: 1rem;">⚠️</div>
                <div style="font-size: 1.2rem; font-weight: 700; color: var(--warning); margin-bottom: 1rem;">
                    CẢNH BÁO SPAM!
                </div>
                <div style="color: var(--text); margin-bottom: 1.5rem; white-space: pre-line;">
                    Bạn đã spam ${count}/${MAX_SPAM_COUNT} lần.
                    
                    Nếu tiếp tục spam, bạn sẽ bị kick khỏi chat!
                </div>
                <button onclick="this.parentElement.parentElement.remove()" style="
                    background: var(--warning);
                    color: #000;
                    border: none;
                    padding: 0.75rem 2rem;
                    font-weight: 700;
                    cursor: pointer;
                    font-family: 'Space Mono', monospace;
                ">
                    TÔI ĐÃ HIỂU
                </button>
            `;

            overlay.appendChild(dialog);
            document.body.appendChild(overlay);

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (overlay.parentElement) {
                    overlay.remove();
                }
            }, 5000);
        }

        // Kick user for spam
        async function kickUserForSpam(userId) {

            try {
                // Tạo kick record trong database
                // kicked_by là UUID nên để null (hệ thống tự động kick)
                const { data: kickData, error: kickError } = await supabaseClient
                    .from('kicks')
                    .insert([{
                        user_id: userId,
                        reason: 'Spam tin nhắn (tự động)',
                        active: true
                        // Bỏ kicked_by vì là UUID, để null = hệ thống tự động
                    }])
                    .select();

                if (kickError) {
                } else {
                }

                // Hiển thị overlay kick
                showKickOverlay('Spam tin nhắn (tự động)');

            } catch (error) {
                // Nếu có lỗi vẫn hiển thị kick overlay
                showKickOverlay('Spam tin nhắn (tự động)');
            }
        }

        // Show kick overlay (tái sử dụng từ admin kick)
        function showKickOverlay(reason) {
            const overlay = document.getElementById('kickOverlay');
            overlay.innerHTML = `
                <div class="kick-message">
                    <div class="kick-icon">🚫</div>
                    <h2>BẠN ĐÃ BỊ KICK</h2>
                    <p>Lý do: ${reason}</p>
                    <p style="margin-top: 1rem; color: var(--text-dim); font-size: 0.9rem;">
                        Trang sẽ tự động tải lại sau 3 giây...
                    </p>
                </div>
            `;
            overlay.classList.add('active');

            // Reload page sau 3 giây
            setTimeout(() => {
                window.location.reload();
            }, 3000);
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            const privateCommand = parsePrivateCommand(content);

            if (!content && !selectedImage) return;

            if (privateCommand.isPrivateCommand && !privateCommand.hasMessage) {
                showError('Vui lòng nhập nội dung sau /p hoặc /private');
                return;
            }

            // Kiểm tra spam (chỉ kiểm tra tin nhắn văn bản, không kiểm tra ảnh)
            if (privateCommand.isPrivateCommand) {
                const isSpam = checkSpam(currentUser.id, privateCommand.privateText);
                if (isSpam) {
                    input.value = '';
                    return;
                }
            } else if (content && !content.startsWith('/')) {
                const isSpam = checkSpam(currentUser.id, content);
                if (isSpam) {
                    // Bị kick vì spam, không gửi tin nhắn
                    input.value = '';
                    return;
                }
            }

            // Disable button before starting async operations
            const sendBtn = document.querySelector('.send-btn');
            const originalBtnContent = sendBtn.innerHTML;

            if (sendBtn) {
                sendBtn.disabled = true;
                sendBtn.innerHTML = '<span>Đang gửi... <i class="fas fa-spinner fa-spin"></i></span>';
                sendBtn.style.opacity = '0.7';
                sendBtn.style.cursor = 'not-allowed';
            }

            try {
                // Commands that should not be shown in chat
                const isHiddenCommand = content.toLowerCase().startsWith('/createroom') ||
                    content.toLowerCase().startsWith('/join') ||
                    content.toLowerCase().startsWith('/exitroom') ||
                    content.toLowerCase().startsWith('/clear');
                const normalizedContent = privateCommand.isPrivateCommand
                    ? encodePrivateContent(privateCommand.privateText)
                    : content;

                let imageUrl = null;

                // Upload image if selected
                if (selectedImage) {
                    const fileExt = selectedImage.name.split('.').pop();
                    const fileName = `${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;
                    const filePath = `chat-images/${fileName}`;

                    // Xác định contentType dựa vào loại file
                    const uploadOptions = {
                        contentType: selectedImage.type || 'application/octet-stream',
                        cacheControl: '3600',
                        upsert: false
                    };

                    const { error: uploadError } = await supabaseClient.storage
                        .from('images')
                        .upload(filePath, selectedImage, uploadOptions);

                    if (uploadError) {
                        showError('Không thể tải file lên');
                        // Nếu lỗi upload, return sớm (finally sẽ chạy để enable lại nút)
                        return;
                    }

                    const { data: urlData } = supabaseClient.storage
                        .from('images')
                        .getPublicUrl(filePath);

                    imageUrl = urlData.publicUrl;
                }

                // Only send message to database if it's not a hidden command
                if (!isHiddenCommand) {
                    const messageData = {
                        user_id: currentUser.id,
                        username: currentUser.username,
                        content: normalizedContent || '',
                        image_url: imageUrl,
                        reactions: {},
                        room_id: currentRoom ? currentRoom.id : null
                    };

                    // Add reply information if replying
                    if (replyToMessage) {
                        messageData.reply_to = replyToMessage.id;
                        messageData.reply_to_username = replyToMessage.username;
                        messageData.reply_to_content = replyToMessage.content;
                    }

                    const { error } = await supabaseClient
                        .from('messages')
                        .insert([messageData]);

                    if (error) throw error;
                }

                // Bot command handler
                if (content.startsWith('/') && !privateCommand.isPrivateCommand) {
                    const command = content.toLowerCase().trim();

                    setTimeout(async () => {
                        let botResponse = '';
                        let shouldSendResponse = true;

                        if (command === '/time') {
                            // /time command - show current time
                            const now = new Date();
                            const vietnamTime = now.toLocaleString('vi-VN', {
                                timeZone: 'Asia/Ho_Chi_Minh',
                                weekday: 'long',
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit'
                            });
                            botResponse = `⏰ Thời gian hiện tại:\n${vietnamTime}`;

                        } else if (command === '/help' || command === '/') {
                            // /help command - show available commands
                            const adminSection = '';

                            botResponse = `📚 DANH SÁCH LỆNH\n\n` +
                                `⚙️ CƠ BẢN\n` +
                                `⏰ /time - Hiển thị thời gian hiện tại (giờ Việt Nam)\n` +
                                `📚 /help hoặc / - Hiển thị danh sách lệnh\n\n` +
                                `👤 TÀI KHOẢN\n` +
                                `🖼️ /avatar <url> - Đổi avatar tài khoản\n` +
                                `🧹 /avatar clear - Xóa avatar hiện tại\n` +
                                `🎨 /color <#RRGGBB> - Đổi màu chủ đạo giao diện\n` +
                                `♻️ /color reset - Đặt lại màu mặc định\n\n` +
                                `💬 TIN NHẮN\n` +
                                `🔒 /p <tin nhắn> hoặc /private <tin nhắn> - Gửi tin nhắn bí mật\n\n` +
                                `🚪 ROOM CHAT\n` +
                                `🚪 /createroom <tên> <mật khẩu> - Tạo phòng chat mới (mật khẩu tùy chọn)\n` +
                                `📋 /room - Xem danh sách phòng chat hiện có\n` +
                                `🔑 /join <số> <mật khẩu> - Vào phòng nhanh (mật khẩu nếu có)\n` +
                                `🧹 /clear <mật khẩu> - Xóa tin nhắn phòng hiện tại (khi đang ở trong phòng)\n` +
                                `🧹 /clear <số> [mật khẩu] - Xóa tin nhắn phòng theo số (ở phòng chính)\n` +
                                `🧹 /clear main (hoặc /clear 0) - Xóa tin nhắn phòng chính (admin)\n` +
                                `🚶 /exitroom - Thoát phòng hiện tại, về phòng chính\n` +
                                adminSection +
                                `\n💡 Cách dùng: Gõ lệnh bắt đầu bằng dấu / rồi gửi tin nhắn.`;

                        } else if (command.startsWith('/avatar')) {
                            shouldSendResponse = true;
                            const avatarArg = content.slice(7).trim();

                            if (!avatarArg) {
                                const currentAvatar = getProfileAvatarUrl();
                                botResponse = currentAvatar
                                    ? `🖼️ Avatar hiện tại:\n${currentAvatar}\n\n💡 Dùng /avatar <url> để thay đổi hoặc /avatar clear để xóa.`
                                    : `🖼️ Bạn chưa có avatar.\n\n💡 Dùng /avatar <url> để đặt avatar hoặc /avatar clear để xóa.`;
                            } else if (['clear', 'reset', 'none'].includes(avatarArg.toLowerCase())) {
                                try {
                                    await updateAvatarProfile('');
                                    botResponse = '✅ Đã xóa avatar của bạn.';
                                } catch (error) {
                                    botResponse = `❌ Không thể xóa avatar.\n\n${error.message || ''}`.trim();
                                }
                            } else if (!isValidHttpUrl(avatarArg)) {
                                botResponse = '❌ URL avatar không hợp lệ. Chỉ chấp nhận link http/https.';
                            } else {
                                try {
                                    await updateAvatarProfile(avatarArg);
                                    botResponse = '✅ Đã cập nhật avatar thành công.';
                                } catch (error) {
                                    botResponse = `❌ Không thể cập nhật avatar.\n\n${error.message || ''}`.trim();
                                }
                            }

                        } else if (command.startsWith('/color')) {
                            shouldSendResponse = true;
                            const colorArg = content.slice(6).trim();

                            if (!colorArg) {
                                const currentColor = (getProfileThemeColor() || getCurrentThemeColor()).toUpperCase();
                                botResponse = `🎨 Màu chủ đạo hiện tại: ${currentColor}\n\n💡 Dùng /color #RRGGBB để đổi màu hoặc /color reset để về mặc định.`;
                            } else if (['clear', 'reset', 'default', 'macdinh'].includes(colorArg.toLowerCase())) {
                                try {
                                    await updateThemeColorProfile(DEFAULT_ACCENT_COLOR);
                                    botResponse = '✅ Đã đặt lại màu chủ đạo mặc định.';
                                } catch (error) {
                                    botResponse = `❌ Không thể đặt lại màu.\n\n${error.message || ''}`.trim();
                                }
                            } else {
                                const normalizedColor = normalizeHexColor(colorArg);
                                if (!normalizedColor) {
                                    botResponse = '❌ Màu không hợp lệ. Vui lòng dùng mã HEX dạng #RRGGBB.';
                                } else {
                                    try {
                                        await updateThemeColorProfile(normalizedColor);
                                        botResponse = `✅ Đã đổi màu chủ đạo thành ${normalizedColor.toUpperCase()}.`;
                                    } catch (error) {
                                        botResponse = `❌ Không thể cập nhật màu.\n\n${error.message || ''}`.trim();
                                    }
                                }
                            }

                        } else if (command.startsWith('/clear')) {
                            // /clear command - clear room messages by room password
                            shouldSendResponse = false;

                            const clearArgs = content.slice(6).trim();

                            if (!clearArgs) {
                                if (currentRoom) {
                                    botResponse = `❌ Thiếu mật khẩu phòng!\n\n💡 Cách dùng: /clear <mật khẩu phòng>`;
                                } else {
                                    botResponse = `❌ Thiếu tham số!\n\n💡 Cách dùng ở phòng chính: /clear <số> [mật khẩu] hoặc /clear main`;
                                }
                                shouldSendResponse = true;
                            } else {
                                try {
                                    let targetRoom = null;
                                    let enteredPassword = '';
                                    let isMainTarget = false;

                                    if (currentRoom) {
                                        targetRoom = currentRoom;
                                        enteredPassword = clearArgs;
                                    } else {
                                        const normalizedArgs = clearArgs.toLowerCase();
                                        if (normalizedArgs === 'main' || normalizedArgs === '0' || normalizedArgs === 'phongchinh') {
                                            isMainTarget = true;
                                            targetRoom = {
                                                id: null,
                                                name: 'phòng chính',
                                                password: null
                                            };
                                        } else {
                                            const clearMatch = clearArgs.match(/^(\d+)(?:\s+(.+))?$/);
                                            const roomNumber = clearMatch ? parseInt(clearMatch[1], 10) : NaN;
                                            enteredPassword = clearMatch && clearMatch[2] ? clearMatch[2].trim() : '';

                                            if (!roomNumber || isNaN(roomNumber)) {
                                                botResponse = `❌ Số thứ tự phòng không hợp lệ!\n\n💡 Ví dụ: /clear 1 matkhau`;
                                                shouldSendResponse = true;
                                            } else {
                                                const { data: rooms, error: roomsError } = await supabaseClient
                                                    .from('chat_rooms')
                                                    .select('*')
                                                    .order('created_at', { ascending: false });

                                                if (roomsError) throw roomsError;

                                                if (!rooms || rooms.length === 0) {
                                                    botResponse = `❌ Không có phòng chat nào!\n\n💡 Dùng /room để xem danh sách phòng.`;
                                                    shouldSendResponse = true;
                                                } else if (roomNumber < 1 || roomNumber > rooms.length) {
                                                    botResponse = `❌ Số thứ tự không hợp lệ!\n\n📋 Hiện có ${rooms.length} phòng.`;
                                                    shouldSendResponse = true;
                                                } else {
                                                    targetRoom = rooms[roomNumber - 1];
                                                }
                                            }
                                        }
                                    }

                                    if (!targetRoom) {
                                        // botResponse already set above
                                    } else if (isMainTarget && !isAdmin) {
                                        botResponse = `❌ Chỉ admin mới có thể xóa tin nhắn phòng chính.`;
                                        shouldSendResponse = true;
                                    } else if (targetRoom.password && !enteredPassword) {
                                        botResponse = currentRoom
                                            ? `❌ Thiếu mật khẩu phòng!\n\n💡 Cách dùng: /clear <mật khẩu phòng>`
                                            : `❌ Thiếu mật khẩu phòng!\n\n💡 Cách dùng: /clear <số> <mật khẩu>`;
                                        shouldSendResponse = true;
                                    } else if (targetRoom.password && targetRoom.password !== enteredPassword) {
                                        botResponse = `❌ Mật khẩu phòng không đúng!\n\n💡 Hãy kiểm tra lại và thử lại.`;
                                        shouldSendResponse = true;
                                    } else {
                                        let clearError = null;
                                        if (targetRoom.id === null) {
                                            const { error: deleteError } = await supabaseClient
                                                .from('messages')
                                                .delete()
                                                .is('room_id', null);
                                            clearError = deleteError;
                                        } else {
                                            const { error: deleteError } = await supabaseClient
                                                .from('messages')
                                                .delete()
                                                .eq('room_id', targetRoom.id);
                                            clearError = deleteError;
                                        }

                                        if (clearError) {
                                            const softDeletePayload = {
                                                deleted: true,
                                                delete_reason: `Room cleared by ${currentUser.username}`,
                                                deleted_by: currentUser.id,
                                                deleted_at: new Date().toISOString()
                                            };

                                            let softDeleteError = null;
                                            if (targetRoom.id === null) {
                                                const { error } = await supabaseClient
                                                    .from('messages')
                                                    .update(softDeletePayload)
                                                    .is('room_id', null);
                                                softDeleteError = error;
                                            } else {
                                                const { error } = await supabaseClient
                                                    .from('messages')
                                                    .update(softDeletePayload)
                                                    .eq('room_id', targetRoom.id);
                                                softDeleteError = error;
                                            }

                                            if (softDeleteError) {
                                                throw softDeleteError;
                                            }
                                        }

                                        if (presenceChannel) {
                                            await presenceChannel.send({
                                                type: 'broadcast',
                                                event: 'chat-cleared',
                                                payload: {
                                                    clearedBy: currentUser.username,
                                                    roomId: targetRoom.id,
                                                    roomName: targetRoom.name
                                                }
                                            });
                                        }

                                        botResponse = `✅ Đã xóa toàn bộ tin nhắn của phòng "${targetRoom.name}".`;
                                        shouldSendResponse = true;

                                        if (currentRoom && currentRoom.id === targetRoom.id) {
                                            setTimeout(() => {
                                                window.location.reload();
                                            }, 500);
                                        }
                                    }
                                } catch (error) {
                                    botResponse = `❌ Lỗi khi xóa tin nhắn phòng!\n\n${error.message || 'Vui lòng thử lại.'}`;
                                    shouldSendResponse = true;
                                }
                            }

                        } else if (command === '/botngu') {
                            botResponse = `Ngu bà nội mày, chém chết giờ!`
                        } else if (content.toLowerCase().startsWith('/createroom')) {
                            // /createroom command - tạo phòng chat nhanh
                            shouldSendResponse = false;
                            const parts = content.slice(11).trim().split(/\s+/);
                            const roomName = parts[0] || currentUser.username;
                            const roomPassword = parts[1] || null;

                            try {
                                // Check if room name already exists
                                const { data: existingRoom, error: checkError } = await supabaseClient
                                    .from('chat_rooms')
                                    .select('name')
                                    .eq('name', roomName)
                                    .single();

                                if (existingRoom) {
                                    botResponse = `❌ Tên phòng "${roomName}" đã tồn tại!\n\n💡 Vui lòng chọn tên khác.`;
                                    shouldSendResponse = true;
                                } else {
                                    // Create new room
                                    const { data: newRoom, error } = await supabaseClient
                                        .from('chat_rooms')
                                        .insert([{
                                            name: roomName,
                                            password: roomPassword,
                                            created_by: currentUser.username
                                        }])
                                        .select()
                                        .single();

                                    if (error) throw error;

                                    // Auto join the new room
                                    await joinRoom(newRoom.id, roomPassword);

                                    // Don't send bot response, joinRoom already shows notification
                                    shouldSendResponse = false;
                                }
                            } catch (error) {
                                botResponse = `❌ Lỗi khi tạo phòng!\n\n${error.message}`;
                                shouldSendResponse = true;
                            }
                        } else if (command === '/room') {
                            // /room command - hiển thị danh sách phòng
                            shouldSendResponse = false;

                            try {
                                const { data: rooms, error } = await supabaseClient
                                    .from('chat_rooms')
                                    .select('*')
                                    .order('created_at', { ascending: false });

                                if (error) throw error;

                                if (!rooms || rooms.length === 0) {
                                    botResponse = `📋 DANH SÁCH PHÒNG CHAT\n\n` +
                                        `Chưa có phòng chat nào.\n\n` +
                                        `💡 Dùng /createroom để tạo phòng mới!`;
                                } else {
                                    botResponse = `📋 DANH SÁCH PHÒNG CHAT (${rooms.length} phòng)\n\n`;
                                    rooms.forEach((room, index) => {
                                        const lockIcon = room.password ? '🔒' : '🔓';
                                        botResponse += `${index + 1}. ${lockIcon} ${room.name}\n`;
                                    });
                                    botResponse += `\n💡 Dùng /join <số> để vào phòng nhanh!`;
                                }
                                shouldSendResponse = true;
                            } catch (error) {
                                botResponse = `❌ Lỗi khi tải danh sách phòng!\n\n${error.message}`;
                                shouldSendResponse = true;
                            }
                        } else if (content.toLowerCase().startsWith('/join')) {
                            // /join command - vào phòng nhanh
                            shouldSendResponse = false;
                            const parts = content.slice(5).trim().split(/\s+/);
                            const roomNumber = parseInt(parts[0]);
                            const enteredPassword = parts[1] || null;

                            if (!roomNumber || isNaN(roomNumber)) {
                                botResponse = `❌ Vui lòng nhập số thứ tự phòng!\n\n💡 Ví dụ: /join 1 hoặc /join 1 matkhau`;
                                shouldSendResponse = true;
                            } else {
                                try {
                                    // Get all rooms
                                    const { data: rooms, error } = await supabaseClient
                                        .from('chat_rooms')
                                        .select('*')
                                        .order('created_at', { ascending: false });

                                    if (error) throw error;

                                    if (!rooms || rooms.length === 0) {
                                        botResponse = `❌ Không có phòng chat nào!\n\n💡 Dùng /createroom để tạo phòng mới!`;
                                        shouldSendResponse = true;
                                    } else if (roomNumber < 1 || roomNumber > rooms.length) {
                                        botResponse = `❌ Số thứ tự không hợp lệ!\n\n📋 Hiện có ${rooms.length} phòng. Dùng /room để xem danh sách.`;
                                        shouldSendResponse = true;
                                    } else {
                                        const selectedRoom = rooms[roomNumber - 1];

                                        // Check password
                                        if (selectedRoom.password && selectedRoom.password !== enteredPassword) {
                                            botResponse = `❌ Mật khẩu không đúng!\n\n🔒 Phòng "${selectedRoom.name}" có mật khẩu.\n💡 Dùng: /join ${roomNumber} <mật khẩu>`;
                                            shouldSendResponse = true;
                                        } else {
                                            // Join room
                                            await joinRoom(selectedRoom.id, selectedRoom.password);
                                            // Don't send bot response, joinRoom already shows notification
                                            shouldSendResponse = false;
                                        }
                                    }
                                } catch (error) {
                                    botResponse = `❌ Lỗi khi vào phòng!\n\n${error.message}`;
                                    shouldSendResponse = true;
                                }
                            }
                        } else if (command === '/exitroom') {
                            // /exitroom command - thoát khỏi phòng và quay về phòng chính (reload page)
                            shouldSendResponse = false;

                            if (!currentRoom) {
                                botResponse = `❌ Bạn đang ở phòng chính rồi!\n\n💡 Dùng /join để vào phòng chat khác.`;
                                shouldSendResponse = true;
                            } else {
                                // Just reload the page to exit room
                                setTimeout(() => {
                                    window.location.reload();
                                }, 500); // Small delay to let the command message send
                            }
                        } else {
                            // Unknown command
                            botResponse = `❌ Lệnh không tồn tại!\n\nNhập /help để xem các lệnh có sẵn.`;
                        }

                        // Send bot response
                        if (shouldSendResponse && botResponse) {
                            await supabaseClient
                                .from('messages')
                                .insert([{
                                    user_id: 'bot-system',
                                    username: '🤖 BOT',
                                    content: botResponse,
                                    reactions: {},
                                    room_id: currentRoom ? currentRoom.id : null
                                }]);
                        }
                    }, 500); // Delay 500ms để bot reply tự nhiên hơn
                }

                input.value = '';
                cancelReply(); // Clear reply state after sending
                selectedImage = null;
                document.getElementById('previewContainer').innerHTML = '';
                document.getElementById('previewContainer').classList.remove('active');
                document.getElementById('imageInput').value = '';
                document.getElementById('videoInput').value = '';
                document.getElementById('audioInput').value = '';
            } catch (error) {
                showError('Không thể gửi tin nhắn');
            } finally {
                // Re-enable button
                if (sendBtn) {
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = originalBtnContent;
                    sendBtn.style.opacity = '1';
                    sendBtn.style.cursor = 'pointer';
                }

                // Focus back to input
                input.focus();
            }
        }

        // Handle new message
        function handleNewMessage(payload) {

            const newMessage = payload.new;

            // Filter: only show message if it belongs to current room
            if (currentRoom) {
                // In a room: only show messages with matching room_id
                if (newMessage.room_id !== currentRoom.id) {
                    return;
                }
            } else {
                // In main chat: only show messages with null room_id
                if (newMessage.room_id !== null) {
                    return;
                }
            }

            const container = document.getElementById('messagesContainer');

            if (container.innerHTML.includes('Chưa có tin nhắn')) {
                container.innerHTML = '';
            }

            displayMessage(newMessage, { animateBotTypewriter: true });
            scrollToBottom();
        }

        // Handle message update
        function handleMessageUpdate(payload) {

            const updatedMessage = payload.new;

            // Filter: only update message if it belongs to current room
            if (currentRoom) {
                // In a room: only update messages with matching room_id
                if (updatedMessage.room_id !== currentRoom.id) {
                    return;
                }
            } else {
                // In main chat: only update messages with null room_id
                if (updatedMessage.room_id !== null) {
                    return;
                }
            }

            const messageElement = document.querySelector(`[data-message-id="${updatedMessage.id}"]`);
            if (messageElement) {
                if (updatedMessage.deleted) {
                    // Update deleted message
                    messageElement.classList.add('deleted');
                    const contentDiv = messageElement.querySelector('.message-content');
                    contentDiv.classList.add('deleted-content');
                    contentDiv.innerHTML = `
                        <em>Tin nhắn đã bị xóa bởi admin</em>
                        ${updatedMessage.delete_reason ? `<div class="delete-reason">Lý do: ${escapeHtml(updatedMessage.delete_reason)}</div>` : ''}
                    `;
                } else if (updatedMessage.edited) {
                    // CẬP NHẬT TIN NHẮN ĐÃ CHỈNH SỬA
                    updateMessageDisplayAfterEdit(updatedMessage.id, updatedMessage.content);
                    
                    // CẬP NHẬT CÁC TIN NHẮN TRẢ LỜI THAM CHIẾU ĐẾN TIN NHẮN NÀY
                    updateRepliedMessages(updatedMessage.id, updatedMessage.username, updatedMessage.content);
                } else {
                    updateMessageReactions(messageElement, updatedMessage.reactions);
                }
            }
        }

        // Display message
        function startBotTypewriter(messageDiv, fullText) {
            const target = messageDiv.querySelector('.bot-typing-target');
            if (!target) return;

            const text = typeof fullText === 'string' ? fullText : '';
            if (!text) {
                target.classList.remove('typing');
                return;
            }

            target.textContent = '';
            target.classList.add('typing');

            let index = 0;
            const typeNext = () => {
                if (index >= text.length) {
                    target.classList.remove('typing');
                    return;
                }

                const char = text.charAt(index);
                target.textContent += char;
                index += 1;

                const container = document.getElementById('messagesContainer');
                if (container) {
                    container.scrollTop = container.scrollHeight;
                }

                const delay = char === '\n' ? 70 : (char === ' ' ? 14 : 20);
                setTimeout(typeNext, delay);
            };

            typeNext();
        }

        function displayMessage(message, options = {}) {
            const animateBotTypewriter = !!options.animateBotTypewriter;
            const container = document.getElementById('messagesContainer');

            // Handle system kick notification messages (identified by special user_id)
            if (message.user_id === 'system-kick-notification') {
                const systemDiv = document.createElement('div');
                systemDiv.className = 'system-message kick-message';
                systemDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i> ${escapeHtml(message.content)}
                `;
                container.appendChild(systemDiv);
                return;
            }

            const messageDiv = document.createElement('div');
            const isBotMessage = message.user_id === 'bot-system';
            messageDiv.className = `message ${message.user_id === currentUser.id ? 'own' : ''} ${message.deleted ? 'deleted' : ''} ${isBotMessage ? 'bot-message' : ''}`;
            messageDiv.setAttribute('data-message-id', message.id);
            messageDiv.setAttribute('data-username', message.username || 'User');
            const parsedMessageContent = parseStoredMessageContent(message.content || '');
            const isPrivateMessage = parsedMessageContent.isPrivate;
            messageDiv.setAttribute('data-is-private', isPrivateMessage ? 'true' : 'false');

            // Thêm data-reply-to để tracking tin nhắn reply
            if (message.reply_to) {
                messageDiv.setAttribute('data-reply-to', message.reply_to);
            }

            const time = new Date(message.created_at).toLocaleTimeString('vi-VN', {
                timeZone: 'Asia/Ho_Chi_Minh',
                hour: '2-digit',
                minute: '2-digit'
            });

            let contentHtml;
            if (message.deleted) {
                contentHtml = `
                    <em>Tin nhắn đã bị xóa bởi admin</em>
                    ${message.delete_reason ? `<div class="delete-reason">Lý do: ${escapeHtml(message.delete_reason)}</div>` : ''}
                `;
            } else {
                contentHtml = parsedMessageContent.text || '';
            }

            // Add image/video/audio if exists
            let mediaHtml = '';
            if (message.image_url && !message.deleted) {
                const url = message.image_url;
                // Xác định loại media dựa vào extension
                const urlLower = url.toLowerCase();

                // Check for video
                if (urlLower.includes('.mp4') || urlLower.includes('.webm') ||
                    urlLower.includes('.mov') || urlLower.includes('.avi') ||
                    urlLower.includes('video')) {
                    mediaHtml = `<video src="${url}" controls class="message-video" preload="metadata" controlsList="nodownload"></video>`;
                }
                // Check for audio - bổ sung thêm nhiều định dạng
                else if (urlLower.includes('.mp3') || urlLower.includes('.wav') ||
                    urlLower.includes('.ogg') || urlLower.includes('.m4a') ||
                    urlLower.includes('.aac') || urlLower.includes('.flac') ||
                    urlLower.includes('audio')) {
                    mediaHtml = `<audio src="${url}" controls class="message-audio" preload="metadata" controlsList="nodownload"></audio>`;
                }
                // ========== THÊM XỬ LÝ CHO FILE DOCUMENTS ==========
                // Check for documents (pdf, docx, xlsx, zip, etc.)
                else if (urlLower.includes('.pdf') || urlLower.includes('.doc') ||
                    urlLower.includes('.xls') || urlLower.includes('.ppt') ||
                    urlLower.includes('.zip') || urlLower.includes('.rar') ||
                    urlLower.includes('.txt') || urlLower.includes('.csv') ||
                    urlLower.includes('.7z')) {
                    // Extract file name from URL
                    const fileName = url.split('/').pop().split('?')[0];
                    const ext = fileName.split('.').pop().toLowerCase();

                    // Get icon based on file type
                    let fileIcon = 'fa-file';
                    const iconMap = {
                        'pdf': 'fa-file-pdf',
                        'doc': 'fa-file-word', 'docx': 'fa-file-word',
                        'xls': 'fa-file-excel', 'xlsx': 'fa-file-excel',
                        'ppt': 'fa-file-powerpoint', 'pptx': 'fa-file-powerpoint',
                        'zip': 'fa-file-archive', 'rar': 'fa-file-archive', '7z': 'fa-file-archive',
                        'txt': 'fa-file-alt',
                        'csv': 'fa-file-csv'
                    };
                    if (iconMap[ext]) {
                        fileIcon = iconMap[ext];
                    }

                    mediaHtml = `
                        <div class="message-file" style="margin-top: 0.5rem;">
                            <a href="${url}" download="${fileName}" target="_blank" 
                               style="display: inline-flex; align-items: center; gap: 0.5rem; 
                                      background: transparent; border: 2px solid var(--accent); 
                                      color: var(--accent); padding: 0.75rem 1.25rem; 
                                      text-decoration: none; transition: all 0.3s; border-radius: 4px;"
                               onmouseover="this.style.background='var(--accent)'; this.style.color='#000000';"
                               onmouseout="this.style.background='transparent'; this.style.color='var(--accent)';">
                                <i class="fas ${fileIcon}" style="font-size: 1rem;"></i>
                                <span>${fileName}</span>
                                <i class="fas fa-download"></i>
                            </a>
                        </div>
                    `;
                }
                // ========== KẾT THÚC XỬ LÝ DOCUMENTS ==========
                // Default to image
                else {
                    mediaHtml = `<img src="${url}" alt="Image" class="message-image" onclick="openImageViewer('${url}')">`;
                }
            }

            const shouldAnimateBotTypewriter = animateBotTypewriter && isBotMessage && !message.deleted;
            const textHtml = message.deleted ? '' : (
                shouldAnimateBotTypewriter
                    ? `<div class="message-text bot-typing-target" style="white-space: pre-line; margin-bottom: ${mediaHtml ? '0.5rem' : '0'};"></div>`
                    : buildMessageTextHtml(contentHtml, isPrivateMessage, !!mediaHtml)
            );
            const replyPreviewContent = getReplyPreviewFromContent(message.reply_to_content || '');
            const editContent = parsedMessageContent.text || '';
            const senderName = message.username || 'User';
            const avatarUrl = getMessageAvatarUrl(message);
            const safeAvatarUrl = avatarUrl && isValidHttpUrl(avatarUrl) ? escapeHtml(avatarUrl) : '';
            const avatarInitial = getDisplayInitial(isBotMessage ? 'B' : senderName);
            const timeLabel = `${time}${message.edited ? '<span class="edited-label">(đã chỉnh sửa)</span>' : ''}`;
            const previousMessageEl = container.lastElementChild;
            const isConsecutiveFromSameSender = !!(
                previousMessageEl &&
                previousMessageEl.classList &&
                previousMessageEl.classList.contains('message') &&
                !previousMessageEl.classList.contains('own') &&
                message.user_id !== currentUser.id &&
                previousMessageEl.getAttribute('data-username') === senderName
            );
            const showAvatar = !isConsecutiveFromSameSender;

            messageDiv.innerHTML = `
                <div class="message-header ${showAvatar ? '' : 'hidden'}">
                    <div class="message-avatar ${safeAvatarUrl ? 'has-image' : ''}" data-username="${escapeHtml(senderName)}" title="${escapeHtml(senderName)}">
                        <img src="${safeAvatarUrl}" alt="Avatar">
                        <span class="message-avatar-fallback">${escapeHtml(avatarInitial)}</span>
                    </div>
                </div>
                ${message.reply_to ? `
                    <div class="replied-message">
                        <span class="replied-user">${escapeHtml(message.reply_to_username || 'User')}:</span>
                        <span class="replied-content">${escapeHtml(replyPreviewContent || '')}</span>
                    </div>
                ` : ''}
                <div class="message-content ${message.deleted ? 'deleted-content' : ''}">
                    ${message.deleted ? contentHtml : `
                        ${textHtml}
                        ${mediaHtml}
                    `}
                    ${!message.deleted && !isBotMessage ? `
                    <div class="reaction-picker" id="picker-${message.id}">
                        <span class="reaction-option" onclick="addReaction(${message.id}, '❤️')"><i class="fas fa-heart"></i></span>
                        <span class="reaction-option" onclick="addReaction(${message.id}, '👍')"><i class="fas fa-thumbs-up"></i></span>
                        <span class="reaction-option" onclick="addReaction(${message.id}, '😂')"><i class="fas fa-laugh"></i></span>
                        <span class="reaction-option" onclick="addReaction(${message.id}, '🔥')"><i class="fas fa-fire"></i></span>
                        <span class="reaction-option" onclick="addReaction(${message.id}, '✨')"><i class="fas fa-sparkles"></i></span>
                    </div>
                    ` : ''}
                </div>
                ${!message.deleted && !isBotMessage ? `
                    <textarea class="edit-input" id="edit-input-${message.id}">${escapeHtml(editContent)}</textarea>
                    <div class="edit-actions">
                        <button onclick="saveEdit(${message.id})"><i class="fas fa-check"></i> Lưu</button>
                        <button onclick="cancelEdit(${message.id})"><i class="fas fa-times"></i> Hủy</button>
                    </div>
                ` : ''}
                ${!isBotMessage ? `
                <div class="message-footer">
                    <div class="message-reactions" id="reactions-${message.id}"></div>
                    ${!message.deleted ? `
                    <div class="message-actions">
                        ${message.user_id !== currentUser.id ? `
                            <button class="reply-btn" onclick="replyToFromButton(${message.id})">
                                <i class="fas fa-reply"></i>
                            </button>
                        ` : ''}
                        ${message.user_id === currentUser.id || isAdmin ? `
                            <button class="edit-btn" onclick="editMessage(${message.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                        ` : ''}
                        <button class="react-btn" onclick="toggleReactionPicker(${message.id})"><i class="fas fa-heart"></i></button>
                        <button class="delete-msg-btn ${isAdmin && message.user_id !== currentUser.id ? 'visible' : ''}" onclick="showDeleteModal(${message.id})"><i class="fas fa-trash"></i></button>
                    </div>
                    ` : ''}
                    <span class="message-time message-time-inline">${timeLabel}</span>
                </div>
                ` : `
                <span class="message-time message-time-bottom">${timeLabel}</span>
                `}
            `;

            container.appendChild(messageDiv);

            if (message.reactions && !message.deleted && !isBotMessage) {
                updateMessageReactions(messageDiv, message.reactions);
            }

            if (shouldAnimateBotTypewriter) {
                startBotTypewriter(messageDiv, parsedMessageContent.text || '');
            }

            if (!isBotMessage && message.user_id !== currentUser.id) {
                fetchAvatarForUsername(senderName);
            }
        }

        // Show delete message modal
        function showDeleteModal(messageId) {
            currentDeleteMessageId = messageId;
            document.getElementById('deleteMessageModal').classList.add('active');
            document.getElementById('deleteReasonInput').value = '';
        }

        // Close delete modal
        function closeDeleteModal() {
            document.getElementById('deleteMessageModal').classList.remove('active');
            currentDeleteMessageId = null;
        }

        // Confirm delete message
        async function confirmDeleteMessage() {
            const reason = document.getElementById('deleteReasonInput').value.trim();

            if (!reason) {
                showError('Vui lòng nhập lý do xóa tin nhắn');
                return;
            }

            if (!currentDeleteMessageId) return;

            try {
                const { error } = await supabaseClient
                    .from('messages')
                    .update({
                        deleted: true,
                        delete_reason: reason,
                        deleted_by: currentUser.id,
                        deleted_at: new Date().toISOString()
                    })
                    .eq('id', currentDeleteMessageId);

                if (error) throw error;

                closeDeleteModal();
                showError('Đã xóa tin nhắn', false);
            } catch (error) {
                showError('Không thể xóa tin nhắn');
            }
        }

        // Show kick user modal
        function showKickModal() {
            if (!isAdmin) return;
            closeChatActionsMenu();
            document.getElementById('kickUserModal').classList.add('active');
            document.getElementById('kickReasonInput').value = '';
        }

        // Close kick modal
        function closeKickModal() {
            document.getElementById('kickUserModal').classList.remove('active');
        }

        // Update kick user list
        function updateKickUserList(presenceState) {
            const select = document.getElementById('kickUserSelect');
            select.innerHTML = '<option value="">-- Chọn người dùng --</option>';

            Object.values(presenceState).forEach(presences => {
                presences.forEach(presence => {
                    if (presence.username && presence.user_id !== currentUser.id) {
                        const option = document.createElement('option');
                        option.value = presence.user_id;
                        option.textContent = presence.username;
                        select.appendChild(option);
                    }
                });
            });
        }

        // Confirm kick user
        async function confirmKickUser() {
            const userId = document.getElementById('kickUserSelect').value;
            const reason = document.getElementById('kickReasonInput').value.trim();

            if (!userId) {
                showError('Vui lòng chọn người dùng');
                return;
            }

            if (!reason) {
                showError('Vui lòng nhập lý do kick');
                return;
            }

            try {
                // Get username of kicked user
                const select = document.getElementById('kickUserSelect');
                const kickedUsername = select.options[select.selectedIndex].text;

                // Record kick in database with active = true
                const { error: kickError } = await supabaseClient
                    .from('kicks')
                    .insert([{
                        user_id: userId,
                        kicked_by: currentUser.id,
                        reason: reason,
                        active: true
                    }]);

                if (kickError) throw kickError;

                // Send kick notification message to chat
                const { error: msgError } = await supabaseClient
                    .from('messages')
                    .insert([{
                        username: 'SYSTEM',
                        content: `⚠️ ${kickedUsername} đã bị kick bởi ${currentUser.username}. Lý do: ${reason}`,
                        user_id: 'system-kick-notification',
                        room_id: currentRoom ? currentRoom.id : null
                    }]);


                // Send broadcast to kick user
                if (presenceChannel) {
                    await presenceChannel.send({
                        type: 'broadcast',
                        event: 'user-kicked',
                        payload: {
                            userId: userId,
                            reason: reason,
                            kickedBy: currentUser.username
                        }
                    });
                }

                closeKickModal();
                showError('✅ Đã kick người dùng! Họ sẽ bị văng khỏi chat ngay lập tức.', false);
            } catch (error) {
                showError('Không thể kick người dùng');
            }
        }

        // Show unban user modal
        async function showUnbanModal() {
            if (!isAdmin) return;
            closeChatActionsMenu();
            document.getElementById('unbanUserModal').classList.add('active');
            await loadBannedUsers();
        }

        // Close unban modal
        function closeUnbanModal() {
            document.getElementById('unbanUserModal').classList.remove('active');
        }

        // Load banned users
        async function loadBannedUsers() {
            try {
                const { data: kicks, error } = await supabaseClient
                    .from('kicks')
                    .select('*')
                    .eq('active', true)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const container = document.getElementById('bannedUsersList');

                if (!kicks || kicks.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; color: var(--text-dim); padding: 1rem;">
                            Không có người dùng nào bị kick
                        </div>
                    `;
                    return;
                }

                container.innerHTML = '';

                // Fetch user details for each kick
                for (const kick of kicks) {
                    try {
                        const { data: user } = await supabaseClient
                            .from('users')
                            .select('username')
                            .eq('id', kick.user_id)
                            .single();

                        const item = document.createElement('div');
                        item.className = 'user-list-item';
                        item.innerHTML = `
                            <div class="user-list-info">
                                <div class="user-list-name">${escapeHtml(user?.username || 'Unknown User')}</div>
                                <div class="user-list-reason">Lý do: ${escapeHtml(kick.reason)}</div>
                            </div>
                            <div>
                            <button class="unban-btn" onclick="unbanUser('${kick.id}', '${kick.user_id}')">
                                Unban
                            </button>
                            </div>
                        `;
                        container.appendChild(item);
                    } catch (userError) {
                    }
                }
            } catch (error) {
                const container = document.getElementById('bannedUsersList');
                container.innerHTML = `
                    <div style="text-align: center; color: var(--text-dim); padding: 1rem;">
                        Không thể tải danh sách. Vui lòng thử lại.
                    </div>
                `;
            }
        }

        // Unban user - Global function
        window.unbanUser = async function (kickId, userId) {
            try {

                // First, check if the record exists
                const { data: existingKick, error: fetchError } = await supabaseClient
                    .from('kicks')
                    .select('*')
                    .eq('id', kickId)
                    .single();


                if (fetchError || !existingKick) {
                    showError('Không tìm thấy bản ghi kick này. Có thể đã được unban rồi.');
                    await loadBannedUsers();
                    return;
                }

                // Try to update active = false
                const { data: updateData, error: updateError } = await supabaseClient
                    .from('kicks')
                    .update({ active: false })
                    .eq('id', kickId)
                    .select();


                if (updateError) {
                    throw updateError;
                }

                if (updateData && updateData.length > 0) {
                    showError('Đã unban người dùng thành công! Người dùng có thể đăng nhập lại.', false);
                    await loadBannedUsers();
                    return;
                }

                // If update returns empty array (RLS policy issue), try delete

                const { data: deleteData, error: deleteError } = await supabaseClient
                    .from('kicks')
                    .delete()
                    .eq('id', kickId)
                    .select();


                if (deleteError) {
                    throw deleteError;
                }

                if (deleteData && deleteData.length > 0) {
                    showError('Đã unban người dùng thành công! Người dùng có thể đăng nhập lại.', false);
                    await loadBannedUsers();
                    return;
                }

                // If both failed, it's likely an RLS policy issue
                showError('Không thể unban: Vui lòng kiểm tra RLS policies trong Supabase cho bảng kicks (cần cho phép UPDATE hoặc DELETE)');

            } catch (error) {
                showError('Lỗi khi unban: ' + error.message);
            }
        }

        // Toggle reaction picker
        function toggleReactionPicker(messageId) {
            const picker = document.getElementById(`picker-${messageId}`);
            const allPickers = document.querySelectorAll('.reaction-picker');

            allPickers.forEach(p => {
                if (p.id !== `picker-${messageId}`) {
                    p.classList.remove('active');
                }
            });

            picker.classList.toggle('active');
        }

        // Add reaction
        async function addReaction(messageId, emoji) {
            try {
                const { data: message, error: fetchError } = await supabaseClient
                    .from('messages')
                    .select('reactions')
                    .eq('id', messageId)
                    .single();

                if (fetchError) throw fetchError;

                const reactions = message.reactions || {};

                if (!reactions[emoji]) {
                    reactions[emoji] = [];
                }

                const userIndex = reactions[emoji].indexOf(currentUser.id);
                if (userIndex > -1) {
                    reactions[emoji].splice(userIndex, 1);
                    if (reactions[emoji].length === 0) {
                        delete reactions[emoji];
                    }
                } else {
                    reactions[emoji].push(currentUser.id);
                }

                const { error: updateError } = await supabaseClient
                    .from('messages')
                    .update({ reactions })
                    .eq('id', messageId);

                if (updateError) throw updateError;

                document.getElementById(`picker-${messageId}`).classList.remove('active');
            } catch (error) {
                showError('Không thể thêm reaction');
            }
        }

        // Update message reactions
        function emojiToIcon(emoji) {
            const emojiMap = {
                '❤️': '<i class="fas fa-heart"></i>',
                '👍': '<i class="fas fa-thumbs-up"></i>',
                '😂': '<i class="fas fa-laugh"></i>',
                '🔥': '<i class="fas fa-fire"></i>',
                '✨': '<i class="fas fa-sparkles"></i>'
            };
            return emojiMap[emoji] || emoji;
        }

        function updateMessageReactions(messageElement, reactions) {
            const reactionsContainer = messageElement.querySelector('.message-reactions');
            reactionsContainer.innerHTML = '';

            if (!reactions) return;

            Object.entries(reactions).forEach(([emoji, userIds]) => {
                if (userIds.length > 0) {
                    const reactionDiv = document.createElement('div');
                    reactionDiv.className = `reaction ${userIds.includes(currentUser.id) ? 'active' : ''}`;
                    reactionDiv.innerHTML = `${emojiToIcon(emoji)} <span>${userIds.length}</span>`;
                    reactionDiv.onclick = () => {
                        const messageId = messageElement.getAttribute('data-message-id');
                        addReaction(parseInt(messageId), emoji);
                    };
                    reactionsContainer.appendChild(reactionDiv);
                }
            });
        }

        // Update online users
        function updateOnlineUsers(state) {
            const container = document.getElementById('onlineUsersList');
            container.innerHTML = '';

            Object.values(state).forEach(presences => {
                presences.forEach(presence => {
                    if (presence.username) {
                        const userDiv = document.createElement('div');
                        userDiv.className = 'online-user-item';

                        const roomName = presence.room_name || 'Chính';
                        const avatarUrl = (presence.avatar_url || '').toString().trim();
                        const avatarInitial = getDisplayInitial(presence.username);
                        const avatarNode = avatarUrl && isValidHttpUrl(avatarUrl)
                            ? `<img class="online-user-avatar" src="${escapeHtml(avatarUrl)}" alt="avatar">`
                            : `<span class="online-user-avatar-fallback">${escapeHtml(avatarInitial)}</span>`;

                        userDiv.innerHTML = `
                            <div class="online-user-indicator"></div>
                            ${avatarNode}
                            <span class="online-user-name">${escapeHtml(presence.username)}</span>
                            <span class="online-user-room">(${escapeHtml(roomName)})</span>
                        `;
                        container.appendChild(userDiv);
                    }
                });
            });
        }

        // Image Viewer Functions
        function openImageViewer(imageUrl) {
            currentImageUrl = imageUrl;
            currentZoom = 1;
            currentRotation = 0;
            translateX = 0;
            translateY = 0;

            const modal = document.getElementById('imageViewerModal');
            const img = document.getElementById('viewerImage');

            img.src = imageUrl;
            modal.classList.add('active');

            updateImageTransform();
            updateZoomLevel();

            // Add drag functionality
            setupDragListeners();
        }

        function closeImageViewer() {
            const modal = document.getElementById('imageViewerModal');
            modal.classList.remove('active');
            removeDragListeners();
        }

        function zoomIn() {
            currentZoom = Math.min(currentZoom + 0.25, 5);
            updateImageTransform();
            updateZoomLevel();
        }

        function zoomOut() {
            currentZoom = Math.max(currentZoom - 0.25, 0.25);
            updateImageTransform();
            updateZoomLevel();
        }

        function rotateLeft() {
            currentRotation -= 90;
            updateImageTransform();
        }

        function rotateRight() {
            currentRotation += 90;
            updateImageTransform();
        }

        function resetImage() {
            currentZoom = 1;
            currentRotation = 0;
            translateX = 0;
            translateY = 0;
            updateImageTransform();
            updateZoomLevel();
        }

        function updateImageTransform() {
            const img = document.getElementById('viewerImage');
            img.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentZoom}) rotate(${currentRotation}deg)`;
        }

        function updateZoomLevel() {
            document.getElementById('zoomLevel').textContent = Math.round(currentZoom * 100) + '%';
        }

        function downloadImage() {
            const link = document.createElement('a');
            link.href = currentImageUrl;
            link.download = 'image_' + Date.now() + '.jpg';
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Drag functionality
        function setupDragListeners() {
            const img = document.getElementById('viewerImage');

            img.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', endDrag);

            // Touch support
            img.addEventListener('touchstart', startDragTouch);
            document.addEventListener('touchmove', dragTouch);
            document.addEventListener('touchend', endDrag);
        }

        function removeDragListeners() {
            const img = document.getElementById('viewerImage');

            img.removeEventListener('mousedown', startDrag);
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', endDrag);

            img.removeEventListener('touchstart', startDragTouch);
            document.removeEventListener('touchmove', dragTouch);
            document.removeEventListener('touchend', endDrag);
        }

        function startDrag(e) {
            if (currentZoom <= 1) return;
            isDragging = true;
            startX = e.clientX - translateX;
            startY = e.clientY - translateY;
            e.preventDefault();
        }

        function startDragTouch(e) {
            if (currentZoom <= 1) return;
            isDragging = true;
            const touch = e.touches[0];
            startX = touch.clientX - translateX;
            startY = touch.clientY - translateY;
            e.preventDefault();
        }

        function drag(e) {
            if (!isDragging) return;
            translateX = e.clientX - startX;
            translateY = e.clientY - startY;
            updateImageTransform();
        }

        function dragTouch(e) {
            if (!isDragging) return;
            const touch = e.touches[0];
            translateX = touch.clientX - startX;
            translateY = touch.clientY - startY;
            updateImageTransform();
        }

        function endDrag() {
            isDragging = false;
        }

        // Close viewer on ESC key
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closeImageViewer();
            }
        });

        // Mouse wheel zoom
        document.getElementById('imageViewerModal').addEventListener('wheel', function (e) {
            if (!document.getElementById('imageViewerModal').classList.contains('active')) return;

            e.preventDefault();
            if (e.deltaY < 0) {
                zoomIn();
            } else {
                zoomOut();
            }
        });

        // Toggle media menu
        function toggleMediaMenu() {
            const menu = document.getElementById('mediaMenu');
            menu.classList.toggle('active');

            // Close menu when clicking outside
            if (menu.classList.contains('active')) {
                setTimeout(() => {
                    document.addEventListener('click', closeMediaMenuOnClickOutside);
                }, 0);
            }
        }

        function closeMediaMenuOnClickOutside(event) {
            const menu = document.getElementById('mediaMenu');
            const button = event.target.closest('.media-button');
            const menuItem = event.target.closest('.media-menu-item');

            if (!button && !menuItem) {
                menu.classList.remove('active');
                document.removeEventListener('click', closeMediaMenuOnClickOutside);
            }
        }

        function selectMediaType(type) {
            const menu = document.getElementById('mediaMenu');
            menu.classList.remove('active');
            document.removeEventListener('click', closeMediaMenuOnClickOutside);

            switch (type) {
                case 'image':
                    document.getElementById('imageInput').click();
                    break;
                case 'video':
                    document.getElementById('videoInput').click();
                    break;
                case 'audio':
                    document.getElementById('audioInput').click();
                    break;
                // THÊM CASE DOCUMENT
                case 'document':
                    document.getElementById('documentInput').click();
                    break;
            }
        }

        // Handle video selection
        function handleVideoSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Check if file is a video
            if (!file.type.startsWith('video/')) {
                showError('Vui lòng chọn file video');
                return;
            }

            // Check file size (max 50MB)
            if (file.size > 50 * 1024 * 1024) {
                showError('Video quá lớn. Vui lòng chọn video nhỏ hơn 50MB');
                return;
            }

            selectedImage = file; // Reuse selectedImage variable for media files

            // Show preview
            const previewContainer = document.getElementById('previewContainer');
            previewContainer.innerHTML = `
                <div class="image-preview">
                    <div style="padding: 1rem; border: 2px solid var(--accent); border-radius: 4px; background: var(--bg-secondary);">
                        <i class="fas fa-video" style="font-size: 2rem; color: var(--accent);"></i>
                        <p style="margin-top: 0.5rem; font-size: 0.85rem;">${file.name}</p>
                        <p style="font-size: 0.75rem; color: var(--text-dim);">${(file.size / (1024 * 1024)).toFixed(2)} MB</p>
                    </div>
                    <button class="remove-image" onclick="removeImage()">×</button>
                </div>
                <div style='
                    color: rgba(255, 255, 255, 0.6);
                    font-family: sans-serif;
                    font-style: italic;
                '>Web cần thời gian để tải Video lên! Video hiện ngay lập tức sau khi tải lên nên vui lòng không spam!</div>
            `;
            previewContainer.classList.add('active');
        }

        // Handle audio selection
        function handleAudioSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Check if file is audio
            if (!file.type.startsWith('audio/')) {
                showError('Vui lòng chọn file audio');
                return;
            }

            // Check file size (max 20MB)
            if (file.size > 20 * 1024 * 1024) {
                showError('Audio quá lớn. Vui lòng chọn audio nhỏ hơn 20MB');
                return;
            }

            selectedImage = file; // Reuse selectedImage variable for media files

            // Show preview
            const previewContainer = document.getElementById('previewContainer');
            previewContainer.innerHTML = `
                <div class="image-preview">
                    <div style="padding: 1rem; border: 2px solid var(--accent); border-radius: 4px; background: var(--bg-secondary);">
                        <i class="fas fa-microphone" style="font-size: 2rem; color: var(--accent);"></i>
                        <p style="margin-top: 0.5rem; font-size: 0.85rem;">${file.name}</p>
                        <p style="font-size: 0.75rem; color: var(--text-dim);">${(file.size / (1024 * 1024)).toFixed(2)} MB</p>
                    </div>
                    <button class="remove-image" onclick="removeImage()">×</button>
                </div>
                <div style='
                    color: rgba(255, 255, 255, 0.6);
                    font-family: sans-serif;
                    font-style: italic;
                '>Web cần thời gian để tải Audio lên! Audio hiện ngay lập tức sau khi tải lên nên vui lòng không spam!</div>
            `;
            previewContainer.classList.add('active');
        }

        // ========== THÊM HÀM XỬ LÝ FILE DOCUMENTS ==========
        // Handle document selection (pdf, docx, xlsx, zip, etc.)
        function handleDocumentSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Check file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                showError('File quá lớn. Vui lòng chọn file nhỏ hơn 10MB');
                return;
            }

            selectedImage = file; // Reuse selectedImage variable for all file types

            // Get file icon based on extension
            const fileName = file.name;
            const ext = fileName.split('.').pop().toLowerCase();
            let fileIcon = 'fa-file';

            const iconMap = {
                'pdf': 'fa-file-pdf',
                'doc': 'fa-file-word', 'docx': 'fa-file-word',
                'xls': 'fa-file-excel', 'xlsx': 'fa-file-excel',
                'ppt': 'fa-file-powerpoint', 'pptx': 'fa-file-powerpoint',
                'zip': 'fa-file-archive', 'rar': 'fa-file-archive', '7z': 'fa-file-archive',
                'txt': 'fa-file-alt',
                'csv': 'fa-file-csv'
            };

            if (iconMap[ext]) {
                fileIcon = iconMap[ext];
            }

            // Show preview
            const previewContainer = document.getElementById('previewContainer');
            previewContainer.innerHTML = `
                <div class="image-preview">
                    <div style="padding: 1rem; border: 2px solid var(--accent); border-radius: 4px; background: var(--bg-secondary); text-align: center;">
                        <i class="fas ${fileIcon}" style="font-size: 2rem; color: var(--accent);"></i>
                        <p style="margin-top: 0.5rem; font-size: 0.85rem;">${file.name}</p>
                        <p style="font-size: 0.75rem; color: var(--text-dim);">${(file.size / (1024 * 1024)).toFixed(2)} MB</p>
                    </div>
                    <button class="remove-image" onclick="removeImage()">×</button>
                </div>
                <div style='
                    color: rgba(255, 255, 255, 0.6);
                    font-family: sans-serif;
                    font-style: italic;
                '>Web cần thời gian để tải File lên! File hiện ngay lập tức sau khi tải lên nên vui lòng không spam!</div>
            `;
            previewContainer.classList.add('active');
        }
        // ========== KẾT THÚC HÀM XỬ LÝ DOCUMENTS ==========

        // Handle image selection
        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Check if file is an image
            if (!file.type.startsWith('image/')) {
                showError('Vui lòng chọn file ảnh');
                return;
            }

            // Check file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showError('Ảnh quá lớn. Vui lòng chọn ảnh nhỏ hơn 5MB');
                return;
            }

            selectedImage = file;

            // Show preview
            const reader = new FileReader();
            reader.onload = function (e) {
                const previewContainer = document.getElementById('previewContainer');
                previewContainer.innerHTML = `
                    <div class="image-preview">
                        <img src="${e.target.result}" alt="Preview">
                        <button class="remove-image" onclick="removeImage()">×</button>
                    </div>
                    <div style='
                        color: rgba(255, 255, 255, 0.6);
                    font-family: sans-serif;
                    font-style: italic;
                    '>Web cần thời gian để tải Ảnh lên! Ảnh hiện ngay lập tức sau khi tải lên nên vui lòng không spam!</div>
                `;
                previewContainer.classList.add('active');
            };
            reader.readAsDataURL(file);
        }

        // Remove selected image
        function removeImage() {
            selectedImage = null;
            document.getElementById('previewContainer').innerHTML = '';
            document.getElementById('previewContainer').classList.remove('active');
            document.getElementById('imageInput').value = '';
            document.getElementById('videoInput').value = '';
            document.getElementById('audioInput').value = '';
        }

        // Handle key press
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Logout
        // Show kick popup with countdown
        function showKickPopup(reason, kickedBy) {
            // Ẩn màn hình chat
            const chatScreen = document.getElementById('chatScreen');
            if (chatScreen) {
                chatScreen.style.display = 'none';
            }

            // Hiện overlay để che toàn bộ nội dung
            const overlay = document.getElementById('kickOverlay');
            if (overlay) {
                overlay.classList.add('active');
            }

            // Create popup element
            const popup = document.createElement('div');
            popup.className = 'kick-popup';
            popup.innerHTML = `
                <h2><i class="fas fa-exclamation-triangle"></i> BẠN ĐÃ BỊ KICK!</h2>
                <div class="kick-info">
                    <strong>Bị kick bởi:</strong> ${escapeHtml(kickedBy)}
                </div>
                <div class="kick-reason">
                    <strong>Lý do:</strong><br>
                    ${escapeHtml(reason)}
                </div>
                <div class="kick-action" style="margin-top: 2rem; text-align: center;">
                    <p style="color: var(--warning); margin-bottom: 1rem;">
                        <i class="fas fa-info-circle"></i> Bạn cần đăng xuất để tiếp tục sử dụng
                    </p>
                    <button onclick="handleLogout()" style="width: auto; padding: 1rem 2rem; margin: 0 auto; display: inline-block; background: var(--danger); border-color: var(--danger);">
                        <span><i class="fas fa-sign-out-alt"></i> Đăng xuất ngay</span>
                    </button>
                </div>
            `;

            document.body.appendChild(popup);
        }

        async function handleLogout() {
            if (presenceChannel) {
                await presenceChannel.untrack();
                await presenceChannel.unsubscribe();
            }
            if (messagesSubscription) {
                await messagesSubscription.unsubscribe();
            }
            if (kicksSubscription) {
                await kicksSubscription.unsubscribe();
            }

            try {
                await authSupabaseClient.auth.signOut();
            } catch (error) {
                const keys = Object.keys(localStorage);
                keys.forEach(key => {
                    if (key.includes('supabase') || key.includes('sb-')) {
                        localStorage.removeItem(key);
                    }
                });
                sessionStorage.clear();
            }

            location.reload();
        }

        // Utility functions
        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        const PRIVATE_MESSAGE_PREFIX = '__chatv2_private__:';

        function parsePrivateCommand(content) {
            const trimmed = (content || '').trim();
            const lower = trimmed.toLowerCase();

            if (lower === '/p' || lower === '/private') {
                return {
                    isPrivateCommand: true,
                    hasMessage: false,
                    privateText: ''
                };
            }

            if (lower.startsWith('/p ')) {
                const privateText = trimmed.slice(3).trim();
                return {
                    isPrivateCommand: true,
                    hasMessage: privateText.length > 0,
                    privateText
                };
            }

            if (lower.startsWith('/private ')) {
                const privateText = trimmed.slice(9).trim();
                return {
                    isPrivateCommand: true,
                    hasMessage: privateText.length > 0,
                    privateText
                };
            }

            return {
                isPrivateCommand: false,
                hasMessage: false,
                privateText: ''
            };
        }

        function toBase64Utf8(text) {
            return btoa(unescape(encodeURIComponent(text)));
        }

        function fromBase64Utf8(base64Text) {
            return decodeURIComponent(escape(atob(base64Text)));
        }

        function encodePrivateContent(plainText) {
            try {
                return `${PRIVATE_MESSAGE_PREFIX}${toBase64Utf8(plainText || '')}`;
            } catch (error) {
                return `${PRIVATE_MESSAGE_PREFIX}${btoa(plainText || '')}`;
            }
        }

        function parseStoredMessageContent(rawContent) {
            const content = typeof rawContent === 'string' ? rawContent : '';

            if (!content.startsWith(PRIVATE_MESSAGE_PREFIX)) {
                return {
                    isPrivate: false,
                    text: content
                };
            }

            const encodedContent = content.slice(PRIVATE_MESSAGE_PREFIX.length);

            try {
                return {
                    isPrivate: true,
                    text: fromBase64Utf8(encodedContent)
                };
            } catch (error) {
                try {
                    return {
                        isPrivate: true,
                        text: atob(encodedContent)
                    };
                } catch (decodeError) {
                    return {
                        isPrivate: true,
                        text: '[Tin nhắn bí mật bị lỗi]'
                    };
                }
            }
        }

        function getReplyPreviewFromContent(rawContent) {
            const parsed = parseStoredMessageContent(rawContent || '');
            return parsed.isPrivate ? '[Tin nhắn bí mật]' : parsed.text;
        }

        function buildMessageTextHtml(text, isPrivate, hasMedia = false) {
            if (!text && !isPrivate) return '';

            const marginBottom = hasMedia ? '0.5rem' : '0';

            if (isPrivate) {
                return `
                    <button type="button"
                        class="message-text private-message-toggle"
                        style="white-space: pre-line; margin-bottom: ${marginBottom};"
                        data-private-content="${escapeHtml(text || '')}"
                        data-revealed="false"
                        title="Tin nhắn bí mật - nhấn để xem"
                        aria-label="Tin nhắn bí mật - nhấn để xem"
                        onclick="togglePrivateMessage(this)">
                        🔒
                    </button>
                `;
            }

            return `<div class="message-text" style="white-space: pre-line; margin-bottom: ${marginBottom};">${escapeHtml(text || '')}</div>`;
        }

        function togglePrivateMessage(button) {
            if (!button) return;

            const isRevealed = button.getAttribute('data-revealed') === 'true';
            if (isRevealed) {
                button.textContent = '🔒';
                button.setAttribute('data-revealed', 'false');
                button.classList.remove('revealed');
            } else {
                button.textContent = button.getAttribute('data-private-content') || '';
                button.setAttribute('data-revealed', 'true');
                button.classList.add('revealed');
            }
        }

        function showError(message, isError = true) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.background = isError ? 'var(--danger)' : 'var(--accent)';
            errorDiv.classList.add('active');

            setTimeout(() => {
                errorDiv.classList.remove('active');
            }, 4000);
        }

        // Show system notification
        function showSystemNotification(message, type = 'join') {
            const container = document.getElementById('messagesContainer');
            const notification = document.createElement('div');
            notification.className = `system-notification ${type}`;
            notification.textContent = message;
            container.appendChild(notification);
            scrollToBottom();
        }

        // ========== ROOM CHAT FUNCTIONALITY ==========
        let currentRoom = null;
        let roomsSubscription = null;

        // Show room modal
        function showRoomModal() {
            closeChatActionsMenu();
            document.getElementById('roomModal').classList.add('active');
            loadRooms();
        }

        // Load rooms list
        async function loadRooms() {
            try {
                const { data: rooms, error } = await supabaseClient
                    .from('chat_rooms')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const roomsList = document.getElementById('roomsList');
                if (!rooms || rooms.length === 0) {
                    roomsList.innerHTML = '<p style="color: var(--text-dim); padding: 1rem; text-align: center;">Chưa có phòng nào. Hãy tạo phòng đầu tiên!</p>';
                    return;
                }

                roomsList.innerHTML = rooms.map(room => {
                    // Check if current user can delete this room
                    const canDelete = isAdmin || room.created_by === currentUser.username;

                    return `
                        <div class="room-item ${room.password ? 'room-locked' : ''}" style="display: flex; align-items: center; gap: 1rem;">
                            <div onclick="selectRoom('${room.id}', ${room.password ? 'true' : 'false'})" style="flex: 1; cursor: pointer;">
                                <div>
                                    <strong>${escapeHtml(room.name)}</strong>
                                    <div style="font-size: 0.85rem; color: var(--text-dim);">Tạo bởi: ${escapeHtml(room.created_by)}</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                ${room.password ? '<span><i class="fas fa-lock"></i></span>' : ''}
                                ${canDelete ? `
                                    <button 
                                        onclick="event.stopPropagation(); confirmDeleteRoom('${room.id}', '${escapeHtml(room.name).replace(/'/g, "\\'")}');" 
                                        style="
                                            padding: 0.3rem 0.6rem;
                                            background: var(--danger);
                                            border: 1px solid var(--danger);
                                            color: white;
                                            cursor: pointer;
                                            font-size: 0.8rem;
                                            font-family: 'Space Mono', monospace;
                                            transition: all 0.3s;
                                            border-radius: 10px;
                                        "
                                        onmouseover="this.style.opacity='0.8'"
                                        onmouseout="this.style.opacity='1'"
                                    >
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                showError('Lỗi khi tải danh sách phòng');
            }
        }

        // Create new room
        async function createRoom() {
            const roomName = document.getElementById('newRoomName').value.trim();
            const roomPassword = document.getElementById('newRoomPassword').value.trim();

            if (!roomName) {
                showError('Vui lòng nhập tên phòng');
                return;
            }

            try {
                // Check if room name already exists
                const { data: existingRoom, error: checkError } = await supabaseClient
                    .from('chat_rooms')
                    .select('name')
                    .eq('name', roomName)
                    .single();

                if (existingRoom) {
                    showError('Tên phòng đã tồn tại! Vui lòng chọn tên khác.');
                    return;
                }

                // Create new room
                const { data: newRoom, error } = await supabaseClient
                    .from('chat_rooms')
                    .insert([{
                        name: roomName,
                        password: roomPassword || null,
                        created_by: currentUser.username
                    }])
                    .select()
                    .single();

                if (error) throw error;

                showError('Tạo phòng thành công!', false);
                document.getElementById('newRoomName').value = '';
                document.getElementById('newRoomPassword').value = '';

                // Auto join the new room
                joinRoom(newRoom.id, roomPassword);
            } catch (error) {
                showError('Lỗi khi tạo phòng');
            }
        }

        // Select room (check password if needed)
        async function selectRoom(roomId, hasPassword) {
            try {
                const { data: room, error } = await supabaseClient
                    .from('chat_rooms')
                    .select('*')
                    .eq('id', roomId)
                    .single();

                if (error) throw error;

                if (hasPassword) {
                    const enteredPassword = prompt('Nhập mật khẩu phòng:');
                    if (!enteredPassword) return;

                    if (enteredPassword !== room.password) {
                        showError('Mật khẩu không đúng!');
                        return;
                    }
                }

                joinRoom(roomId, room.password);
            } catch (error) {
                showError('Lỗi khi vào phòng');
            }
        }

        // Join room
        async function joinRoom(roomId, password) {
            try {
                // Get room info
                const { data: room, error } = await supabaseClient
                    .from('chat_rooms')
                    .select('*')
                    .eq('id', roomId)
                    .single();

                if (error) throw error;

                // Unsubscribe from old messages subscription
                if (messagesSubscription) {
                    messagesSubscription.unsubscribe();
                    // Small delay to ensure cleanup
                    await new Promise(resolve => setTimeout(resolve, 200));
                }

                currentRoom = room;
                currentRoomId = room.id;
                currentRoomName = room.name;

                // Update presence với room mới
                if (presenceChannel) {
                    await updatePresenceTracking();
                }

                // Update chat header with room name
                document.querySelector('.chat-header h2').innerHTML = `<i class="fas fa-circle" style="color: var(--accent);"></i> ${room.name}`;

                // Close modal
                document.getElementById('roomModal').classList.remove('active');

                // Reload messages for this room
                document.getElementById('messagesContainer').innerHTML = '';
                await loadMessages();

                // Subscribe to messages for this room
                subscribeToMessagesForRoom();

                // Small delay to ensure subscription is ready
                await new Promise(resolve => setTimeout(resolve, 200));

                showError(`Đã vào phòng: ${room.name}`, false);
                scrollToBottom();
            } catch (error) {
                showError('Lỗi khi vào phòng');
            }
        }

        // Confirm delete room
        function confirmDeleteRoom(roomId, roomName) {
            if (confirm(`Bạn có chắc muốn xóa phòng "${roomName}"?\n\nTất cả tin nhắn trong phòng cũng sẽ bị xóa!`)) {
                deleteRoom(roomId);
            }
        }

        // Delete room
        async function deleteRoom(roomId) {
            try {
                const { error } = await supabaseClient
                    .from('chat_rooms')
                    .delete()
                    .eq('id', roomId);

                if (error) throw error;

                showError('Đã xóa phòng thành công!', false);

                // If user is currently in this room, redirect to default chat
                if (currentRoom && currentRoom.id === roomId) {
                    currentRoom = null;
                    document.querySelector('.chat-header h2').innerHTML = '<i class="fas fa-circle" style="color: var(--accent);"></i> ntdChat v2';
                    document.getElementById('messagesContainer').innerHTML = '';
                    await loadMessages();
                    subscribeToMessagesForRoom();
                }

                // Reload rooms list
                loadRooms();
            } catch (error) {
                showError('Lỗi khi xóa phòng');
            }
        }

        // Subscribe to messages for specific room
        async function subscribeToMessagesForRoom() {
            // Unsubscribe first if already subscribed
            if (messagesSubscription) {
                await messagesSubscription.unsubscribe();
                // Small delay to ensure cleanup
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            const channelName = currentRoom ? `messages-room-${currentRoom.id}` : 'messages-default';

            // Subscribe to ALL messages, filter on client side in handleNewMessage
            messagesSubscription = supabaseClient
                .channel(channelName)
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'messages'
                    // Remove filter - we'll filter in handleNewMessage instead
                }, (payload) => {
                    handleNewMessage(payload);
                })
                .on('postgres_changes', {
                    event: 'UPDATE',
                    schema: 'public',
                    table: 'messages'
                    // Remove filter - we'll filter in handleMessageUpdate instead
                }, (payload) => {
                    handleMessageUpdate(payload);
                })
                .subscribe((status) => {
                });
        }

        // Subscribe to rooms changes
        function subscribeToRooms() {
            roomsSubscription = supabaseClient
                .channel('rooms_channel')
                .on('postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'chat_rooms'
                    },
                    () => {
                        // Reload rooms if modal is open
                        const modal = document.getElementById('roomModal');
                        if (modal && modal.classList.contains('active')) {
                            loadRooms();
                        }
                    }
                )
                .subscribe();
        }

        // Back to main room (default chat without room)
        async function backToMainRoom() {
            try {
                closeChatActionsMenu();
                // Reload page to return main room; auth session will auto-login again
                window.location.reload();
            } catch (error) {
                showError('Lỗi khi quay về phòng chính');
            }
        }

        // Exit current room and return to main chat (reload page)
        async function exitCurrentRoom() {
            window.location.reload();
        }

        // ========== END ROOM CHAT FUNCTIONALITY ==========

        // ========== REPLY FUNCTIONS ==========

        // Reply to message
        function replyTo(messageId, username, content) {
            replyToMessage = {
                id: messageId,
                username: username,
                content: content
            };

            // Show reply indicator
            document.getElementById('replyIndicator').classList.add('active');
            document.getElementById('replyContent').textContent = `${username}: ${content}`;

            // Focus input
            document.getElementById('messageInput').focus();
        }

        // Reply to message from button - gets current content from DOM
        function replyToFromButton(messageId) {
            const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageDiv) return;

            const username = messageDiv.getAttribute('data-username') || 'User';

            if (messageDiv.getAttribute('data-is-private') === 'true') {
                replyTo(messageId, username, '[Tin nhắn bí mật]');
                return;
            }

            // Lấy content hiện tại từ DOM (đã được cập nhật nếu có chỉnh sửa)
            const contentDiv = messageDiv.querySelector('.message-content');
            let content = '';

            if (contentDiv) {
                // Lấy text từ .message-text nếu có (khi có ảnh)
                const textDiv = contentDiv.querySelector('.message-text');
                if (textDiv) {
                    content = textDiv.textContent;
                } else {
                    // Nếu không có .message-text, lấy toàn bộ textContent
                    content = contentDiv.textContent.trim();
                }
            }
            
            // Gọi function replyTo với content hiện tại
            replyTo(messageId, username, content);
        }

        // Cancel reply
        function cancelReply() {
            replyToMessage = null;
            document.getElementById('replyIndicator').classList.remove('active');
        }

        // ========== EDIT FUNCTIONS ==========

        // Edit message
        function editMessage(messageId) {
            const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageDiv) return;
            
            messageDiv.classList.add('editing');
            
            const editInput = document.getElementById(`edit-input-${messageId}`);
            if (editInput) {
                editInput.focus();
                editInput.select();
            }
        }

        // Save edit
        async function saveEdit(messageId) {
            const editInput = document.getElementById(`edit-input-${messageId}`);
            if (!editInput) return;

            const newContent = editInput.value.trim();
            const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
            const isPrivateMessage = messageDiv && messageDiv.getAttribute('data-is-private') === 'true';
            const contentToSave = isPrivateMessage ? encodePrivateContent(newContent) : newContent;

            if (!newContent) {
                showError('Tin nhắn không được để trống!');
                return;
            }

            try {
                const { data, error } = await supabaseClient
                    .from('messages')
                    .update({
                        content: contentToSave,
                        edited: true,
                        edited_at: new Date().toISOString()
                    })
                    .eq('id', messageId)
                    .select()
                    .single();

                if (error) throw error;

                // CẬP NHẬT UI NGAY LẬP TỨC
                updateMessageDisplayAfterEdit(messageId, contentToSave);

                cancelEdit(messageId);
                showError('Đã cập nhật tin nhắn!', false);
            } catch (error) {
                showError('Lỗi khi cập nhật tin nhắn!');
            }
        }

        // Update message display immediately after edit
        function updateMessageDisplayAfterEdit(messageId, newContent) {
            const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageDiv) return;

            const parsedContent = parseStoredMessageContent(newContent || '');
            const isPrivateMessage = parsedContent.isPrivate;
            const displayText = parsedContent.text || '';
            messageDiv.setAttribute('data-is-private', isPrivateMessage ? 'true' : 'false');

            const contentDiv = messageDiv.querySelector('.message-content');
            if (contentDiv) {
                const oldTextNode = contentDiv.querySelector('.message-text');
                if (oldTextNode) {
                    oldTextNode.remove();
                }

                const mediaNode = contentDiv.querySelector('.message-image, .message-video, .message-audio, .message-file');
                const reactionPicker = contentDiv.querySelector('.reaction-picker');
                const insertBeforeTarget = mediaNode || reactionPicker || null;
                const textHtml = buildMessageTextHtml(displayText, isPrivateMessage, !!mediaNode);

                if (textHtml) {
                    const wrapper = document.createElement('div');
                    wrapper.innerHTML = textHtml.trim();
                    const textNode = wrapper.firstElementChild;
                    if (textNode) {
                        if (insertBeforeTarget) {
                            contentDiv.insertBefore(textNode, insertBeforeTarget);
                        } else {
                            contentDiv.prepend(textNode);
                        }
                    }
                }
            }

            const editInput = document.getElementById(`edit-input-${messageId}`);
            if (editInput) {
                editInput.value = displayText;
            }

            // Add/update edited indicator
            let editedDiv = messageDiv.querySelector('.message-edited');
            if (!editedDiv) {
                editedDiv = document.createElement('div');
                editedDiv.className = 'message-edited';
                editedDiv.textContent = '';
                
                // Insert after content
                const editContainer = messageDiv.querySelector('.edit-container');
                if (editContainer) {
                    editContainer.before(editedDiv);
                } else {
                    contentDiv.after(editedDiv);
                }
            }
        }

        // Cancel edit
        function cancelEdit(messageId) {
            const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageDiv) {
                messageDiv.classList.remove('editing');
            }
        }

        // ========== END REPLY & EDIT FUNCTIONS ==========

        // Update all messages that reply to an edited message
        function updateRepliedMessages(originalMessageId, username, newContent) {
            // Tìm tất cả các tin nhắn có reply_to = originalMessageId
            const allMessages = document.querySelectorAll('.message');
            
            allMessages.forEach(messageDiv => {
                const replyDiv = messageDiv.querySelector('.replied-message');
                if (replyDiv) {
                    // Kiểm tra xem reply này có phải reply đến tin nhắn vừa được chỉnh sửa không
                    const replyToId = messageDiv.getAttribute('data-reply-to');
                    
                    if (replyToId && replyToId === originalMessageId.toString()) {
                        // Cập nhật nội dung reply preview
                        const replyContent = replyDiv.querySelector('.replied-content');
                        if (replyContent) {
                            replyContent.textContent = getReplyPreviewFromContent(newContent);
                        }
                    }
                }
            });
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', async () => {
            switchAuthTab('login');
            document.addEventListener('click', handleChatActionsOutsideClick);
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    closeChatActionsMenu();
                    closeSettingsModal();
                }
            });

            const nameFromUrl = getUrlParameter('q');
            if (nameFromUrl) {
                document.getElementById('registerDisplayName').value = nameFromUrl.slice(0, 20);
            }

            const loggedIn = await tryAutoLoginWithSession();
            if (!loggedIn && nameFromUrl) {
                document.getElementById('authNote').textContent = `Tên gợi ý từ ntdMusic: ${nameFromUrl}`;
            }
        });
    </script>
</body>

</html>
