<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RealTalk - Chat Realtime</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Archivo+Black&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-main: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --accent: #00ff41;
            --accent-dim: #00cc33;
            --text: #e0e0e0;
            --text-dim: #808080;
            --border: #333;
            --danger: #ff3366;
            --warning: #ffaa00;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Mono', monospace;
            background: var(--bg-main);
            color: var(--text);
            overflow: hidden;
            height: 100vh;
        }

        #loginScreen {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            position: relative;
            overflow: hidden;
        }

        #loginScreen::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0, 255, 65, 0.03) 2px,
                rgba(0, 255, 65, 0.03) 4px
            );
            animation: scanlines 8s linear infinite;
        }

        @keyframes scanlines {
            0% { transform: translateY(0); }
            100% { transform: translateY(50px); }
        }

        .login-container {
            background: var(--bg-secondary);
            border: 3px solid var(--accent);
            padding: 3rem;
            max-width: 400px;
            width: 90%;
            position: relative;
            box-shadow: 0 0 30px rgba(0, 255, 65, 0.3);
            animation: slideIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .login-container h1 {
            font-family: 'Archivo Black', sans-serif;
            font-size: 2.5rem;
            color: var(--accent);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
        }

        .login-container p {
            color: var(--text-dim);
            margin-bottom: 2rem;
            font-size: 0.9rem;
        }

        input {
            width: 100%;
            padding: 1rem;
            background: var(--bg-main);
            border: 2px solid var(--border);
            color: var(--text);
            font-family: 'Space Mono', monospace;
            font-size: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s;
        }

        input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.2);
        }

        button {
            width: 100%;
            padding: 1rem;
            background: var(--accent);
            border: none;
            color: var(--bg-main);
            font-family: 'Space Mono', monospace;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: var(--accent-dim);
            transform: translate(-50%, -50%);
            transition: width 0.4s, height 0.4s;
            border-radius: 50%;
        }

        button:hover::before {
            width: 300px;
            height: 300px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 255, 65, 0.4);
        }

        button span {
            position: relative;
            z-index: 1;
        }

        #chatScreen {
            display: none;
            height: 100vh;
            flex-direction: column;
        }

        .chat-header {
            background: var(--bg-secondary);
            border-bottom: 3px solid var(--accent);
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h2 {
            font-family: 'Archivo Black', sans-serif;
            color: var(--accent);
            font-size: 1.5rem;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-name {
            color: var(--text);
            font-weight: 700;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            background: var(--accent);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .logout-btn {
            width: auto;
            padding: 0.5rem 1rem;
            background: transparent;
            border: 2px solid var(--danger);
            color: var(--danger);
            font-size: 0.8rem;
        }

        .logout-btn:hover {
            background: var(--danger);
            color: var(--text);
        }

        .online-users {
            background: var(--bg-main);
            border-bottom: 2px solid var(--border);
            padding: 1rem 1.5rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .online-users-label {
            color: var(--text-dim);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .online-user {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg-secondary);
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            font-size: 0.85rem;
        }

        .online-dot {
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            background: var(--bg-main);
            position: relative;
        }

        .messages-container::-webkit-scrollbar {
            width: 10px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 5px;
        }

        .message {
            margin-bottom: 1.5rem;
            animation: messageIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            opacity: 0;
            animation-fill-mode: forwards;
        }

        @keyframes messageIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .message-sender {
            font-weight: 700;
            color: var(--accent);
        }

        .message-time {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .message-content {
            background: var(--bg-secondary);
            border-left: 3px solid var(--accent);
            padding: 1rem;
            color: var(--text);
            line-height: 1.6;
            position: relative;
        }

        .message.own .message-sender {
            color: var(--warning);
        }

        .message.own .message-content {
            border-left-color: var(--warning);
            background: rgba(255, 170, 0, 0.1);
        }

        .message-reactions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            flex-wrap: wrap;
        }

        .reaction {
            background: var(--bg-main);
            border: 1px solid var(--border);
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .reaction:hover {
            border-color: var(--accent);
            transform: scale(1.1);
        }

        .reaction.active {
            background: var(--accent);
            color: var(--bg-main);
            border-color: var(--accent);
        }

        .typing-indicator {
            display: none;
            color: var(--text-dim);
            font-size: 0.9rem;
            padding: 1rem 2rem;
            font-style: italic;
        }

        .typing-indicator.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .typing-dots {
            display: inline-flex;
            gap: 4px;
            margin-left: 5px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: var(--accent);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }

        .input-container {
            background: var(--bg-secondary);
            border-top: 3px solid var(--accent);
            padding: 1.5rem;
            display: flex;
            gap: 1rem;
        }

        #messageInput {
            flex: 1;
            margin-bottom: 0;
            border: 2px solid var(--border);
        }

        #sendBtn {
            width: auto;
            padding: 1rem 2rem;
            margin-bottom: 0;
        }

        .reaction-picker {
            position: absolute;
            bottom: 100%;
            right: 0;
            background: var(--bg-secondary);
            border: 2px solid var(--accent);
            padding: 0.5rem;
            display: none;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            z-index: 10;
        }

        .reaction-picker.active {
            display: flex;
        }

        .reaction-option {
            padding: 0.5rem;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
        }

        .reaction-option:hover {
            transform: scale(1.3);
        }

        .message-actions {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .message-content:hover .message-actions {
            opacity: 1;
        }

        .react-btn {
            background: var(--bg-main);
            border: 1px solid var(--border);
            padding: 0.25rem 0.5rem;
            color: var(--text);
            font-size: 0.8rem;
            cursor: pointer;
            width: auto;
        }

        .react-btn:hover {
            border-color: var(--accent);
            background: var(--accent);
            color: var(--bg-main);
        }

        .error-message {
            background: var(--danger);
            color: white;
            padding: 1rem;
            text-align: center;
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .error-message.active {
            display: block;
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="error-message" id="errorMessage"></div>

    <div id="loginScreen">
        <div class="login-container">
            <h1>RealTalk</h1>
            <p>K·∫øt n·ªëi. Tr√≤ chuy·ªán. Th·ªùi gian th·ª±c.</p>
            <input type="text" id="usernameInput" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n..." maxlength="20">
            <button onclick="handleLogin()">
                <span>Tham gia ngay</span>
            </button>
        </div>
    </div>

    <div id="chatScreen">
        <div class="chat-header">
            <h2>RealTalk</h2>
            <div class="user-info">
                <div class="status-indicator"></div>
                <span class="user-name" id="currentUserName"></span>
                <button class="logout-btn" onclick="handleLogout()">
                    <span>Tho√°t</span>
                </button>
            </div>
        </div>

        <div class="online-users">
            <span class="online-users-label">Online:</span>
            <div id="onlineUsersList"></div>
        </div>

        <div class="messages-container" id="messagesContainer"></div>

        <div class="typing-indicator" id="typingIndicator">
            <span id="typingUserName"></span> ƒëang nh·∫≠p
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>

        <div class="input-container">
            <input 
                type="text" 
                id="messageInput" 
                placeholder="Nh·∫≠p tin nh·∫Øn..."
                onkeypress="handleKeyPress(event)"
                oninput="handleTyping()"
            >
            <button id="sendBtn" onclick="sendMessage()">
                <span>G·ª≠i</span>
            </button>
        </div>
    </div>

    <script>
        // ===============================================
        // C·∫§U H√åNH SUPABASE - THAY ƒê·ªîI ·ªû ƒê√ÇY
        // ===============================================
        const SUPABASE_URL = 'https://gdbtjzebjwnbwbvktcue.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_j4d-Jt17QF57Ie3AsBpkBQ_-2xG_Dno';
        // ===============================================
        
        /*
        H∆Ø·ªöNG D·∫™N SETUP DATABASE:
        
        1. V√†o Supabase Dashboard > SQL Editor
        2. Ch·∫°y c√¢u l·ªánh SQL sau ƒë·ªÉ t·∫°o b·∫£ng messages:
        
        CREATE TABLE messages (
            id BIGSERIAL PRIMARY KEY,
            user_id TEXT NOT NULL,
            username TEXT NOT NULL,
            content TEXT NOT NULL,
            reactions JSONB DEFAULT '{}'::jsonb,
            created_at TIMESTAMPTZ DEFAULT NOW()
        );
        
        3. B·∫≠t Realtime cho b·∫£ng messages:
        
        ALTER PUBLICATION supabase_realtime ADD TABLE messages;
        
        4. (Optional) T·∫°o index cho performance t·ªët h∆°n:
        
        CREATE INDEX idx_messages_created_at ON messages(created_at DESC);
        
        5. L·∫•y Supabase URL v√† Anon Key t·ª´ Settings > API
        6. ƒêi·ªÅn v√†o 2 bi·∫øn SUPABASE_URL v√† SUPABASE_ANON_KEY ·ªü tr√™n
        */

        let supabaseClient;
        let currentUser = null;
        let typingTimeout;
        let messagesSubscription;
        let presenceChannel;

        // Initialize Supabase
        function initSupabase() {
            if (SUPABASE_URL === 'YOUR_SUPABASE_URL_HERE' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY_HERE') {
                console.warn('Supabase ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh');
                return false;
            }
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            return true;
        }

        // Login function
        async function handleLogin() {
            const username = document.getElementById('usernameInput').value.trim();

            if (!username) {
                showError('Vui l√≤ng nh·∫≠p t√™n c·ªßa b·∫°n!');
                return;
            }

            if (!supabaseClient && !initSupabase()) {
                showError('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server!');
                return;
            }

            try {
                const { error: testError } = await supabaseClient.from('messages').select('count').limit(1);
                
                if (testError) {
                    showError('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server!');
                    console.error(testError);
                    return;
                }

                currentUser = {
                    id: generateId(),
                    username: username,
                    joined_at: new Date().toISOString()
                };

                localStorage.setItem('currentUser', JSON.stringify(currentUser));

                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('chatScreen').style.display = 'flex';
                document.getElementById('currentUserName').textContent = username;

                await initializeChat();
            } catch (error) {
                showError('L·ªói k·∫øt n·ªëi: ' + error.message);
                console.error(error);
            }
        }

        // Initialize chat
        async function initializeChat() {
            await loadMessages();

            messagesSubscription = supabaseClient
                .channel('public:messages')
                .on('postgres_changes', 
                    { event: 'INSERT', schema: 'public', table: 'messages' },
                    handleNewMessage
                )
                .on('postgres_changes',
                    { event: 'UPDATE', schema: 'public', table: 'messages' },
                    handleMessageUpdate
                )
                .subscribe();

            presenceChannel = supabaseClient.channel('presence', {
                config: {
                    presence: {
                        key: currentUser.id
                    }
                }
            });

            presenceChannel
                .on('presence', { event: 'sync' }, () => {
                    const state = presenceChannel.presenceState();
                    updateOnlineUsers(state);
                })
                .on('broadcast', { event: 'typing' }, ({ payload }) => {
                    if (payload.userId !== currentUser.id) {
                        showTypingIndicator(payload.username);
                    }
                })
                .subscribe(async (status) => {
                    if (status === 'SUBSCRIBED') {
                        await presenceChannel.track({
                            user_id: currentUser.id,
                            username: currentUser.username,
                            online_at: new Date().toISOString()
                        });
                    }
                });
        }

        // Load messages
        async function loadMessages() {
            try {
                const { data, error } = await supabaseClient
                    .from('messages')
                    .select('*')
                    .order('created_at', { ascending: true })
                    .limit(50);

                if (error) throw error;

                const container = document.getElementById('messagesContainer');
                container.innerHTML = '';

                if (data && data.length > 0) {
                    data.forEach(message => {
                        displayMessage(message);
                    });
                } else {
                    container.innerHTML = '<div style="text-align: center; color: var(--text-dim); padding: 2rem;">Ch∆∞a c√≥ tin nh·∫Øn n√†o. H√£y g·ª≠i tin nh·∫Øn ƒë·∫ßu ti√™n! üëã</div>';
                }

                scrollToBottom();
            } catch (error) {
                console.error('Error loading messages:', error);
                showError('Kh√¥ng th·ªÉ t·∫£i tin nh·∫Øn');
            }
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (!content) return;

            try {
                const { error } = await supabaseClient
                    .from('messages')
                    .insert([
                        {
                            user_id: currentUser.id,
                            username: currentUser.username,
                            content: content,
                            reactions: {}
                        }
                    ]);

                if (error) throw error;

                input.value = '';
            } catch (error) {
                showError('Kh√¥ng th·ªÉ g·ª≠i tin nh·∫Øn!');
                console.error('Error sending message:', error);
            }
        }

        // Handle new message
        function handleNewMessage(payload) {
            const container = document.getElementById('messagesContainer');
            
            if (container.innerHTML.includes('Ch∆∞a c√≥ tin nh·∫Øn')) {
                container.innerHTML = '';
            }
            
            displayMessage(payload.new);
            scrollToBottom();
        }

        // Handle message update
        function handleMessageUpdate(payload) {
            const messageElement = document.querySelector(`[data-message-id="${payload.new.id}"]`);
            if (messageElement) {
                updateMessageReactions(messageElement, payload.new.reactions);
            }
        }

        // Display message
        function displayMessage(message) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.user_id === currentUser.id ? 'own' : ''}`;
            messageDiv.setAttribute('data-message-id', message.id);

            const time = new Date(message.created_at).toLocaleTimeString('vi-VN', {
                hour: '2-digit',
                minute: '2-digit'
            });

            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-sender">${escapeHtml(message.username)}</span>
                    <span class="message-time">${time}</span>
                </div>
                <div class="message-content">
                    ${escapeHtml(message.content)}
                    <div class="message-actions">
                        <button class="react-btn" onclick="toggleReactionPicker(${message.id})">‚ù§Ô∏è</button>
                    </div>
                    <div class="reaction-picker" id="picker-${message.id}">
                        <span class="reaction-option" onclick="addReaction(${message.id}, '‚ù§Ô∏è')">‚ù§Ô∏è</span>
                        <span class="reaction-option" onclick="addReaction(${message.id}, 'üëç')">üëç</span>
                        <span class="reaction-option" onclick="addReaction(${message.id}, 'üòÇ')">üòÇ</span>
                        <span class="reaction-option" onclick="addReaction(${message.id}, 'üî•')">üî•</span>
                        <span class="reaction-option" onclick="addReaction(${message.id}, '‚ú®')">‚ú®</span>
                    </div>
                </div>
                <div class="message-reactions" id="reactions-${message.id}"></div>
            `;

            container.appendChild(messageDiv);
            
            if (message.reactions) {
                updateMessageReactions(messageDiv, message.reactions);
            }
        }

        // Toggle reaction picker
        function toggleReactionPicker(messageId) {
            const picker = document.getElementById(`picker-${messageId}`);
            const allPickers = document.querySelectorAll('.reaction-picker');
            
            allPickers.forEach(p => {
                if (p.id !== `picker-${messageId}`) {
                    p.classList.remove('active');
                }
            });
            
            picker.classList.toggle('active');
        }

        // Add reaction
        async function addReaction(messageId, emoji) {
            try {
                const { data: message, error: fetchError } = await supabaseClient
                    .from('messages')
                    .select('reactions')
                    .eq('id', messageId)
                    .single();

                if (fetchError) throw fetchError;

                const reactions = message.reactions || {};
                
                if (!reactions[emoji]) {
                    reactions[emoji] = [];
                }

                const userIndex = reactions[emoji].indexOf(currentUser.id);
                if (userIndex > -1) {
                    reactions[emoji].splice(userIndex, 1);
                    if (reactions[emoji].length === 0) {
                        delete reactions[emoji];
                    }
                } else {
                    reactions[emoji].push(currentUser.id);
                }

                const { error: updateError } = await supabaseClient
                    .from('messages')
                    .update({ reactions })
                    .eq('id', messageId);

                if (updateError) throw updateError;

                document.getElementById(`picker-${messageId}`).classList.remove('active');
            } catch (error) {
                console.error('Error adding reaction:', error);
                showError('Kh√¥ng th·ªÉ th√™m reaction');
            }
        }

        // Update message reactions
        function updateMessageReactions(messageElement, reactions) {
            const reactionsContainer = messageElement.querySelector('.message-reactions');
            reactionsContainer.innerHTML = '';

            if (!reactions) return;

            Object.entries(reactions).forEach(([emoji, userIds]) => {
                if (userIds.length > 0) {
                    const reactionDiv = document.createElement('div');
                    reactionDiv.className = `reaction ${userIds.includes(currentUser.id) ? 'active' : ''}`;
                    reactionDiv.innerHTML = `${emoji} <span>${userIds.length}</span>`;
                    reactionDiv.onclick = () => {
                        const messageId = messageElement.getAttribute('data-message-id');
                        addReaction(parseInt(messageId), emoji);
                    };
                    reactionsContainer.appendChild(reactionDiv);
                }
            });
        }

        // Handle typing
        function handleTyping() {
            if (presenceChannel) {
                presenceChannel.send({
                    type: 'broadcast',
                    event: 'typing',
                    payload: { 
                        userId: currentUser.id,
                        username: currentUser.username 
                    }
                });
            }
        }

        // Show typing indicator
        function showTypingIndicator(username) {
            const indicator = document.getElementById('typingIndicator');
            const usernameSpan = document.getElementById('typingUserName');
            
            usernameSpan.textContent = username;
            indicator.classList.add('active');

            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                indicator.classList.remove('active');
            }, 2000);
        }

        // Update online users
        function updateOnlineUsers(state) {
            const container = document.getElementById('onlineUsersList');
            container.innerHTML = '';

            Object.values(state).forEach(presences => {
                presences.forEach(presence => {
                    if (presence.username) {
                        const userDiv = document.createElement('div');
                        userDiv.className = 'online-user';
                        userDiv.innerHTML = `
                            <div class="online-dot"></div>
                            <span>${escapeHtml(presence.username)}</span>
                        `;
                        container.appendChild(userDiv);
                    }
                });
            });
        }

        // Handle key press
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Logout
        async function handleLogout() {
            if (presenceChannel) {
                await presenceChannel.untrack();
                await presenceChannel.unsubscribe();
            }
            if (messagesSubscription) {
                await messagesSubscription.unsubscribe();
            }

            localStorage.removeItem('currentUser');
            location.reload();
        }

        // Utility functions
        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.add('active');
            
            setTimeout(() => {
                errorDiv.classList.remove('active');
            }, 4000);
        }

        // Auto-fill username if exists
        window.addEventListener('DOMContentLoaded', () => {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                document.getElementById('usernameInput').value = JSON.parse(savedUser).username;
            }
        });
    </script>
</body>
</html>