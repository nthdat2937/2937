<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <title>Music Library</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <style>
    ::-webkit-scrollbar {
      width: 10px;
    }

    ::-webkit-scrollbar-track {
      background: #0f0f0f;
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #22d3ee, #38bdf8);
      border-radius: 10px;
      border: 2px solid #0f0f0f;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #38bdf8, #0ea5e9);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: Inter, sans-serif;
      background: #0f0f12;
      color: #eee;
      font-size: 24px;
    }

    body::selection {
      color: white;
      background-color: violet;
    }

    header {
      padding: 24px 32px;
      font-size: 36px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, #1a1a20 0%, #161620 100%);
      border-bottom: 1px solid #2a2a33;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    main {
      padding: 32px;
    }

    .search-container {
      flex: 1;
      max-width: 400px;
      margin: 0 24px;
    }

    .search-input {
      width: 100%;
      padding: 12px 18px;
      border: 1px solid #2a2a33;
      border-radius: 10px;
      background: #1a1a20;
      color: #fff;
      font-family: Inter, sans-serif;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .search-input::placeholder {
      color: #6b7280;
    }

    .search-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
      background: #161620;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #1a1a20;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
      transition: box-shadow 0.3s ease;
    }

    thead {
      background: #202028;
    }

    th,
    td {
      padding: 18px 20px;
      text-align: left;
      border-bottom: 1px solid #2a2a33;
      font-size: 17px;
    }

    th {
      font-weight: 600;
      opacity: 0.85;
    }

    th:nth-child(1) {
      width: 5%;
    }

    th:nth-child(2) {
      width: 15%;
    }

    th:nth-child(3) {
      width: 10%;
    }

    th:nth-child(4) {
      width: 10%;
    }

    th:nth-child(5) {
      width: 10%;
    }

    th:nth-child(6) {
      width: 40%;
    }

    th:nth-child(7) {
      width: 10%;
    }

    tbody tr {
      transition: background-color 0.2s ease;
    }

    tbody tr:nth-child(odd) {
      background: #1a1a20;
    }

    tbody tr:nth-child(even) {
      background: #16161b;
    }

    tbody tr:hover {
      background: #2a3a4f;
      box-shadow: inset 0 0 15px rgba(59, 130, 246, 0.15);
      cursor: pointer;
    }

    .actions-cell {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .btn {
      background: #3b82f6;
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.3s ease;
      white-space: nowrap;
    }

    .btn:hover {
      background: #2563eb;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-add {
      padding: 10px 20px;
      font-size: 15px;
    }



    .btncl:nth-child(1) {
      background-color: #3498db;
    }

    .btncl:nth-child(2) {
      background-color: #2ecc71;
    }

    .btncl:nth-child(3) {
      background-color: #9b59b6;
    }

    .btn-delete {
      background: #ef4444;
      padding: 6px 12px;
      font-size: 17px;
    }

    .btn-delete:hover {
      background: #dc2626;
    }

    .btn-edit {
      background: #f59e0b;
      padding: 6px 12px;
      font-size: 17px;
    }

    .btn-edit:hover {
      background: #d97706;
    }

    .btn-lyric {
      background: #3b82f6;
      padding: 6px 12px;
      font-size: 17px;
    }

    .btn-lyric:hover {
      background: #2563eb;
    }

    dialog {
      border: none;
      border-radius: 16px;
      width: min(1200px, 95%);
      background: #141418;
      color: #fff;
      padding: 32px;
      animation: slideIn 0.4s cubic-bezier(0.34, 0.1, 0.68, 1);
    }

    dialog::backdrop {
      background: rgba(0, 0, 0, 0.6);
      animation: fadeIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: scale(0.95) translateY(20px);
      }

      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .lyric-container {
      display: flex;
      gap: 20px;
      margin-top: 16px;
    }

    .lyric-avatar {
      flex-shrink: 0;
    }

    .lyric-avatar img {
      width: 300px;
      height: 300px;
      object-fit: cover;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      transition: transform 0.3s ease;
    }

    .lyric-avatar img:hover {
      transform: scale(1.05);
    }

    .lyric-content {
      flex: 1;
      min-width: 0;
    }

    .lyric-content h2 {
      margin: 0 0 12px 0;
      font-size: 72px;
      font-style: italic;
    }

    .lyric-content p {
      margin: 0 0 20px 0;
      font-size: 15px;
      opacity: 0.8;
    }

    .lyric-content pre {
      margin: 0;
      font-size: 18px;
      white-space: pre-wrap;
      line-height: 1.8;
    }

    .form-group {
      margin-bottom: 16px;
      position: relative;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      font-size: 20px;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #2a2a33;
      border-radius: 8px;
      background: #1a1a20;
      color: #fff;
      font-family: Inter, sans-serif;
      font-size: 18px;
      transition: all 0.3s ease;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 240px;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
      background: #161620;
      transform: translateY(-2px);
    }

    .form-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 24px;
    }

    .btn-submit {
      background: #10b981;
      transition: all 0.3s ease;
    }

    .btn-submit:hover {
      background: #059669;
    }

    .btn-cancel {
      background: #6b7280;
      transition: all 0.3s ease;
    }

    .btn-cancel:hover {
      background: #4b5563;
    }

    .error {
      color: #ef4444;
      font-size: 12px;
      margin-top: 4px;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-5px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .close {
      font-weight: 900;
      float: right;
      background: #ef4444;
      margin: 0;
      transition: all 0.3s ease;
      padding: 8px 12px;
      border-radius: 25px;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 14px;
      margin-top: 5%;
    }

    .close:hover {
      background: #dc2626;
      transform: scale(1.1);
    }

    .goiy {
      float: right;
      color: #3b82f6;
      text-decoration: none;
      font-size: 14px;
      transition: color 0.3s ease;
      margin-top: 4px;
      margin-bottom: 4px;
    }

    .goiy:hover {
      color: #2563eb;
      text-decoration: underline;
    }

    .motLyric {
      display: inline-block;
      transition: transform 0.3s ease, text-shadow 0.3s ease;
      cursor: pointer;
    }

    .motLyric:hover {
      transform: scale(1.1);
      text-shadow: 0 0 18px rgba(255, 255, 255, 0.8);
    }

    .iconMXH {
      width: 75px !important;
      height: 75px !important;
      margin: 0 15px;
      margin-top: 25px !important;
      background-color: transparent;
      border-radius: 25pc !important;
      cursor: pointer;
      transition: all .3 ease !important;
    }

    .iconMXH:hover {
      transform: scale(1.1);
      box-shadow: 0 0 10px white;
    }
  </style>
</head>

<body>
  <header>
    <div>
      <span><i class="fa-solid fa-music"></i></span> ntdMUSIC
      <span style="font-size: medium; color: rgba(255,255,255,0.5);">version: Local_TD_1.36</span>
    </div>
    <div class="search-container">
      <input type="text" id="searchInput" class="search-input" placeholder="üîç T√¨m ki·∫øm b√†i h√°t..." />
    </div>
    <div id="authButtons">
      <button class="btn btn-add" onclick="loginDialog.showModal()" id="btn-login" title="ƒêƒÉng nh·∫≠p">
        <i class="fa-solid fa-right-to-bracket"></i>
      </button>
    </div>
    <div id="userInfo" style="display: none; align-items: center; gap: 12px;">
      <span id="userDisplayName" style="font-size: 26px;"></span>
      <!-- S·ª¨A L·∫†I button n√†y: -->
      <button class="btn btn-add" onclick="showViewProfile()" id="btn-info-sc" title="Th√¥ng tin t√†i kho·∫£n">
        <i class="fa-solid fa-user"></i>
      </button>
      <button class="btn btn-add" onclick="handleLogout()" title="ƒêƒÉng xu·∫•t">
        <i class="fa-solid fa-right-from-bracket"></i>
      </button>
    </div>
    <div>
      <button class="btn btn-add btncl" onclick="location.reload();" id="btn-reload-sc" title="L√†m m·ªõi">
        <i class="fa-solid fa-arrow-rotate-right"></i>
      </button>
      <button class="btn btn-add btncl" onclick="addSongDialog.showModal()" id="btn-add-sc" title="Th√™m">
        <i class="fa-solid fa-plus"></i>
      </button>
      <button class="btn btn-add btncl" onclick="hoiAI()" id="btn-hoiAI-sc" title="H·ªèi AI">
        <i class="fa-solid fa-robot"></i>
      </button>
      <button class="btn btn-add btncl" onclick="window.open(`https://2937.vercel.app`)"><i class="fa-solid fa-house"></i></button>
    </div>
  </header>
  <main>
    <table>
      <thead>
        <tr>
          <th>Avatar</th>
          <th>T√™n b√†i h√°t</th>
          <th>Ca sƒ©</th>
          <th>S√°ng t√°c</th>
          <th>Ng√†y ph√°t h√†nh</th>
          <th>Hot</th>
          <th>Thao t√°c</th>
        </tr>
      </thead>
      <tbody id="list"></tbody>
    </table>
  </main>
  <dialog id="lyricDialog">
    <button class="btn close" onclick="lyricDialog.close()">
      <i class="fa-solid fa-x" style="font-weight: bold;"></i>
    </button>
    <div class="lyric-container">
      <div class="lyric-avatar">
        <img id="dAvatar" src="" alt="avatar" style="display: none" />
        <hr width="100%" color="white" style="border: none; height: 1px; margin: 32px 0; background-color: white; opacity: 1;">
        <div style="font-weight: 700; text-align: center; font-style: italic;">Nghe nh·∫°c</div>
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/84/Spotify_icon.svg/250px-Spotify_icon.svg.png" class="iconMXH" onclick="spotifyThismusic()" />
        <img src="https://dangcapdigital.vn/img/app/zingmp3-aszyd.png" class="iconMXH" onclick="zingmp3Thismusic()" />
        <img src="https://upload.wikimedia.org/wikipedia/commons/2/2b/NhacCuaTui_2022logo.png" class="iconMXH" onclick="nctThismusic()" />
        <hr width="100%" color="white" style="border: none; height: 1px; margin: 32px 0; background-color: white; opacity: 1;">
        <div style="font-weight: 700; text-align: center; font-style: italic;">Xem MV / Video</div>
        <img src="https://upload.wikimedia.org/wikipedia/commons/e/ef/Youtube_logo.png" class="iconMXH" onclick="youtubeThismusic()" />
        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQiXN9xSEe8unzPBEQOeAKXd9Q55efGHGB9BA&s" class="iconMXH" onclick="facebookThismusic()" />
        <img src="https://p16-tiktokcdn-com.akamaized.net/obj/tiktok-obj/32f2ab89bf0d9acee8ff3021890559a7.png" class="iconMXH" onclick="tiktokThismusic()" />
      </div>
      <div class="lyric-content">
        <h2 id="dTitle"></h2>
        <p id="dArtist" style="float: left;"></p>
        <p id="dDate"></p>
        <p id="dAddedBy" style="clear: both; opacity: 0.6; font-size: 14px; margin-top: 8px;"></p>
        <pre id="dLyric"></pre>
      </div>
    </div>
  </dialog>
  <dialog id="addSongDialog">
    <button class="btn close" onclick="addSongDialog.close()">
      <i class="fa-solid fa-x"></i>
    </button>
    <h2>Th√™m b√†i h√°t m·ªõi</h2>
    <form id="songForm">
      <div class="form-group">
        <a href="https://www.google.com/search?q=b%C3%A0i+h%C3%A1t+hot+nh%E1%BA%A5t+tiktok+hi%E1%BB%87n+t%E1%BA%A1i" target="_blank" class="goiy">G·ª£i √Ω</a>
        <label for="songName">T√™n b√†i h√°t *</label>
        <input type="text" id="songName" placeholder="Nh·∫≠p t√™n b√†i h√°t" required />
        <div class="error" id="error-songName"></div>
      </div>
      <div class="form-group">
        <a href="#" class="goiy" onclick="timCasi()">Kh√¥ng bi·∫øt t√™n ca sƒ©?</a>
        <label for="artist">Ca sƒ© *</label>
        <input type="text" id="artist" placeholder="Nh·∫≠p t√™n ca sƒ©" required />
        <div class="error" id="error-artist"></div>
      </div>
      <div class="form-group">
        <a href="#" class="goiy" onclick="timSangtac()">Kh√¥ng bi·∫øt ai s√°ng t√°c?</a>
        <label for="composer">S√°ng t√°c *</label>
        <input type="text" id="composer" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi s√°ng t√°c" required />
        <div class="error" id="error-composer"></div>
      </div>
      <div class="form-group">
        <a href="#" class="goiy" onclick="timLinkbaihat()">T√¨m link b√†i h√°t</a>
        <label>Link YouTube (ch·ªâ c·∫ßn khi th·∫•y ng√†y ph√°t h√†nh b·ªã sai)</label>
        <div style="display:flex; gap:8px">
          <input type="url" id="youtubeLinkAdd" placeholder="https://www.youtube.com/watch?v=..." />
          <button type="button" class="btn" onclick="fetchYoutubeDate('add')" style="padding: 0 14px">
            üìÖ
          </button>
        </div>
      </div>

      <div class="form-group">
        <a href="#" class="goiy" onclick="timNgayphathanh()">Kh√¥ng bi·∫øt ng√†y ph√°t h√†nh?</a>
        <label for="releaseDate">Ng√†y ph√°t h√†nh *</label>
        <div style="display:flex; gap:8px">
          <input type="date" id="releaseDate" required />
          <button type="button" class="btn" title="T·ª± t√¨m ng√†y ph√°t h√†nh theo t√™n b√†i h√°t" onclick="autoFindReleaseDate()" style="padding: 0 14px">
            üîç
          </button>
        </div>

        <div class="error" id="error-releaseDate"></div>
      </div>
      <div class="form-group">
        <a href="#" onclick="timAvatar1()" class="goiy">T√¨m avatar</a>
        <label for="avatar">URL Avatar</label>
        <input type="url" id="avatar" placeholder="Nh·∫≠p link/url c·ªßa ·∫£nh" />
        <div class="error" id="error-avatar"></div>
      </div>
      <div class="form-group">
        <a href="#" class="goiy" onclick="timLoibaihat()">T√¨m l·ªùi b√†i h√°t</a>
        <label for="lyric">L·ªùi b√†i h√°t</label>
        <textarea id="lyric" placeholder="Nh·∫≠p l·ªùi b√†i h√°t ƒë√£ sao ch√©p"></textarea>
        <div class="error" id="error-lyric"></div>
      </div>

      <div class="form-group">
        <label for="addedBy">Ng∆∞·ªùi th√™m</label>
        <input type="text" id="addedBy" readonly style="background: #0f0f12; cursor: not-allowed; opacity: 0.7;" />
        <small style="color: #6b7280; font-size: 14px; margin-top: 4px; display: block;">
          üí° T·ª± ƒë·ªông l·∫•y t·ª´ t√†i kho·∫£n ƒëang ƒëƒÉng nh·∫≠p
        </small>
      </div>

      <div class="form-group">
        <label for="adminCode">M√£ x√°c minh Admin (t√πy ch·ªçn)</label>
        <input type="text" id="adminCode" placeholder="Nh·∫≠p m√£ admin ƒë·ªÉ t·ª± ƒë·ªông x√°c minh" />
        <div class="error" id="error-adminCode"></div>
        <small style="
                            color: #6b7280;
                            font-size: 14px;
                            margin-top: 4px;
                            display: block;
                        ">üí° Nh·∫≠p m√£ admin ƒë·ªÉ b√†i h√°t ƒë∆∞·ª£c x√°c minh ngay l·∫≠p
          t·ª©c</small>
      </div>
      <div class="form-actions">
        <button type="button" class="btn btn-cancel" onclick="addSongDialog.close()">
          H·ªßy
        </button>
        <button type="submit" class="btn btn-submit">
          Th√™m b√†i h√°t
        </button>
      </div>
    </form>
  </dialog>

  <dialog id="editSongDialog">
    <button class="btn close" onclick="editSongDialog.close()">
      <i class="fa-solid fa-x"></i>
    </button>
    <h2>Ch·ªânh s·ª≠a b√†i h√°t</h2>
    <form id="editSongForm">
      <div class="form-group">
        <label for="editSongName">T√™n b√†i h√°t *</label>
        <input type="text" id="editSongName" required />
        <div class="error" id="error-editSongName"></div>
      </div>
      <div class="form-group">
        <label for="editArtist">Ca sƒ© *</label>
        <input type="text" id="editArtist" required />
        <div class="error" id="error-editArtist"></div>
      </div>
      <div class="form-group">
        <label for="editComposer">S√°ng t√°c *</label>
        <input type="text" id="editComposer" required />
        <div class="error" id="error-editComposer"></div>
      </div>
      <div class="form-group">
        <label for="editReleaseDate">Ng√†y ph√°t h√†nh *</label>
        <input type="date" id="editReleaseDate" required />
        <div class="error" id="error-editReleaseDate"></div>
      </div>
      <div class="form-group">
        <a href="#" onclick="timAvatar()" class="goiy">T√¨m avatar</a>
        <label for="editAvatar">URL Avatar</label>
        <input type="url" id="editAvatar" />
        <div class="error" id="error-editAvatar"></div>
      </div>
      <div class="form-group">
        <label for="editLyric">L·ªùi b√†i h√°t</label>
        <textarea id="editLyric"></textarea>
        <div class="error" id="error-editLyric"></div>
      </div>
      <div class="form-actions">
        <button type="button" class="btn btn-cancel" onclick="editSongDialog.close()">
          H·ªßy
        </button>
        <button type="submit" class="btn btn-submit">
          C·∫≠p nh·∫≠t b√†i h√°t
        </button>
      </div>
    </form>
  </dialog>

  <!-- Dialog ƒêƒÉng nh·∫≠p -->
  <dialog id="loginDialog">
    <button class="btn close" onclick="loginDialog.close()">
      <i class="fa-solid fa-x"></i>
    </button>
    <h2>ƒêƒÉng nh·∫≠p</h2>
    <form id="loginForm">
      <div class="form-group">
        <label for="loginEmail">Email *</label>
        <input type="email" id="loginEmail" required placeholder="example@email.com" />
      </div>
      <div class="form-group">
        <label for="loginPassword">M·∫≠t kh·∫©u *</label>
        <input type="password" id="loginPassword" required />
      </div>
      <div class="form-actions">
        <button type="button" class="btn btn-cancel" onclick="loginDialog.close()">H·ªßy</button>
        <button type="submit" class="btn btn-submit">ƒêƒÉng nh·∫≠p</button>
      </div>
      <div style="text-align: center; margin-top: 16px;">
        <a href="#" class="goiy" onclick="event.preventDefault(); loginDialog.close(); registerDialog.showModal()">
          Ch∆∞a c√≥ t√†i kho·∫£n? ƒêƒÉng k√Ω ngay
        </a>
      </div>
    </form>
  </dialog>

  <!-- Dialog ƒêƒÉng k√Ω -->
  <dialog id="registerDialog">
    <button class="btn close" onclick="registerDialog.close()">
      <i class="fa-solid fa-x"></i>
    </button>
    <h2>ƒêƒÉng k√Ω t√†i kho·∫£n</h2>
    <form id="registerForm">
      <div class="form-group">
        <label for="regDisplayName">T√™n hi·ªÉn th·ªã *</label>
        <input type="text" id="regDisplayName" required placeholder="Nguy·ªÖn VƒÉn A" />
        <div class="error" id="error-regDisplayName"></div>
      </div>
      <div class="form-group">
        <label for="regEmail">Email *</label>
        <input type="email" id="regEmail" required placeholder="example@email.com" />
        <div class="error" id="error-regEmail"></div>
      </div>
      <div class="form-group">
        <label for="regPhone">S·ªë ƒëi·ªán tho·∫°i *</label>
        <input type="tel" id="regPhone" required placeholder="0912345678" />
        <div class="error" id="error-regPhone"></div>
      </div>
      <div class="form-group">
        <label for="regPassword">M·∫≠t kh·∫©u *</label>
        <input type="password" id="regPassword" required placeholder="T·ªëi thi·ªÉu 6 k√Ω t·ª±" />
        <div class="error" id="error-regPassword"></div>
      </div>
      <div class="form-group">
        <label for="regConfirmPassword">Nh·∫≠p l·∫°i m·∫≠t kh·∫©u *</label>
        <input type="password" id="regConfirmPassword" required />
        <div class="error" id="error-regConfirmPassword"></div>
      </div>
      <div class="form-actions">
        <button type="button" class="btn btn-cancel" onclick="registerDialog.close()">H·ªßy</button>
        <button type="submit" class="btn btn-submit">ƒêƒÉng k√Ω</button>
      </div>
      <div style="text-align: center; margin-top: 16px;">
        <a href="#" class="goiy" onclick="event.preventDefault(); registerDialog.close(); loginDialog.showModal()">
          ƒê√£ c√≥ t√†i kho·∫£n? ƒêƒÉng nh·∫≠p
        </a>
      </div>
    </form>
  </dialog>
  <dialog id="viewProfileDialog">
    <button class="btn close" onclick="viewProfileDialog.close()">
      <i class="fa-solid fa-x"></i>
    </button>
    <h2>Th√¥ng tin t√†i kho·∫£n</h2>
    <div style="padding: 20px;">
      <div style="display: flex; padding: 12px; border-bottom: 1px solid #2a2a33;">
        <label style="flex: 0 0 200px; font-weight: 600; opacity: 0.7;">T√™n hi·ªÉn th·ªã:</label>
        <span id="viewDisplayName"></span>
      </div>
      <div style="display: flex; padding: 12px; border-bottom: 1px solid #2a2a33;">
        <label style="flex: 0 0 200px; font-weight: 600; opacity: 0.7;">Email:</label>
        <span id="viewEmail"></span>
      </div>
      <div style="display: flex; padding: 12px; border-bottom: 1px solid #2a2a33;">
        <label style="flex: 0 0 200px; font-weight: 600; opacity: 0.7;">S·ªë ƒëi·ªán tho·∫°i:</label>
        <span id="viewPhone"></span>
      </div>
      <div style="display: flex; padding: 12px; border-bottom: 1px solid #2a2a33;">
        <label style="flex: 0 0 200px; font-weight: 600; opacity: 0.7;">Vai tr√≤:</label>
        <span id="viewRole"></span>
      </div>
      <br>
      <img src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=https://www.facebook.com/nthdat.7" alt="QR Facebook" style="text-align: center;padding: 20px; background-color: white;" />
      <div style="margin-top: 24px; text-align: center;">
        <button class="btn btn-edit" onclick="openEditProfileDialog()">
          <i class="fa-solid fa-pen-to-square"></i> Ch·ªânh s·ª≠a th√¥ng tin
        </button>
      </div>
    </div>
  </dialog>

  <!-- TH√äM DIALOG CH·ªàNH S·ª¨A TH√îNG TIN -->
  <dialog id="editProfileDialog">
    <button class="btn close" onclick="editProfileDialog.close()">
      <i class="fa-solid fa-x"></i>
    </button>
    <h2>Ch·ªânh s·ª≠a th√¥ng tin</h2>
    <form id="editProfileForm">
      <div class="form-group">
        <label for="editDisplayName">T√™n hi·ªÉn th·ªã *</label>
        <input type="text" id="editDisplayName" required>
        <div class="error" id="error-editDisplayName"></div>
      </div>

      <div class="form-group">
        <label for="editPhone">S·ªë ƒëi·ªán tho·∫°i *</label>
        <input type="tel" id="editPhone" required placeholder="0912345678">
        <div class="error" id="error-editPhone"></div>
      </div>

      <hr style="border: none; height: 1px; background-color: #2a2a33; margin: 24px 0;">
      <h3 style="margin-bottom: 16px;">ƒê·ªïi m·∫≠t kh·∫©u (t√πy ch·ªçn)</h3>
      <small style="color: #6b7280; display: block; margin-bottom: 16px;">
        üí° Ch·ªâ ƒëi·ªÅn n·∫øu b·∫°n mu·ªën ƒë·ªïi m·∫≠t kh·∫©u
      </small>

      <div class="form-group">
        <label for="oldPassword">M·∫≠t kh·∫©u c≈©</label>
        <input type="password" id="oldPassword">
        <div class="error" id="error-oldPassword"></div>
      </div>

      <div class="form-group">
        <label for="newPassword">M·∫≠t kh·∫©u m·ªõi</label>
        <input type="password" id="newPassword" placeholder="T·ªëi thi·ªÉu 6 k√Ω t·ª±">
        <div class="error" id="error-newPassword"></div>
      </div>

      <div class="form-group">
        <label for="confirmNewPassword">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
        <input type="password" id="confirmNewPassword">
        <div class="error" id="error-confirmNewPassword"></div>
      </div>

      <div class="form-actions">
        <button type="button" class="btn btn-cancel" onclick="editProfileDialog.close()">
          H·ªßy
        </button>
        <button type="submit" class="btn btn-submit">
          L∆∞u thay ƒë·ªïi
        </button>
      </div>
    </form>
  </dialog>
  <script>
    function timCasi() {
      let t = document.getElementById("songName").value;
      t.trim() ? window.open(`https://www.google.com/search?q=ca+sƒ©+th·ªÉ+hi·ªán+b√†i+${encodeURIComponent(t)}`, '_blank') : alert('Vui l√≤ng nh·∫≠p t√™n b√†i h√°t tr∆∞·ªõc')
    }

    function timSangtac() {
      let t = document.getElementById("songName").value;
      t.trim() ? window.open(`https://www.google.com/search?q=ai+ƒë√£+s√°ng+t√°c b√†i+${encodeURIComponent(t)}`, '_blank') : alert('Vui l√≤ng nh·∫≠p t√™n b√†i h√°t tr∆∞·ªõc')
    }

    function timNgayphathanh() {
      let t = document.getElementById("songName").value;
      t.trim() ? window.open(`https://www.google.com/search?q=${encodeURIComponent(t)}&udm=7`, '_blank') : alert('Vui l√≤ng nh·∫≠p t√™n b√†i h√°t tr∆∞·ªõc')
    }

    function timLoibaihat() {
      let t = document.getElementById("songName").value;
      t.trim() ? window.open(`https://www.google.com/search?q=${encodeURIComponent(t)}+lyric`, '_blank') : alert('Vui l√≤ng nh·∫≠p t√™n b√†i h√°t tr∆∞·ªõc')
    }

    function timAvatar1() {
      let t = document.getElementById("songName").value;
      t.trim() ? window.open(`https://www.google.com/search?q=${encodeURIComponent(t)}&udm=2`, '_blank') : alert('Vui l√≤ng nh·∫≠p t√™n b√†i h√°t tr∆∞·ªõc')
    }

    function timAvatar() {
      let t = document.getElementById("editSongName").value;
      t.trim() ? window.open(`https://www.google.com/search?q=${encodeURIComponent(t)}&udm=2`, '_blank') : alert('Vui l√≤ng nh·∫≠p t√™n b√†i h√°t tr∆∞·ªõc')
    }

    function timLinkbaihat() {
      let t = document.getElementById("songName").value;
      t.trim() ? window.open(`https://www.google.com/search?q=${encodeURIComponent(t)}+official+site:youtube.com+&btnI=1`, '_blank') : alert('Vui l√≤ng nh·∫≠p t√™n b√†i h√°t tr∆∞·ªõc')
    }

    function spotifyThismusic() {
      window.open(`https://www.google.com/search?q=${encodeURIComponent(document.getElementById("dTitle").textContent)}+site:spotify.com+&btnI=1`)
    }

    function zingmp3Thismusic() {
      window.open(`https://www.google.com/search?q=${encodeURIComponent(document.getElementById("dTitle").textContent)}+site:zingmp3.vn+&btnI=1`)
    }

    function nctThismusic() {
      window.open(`https://www.google.com/search?q=${encodeURIComponent(document.getElementById("dTitle").textContent)}+site:nhaccuatui.com+&btnI=1`)
    }

    function youtubeThismusic() {
      window.open(`https://www.google.com/search?q=${encodeURIComponent(document.getElementById("dTitle").textContent)}+site:youtube.com+&btnI=1`)
    }

    function facebookThismusic() {
      window.open(`https://www.facebook.com/search?q=${encodeURIComponent(document.getElementById("dTitle").textContent)}+${encodeURIComponent(document.getElementById("dArtist").textContent)}`)
    }

    function tiktokThismusic() {
      window.open(`https://www.tiktok.com/search?q=${encodeURIComponent(document.getElementById("dTitle").textContent)}`)
    }

    function hoiAI() {
      const cauHoi = prompt("Nh·∫≠p c√¢u c·∫ßn h·ªèi:")
      console.log(cauHoi)

      if (cauHoi !== null && cauHoi !== "") {
        window.open(`https://www.google.com/search?q=${encodeURIComponent(cauHoi)}+&udm=50`);
      } else {
        alert("Kh√¥ng c√≥ c√¢u h·ªèi! Hu·ª∑ thao t√°c!")
      }
    }

    document.addEventListener("keydown", function(e) {
      if (
        e.target.tagName === "INPUT" ||
        e.target.tagName === "TEXTAREA" ||
        e.target.isContentEditable
      ) {
        return;
      };

      if (e.shiftKey && e.key === "R") {
        e.preventDefault();
        document.getElementById("btn-reload-sc").click();
      };

      if (e.shiftKey && e.key === "A") {
        e.preventDefault();
        document.getElementById("btn-add-sc").click();
      };

      if (e.shiftKey && e.key === "C") {
        e.preventDefault();
        document.getElementById("btn-hoiAI-sc").click();
      };
      if (e.shiftKey && e.key === "I") {
        e.preventDefault();
        document.getElementById("btn-info-sc").click();
      };
      if (e.key === "/") {
        e.preventDefault();
        document.getElementById("searchInput").focus();
      };

      if (!e.ctrlKey) return;
      const allowKeys = ["c", "v", "x"];
      if (allowKeys.includes(e.key.toLowerCase())) {
        return;
      }
      e.preventDefault();
    });

    // Check role
    function roleCheck() {
      const role = document.getElementById("role").textContent

      if (role === "Admin") {
        alert("B·∫°n l√† Admin!")
      } else if (role === "Member" || role === "Moderator") {
        alert(`B·∫°n l√† ${role}!\nLi√™n h·ªá Admin qua email ƒë·ªÉ ƒë∆∞·ª£c thƒÉng ch·ª©c!`)
        const ok = confirm("Li√™n h·ªá qua email: nthdat.2937@gmail.com\nNh·∫•n Enter / OK ƒë·ªÉ truy c·∫≠p Gmail")

        if (ok === true) {
          window.open("https://mail.google.com/mail/?view=cm&fs=1&to=nthdat.2937@gmail.com")
        }
      } else if (role === "·ª¶a" || role === "Ph√©p thu·∫≠t winx enchantix bi·∫øn h√¨nh" || role === "WTF") {
        alert("Ch·ªãu")
      } else {
        alert("M√†y b·ªã ngu √†! Cho m√†y c√°i role n√†y th√¨ t·ª± hi·ªÉu ƒëi ha")
      }
    }
  </script>
  <script type="module">
    import {
      createClient
    } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabase = createClient("https://ktqdzlhvdkerjajffgfi.supabase.co", "sb_publishable_1wm-eXETyu07vl61sY4mBQ_xwYZVOCj");

    const list = document.getElementById('list'),
      lyricDialog = document.getElementById('lyricDialog'),
      addSongDialog = document.getElementById('addSongDialog'),
      editSongDialog = document.getElementById('editSongDialog'),
      songForm = document.getElementById('songForm'),
      editSongForm = document.getElementById('editSongForm'),
      dTitle = document.getElementById('dTitle'),
      dArtist = document.getElementById('dArtist'),
      dLyric = document.getElementById('dLyric'),
      dAvatar = document.getElementById('dAvatar'),
      searchInput = document.getElementById('searchInput');

    let currentEditId = null;

    async function loadSongs() {
      const {
        data,
        error
      } = await supabase.from('songs').select('*').eq('X√°c minh', true);
      if (error) {
        console.error(error);
        return
      }
      data.sort((a, b) => a['T√™n'].localeCompare(b['T√™n'], 'vi'));
      window._songs = data;
      renderSongs(data)
    }

    function renderSongs(songs) {
      list.innerHTML = songs.map(song => {
        const hotLines = (song['Lyric'] || '').split('\n').filter(line => line.includes('--hot')).map(line => line.replace('--hot', '').trim());
        const hotText = hotLines.length > 0 ? hotLines.join(' | ') : 'Kh√¥ng c√≥';
        return `<tr><td onclick="showLyric(${song.Id})">${song.avatar?`<img src="${song.avatar}" alt="avatar" style="width:60px;
              height:60px;
              object-fit:cover;
              border-radius:8px">`:''}</td><td style="font-weight: bold; font-size: 20px;" onclick="showLyric(${song.Id})" title="${song['T√™n']}">${song['T√™n']}</td><td onclick="showLyric(${song.Id})" title="${song['Ca sƒ©']}">${song['Ca sƒ©']}</td><td onclick="showLyric(${song.Id})" title="${song['S√°ng t√°c']||''}">${song['S√°ng t√°c']||''}</td><td onclick="showLyric(${song.Id})" title="${song['Ng√†y ph√°t h√†nh']||''}">${song['Ng√†y ph√°t h√†nh']||''}</td><td style="overflow:hidden;
              text-overflow:ellipsis;
              white-space:normal;
              word-break:break-word" title="${hotText}" onclick="showLyric(${song.Id})"><span style="color:#fbbf24;
              font-weight:500;
              font-size:17px">üî• ${hotText}</span></td><td><div class="actions-cell"><button class="btn btn-edit" onclick="openEditDialog(${song.Id})" title="Ch·ªânh s·ª≠a"><i class="fa-solid fa-pen-to-square"></i></button><button class="btn btn-delete" onclick="deleteSong(${song.Id})" title="Xo√°"><i class="fa-solid fa-delete-left"></i></button><button class="btn btn-lyric" onclick="showLyric(${song.Id})" title="Chi ti·∫øt"><i class="fa-solid fa-music"></i></button></div></td></tr>`
      }).join('')
    }
    searchInput.addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase().trim();
      if (!query) {
        renderSongs(window._songs);
        return
      }
      const filtered = window._songs.filter(song => removeDiacritics(song['T√™n']).includes(removeDiacritics(query)) || removeDiacritics(song['Ca sƒ©']).includes(removeDiacritics(query)) || removeDiacritics(song['S√°ng t√°c']).includes(removeDiacritics(query)));
      renderSongs(filtered)
    });

    window.showLyric = id => {
      const s = window._songs.find(x => x.Id === id);
      dTitle.textContent = s['T√™n'];
      dArtist.textContent = `${s['Ca sƒ©']}„Ö§`;
      dDate.textContent = `‚Ä¢„Ö§${s['Ng√†y ph√°t h√†nh']||''}`
      dAddedBy.textContent = s['add_by'] ? `üë§ Ng∆∞·ªùi th√™m: ${s['add_by']}` : '';
      const lyricLines = (s['Lyric'] || '').split('\n').map(line => {
        const cleanLine = line.replace('--hot', '').trim();
        const hasHot = line.includes('--hot');
        return `<span class="motLyric">${cleanLine}${hasHot?' üî•':''}</span>`
      }).join('\n');
      dLyric.innerHTML = lyricLines || '<span>Ch∆∞a c√≥ lyric</span>';
      if (s.avatar) {
        dAvatar.src = s.avatar;
        dAvatar.style.display = 'block'
      } else {
        dAvatar.style.display = 'none'
      }
      lyricDialog.showModal();
    }
    window.openEditDialog = id => {
      const pwd = prompt('Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ ch·ªânh s·ª≠a b√†i h√°t:');
      if (pwd === null) return;
      const bmcp = 'Dat!@#123';
      if (pwd !== bmcp) {
        alert('M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng. Hu·ª∑ thao t√°c ch·ªânh s·ª≠a.');
        return
      }
      const s = window._songs.find(x => x.Id === id);
      if (!s) return;
      currentEditId = id;
      document.getElementById('editSongName').value = s['T√™n'];
      document.getElementById('editArtist').value = s['Ca sƒ©'];
      document.getElementById('editComposer').value = s['S√°ng t√°c'] || '';
      document.getElementById('editReleaseDate').value = s['Ng√†y ph√°t h√†nh'] || '';
      document.getElementById('editAvatar').value = s.avatar || '';
      document.getElementById('editLyric').value = s['Lyric'] || '';
      clearEditErrors();
      editSongDialog.showModal()
    }
    // TH√äM FUNCTION N√ÄY
    addSongDialog.addEventListener('click', async (e) => {
      if (e.target !== addSongDialog) return;
      addSongDialog.close();
    });

    // Load t√™n user khi m·ªü dialog th√™m b√†i h√°t
    window.addEventListener('DOMContentLoaded', () => {
      const addBtn = document.getElementById('btn-add-sc');
      if (addBtn) {
        addBtn.addEventListener('click', async () => {
          if (currentUser) {
            const {
              data
            } = await supabase
              .from('profiles')
              .select('display_name')
              .eq('id', currentUser.id)
              .single();

            if (data) {
              document.getElementById('addedBy').value = data.display_name;
            }
          } else {
            document.getElementById('addedBy').value = 'Kh√°ch';
          }
        });
      }
    });
    window.deleteSong = async id => {
      const pwd = prompt('Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ xo√° b√†i h√°t:');
      if (pwd === null) return;
      const bmcp = 'Dat!@#123';
      if (pwd !== bmcp) {
        alert('M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng. Hu·ª∑ thao t√°c xo√°.');
        return
      }
      if (!confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën xo√° b√†i h√°t n√†y?')) return;
      const {
        error
      } = await supabase.from('songs').delete().eq('Id', id);
      if (error) {
        console.error(error);
        alert('L·ªói khi xo√° b√†i h√°t: ' + error.message);
        return
      }
      loadSongs()
    }
    lyricDialog.addEventListener('click', (e) => {
      if (e.target === lyricDialog) {
        lyricDialog.close()
      }
    });

    editSongDialog.addEventListener('click', (e) => {
      if (e.target === editSongDialog) {
        editSongDialog.close()
      }
    });

    songForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearErrors();
      const songName = document.getElementById('songName').value.trim();
      const artist = document.getElementById('artist').value.trim();
      const composer = document.getElementById('composer').value.trim();
      const releaseDate = document.getElementById('releaseDate').value;
      const avatar = document.getElementById('avatar').value.trim();
      const lyric = document.getElementById('lyric').value.trim();
      const adminCode = document.getElementById('adminCode').value.trim();
      const addedBy = document.getElementById('addedBy').value.trim();
      let isValid = true;
      if (!songName) {
        showError('songName', 'Vui l√≤ng nh·∫≠p t√™n b√†i h√°t');
        isValid = false
      }
      if (!artist) {
        showError('artist', 'Vui l√≤ng nh·∫≠p t√™n ca sƒ©');
        isValid = false
      }
      if (!composer) {
        showError('composer', 'Vui l√≤ng nh·∫≠p t√™n s√°ng t√°c');
        isValid = false
      }
      if (!releaseDate) {
        showError('releaseDate', 'Vui l√≤ng ch·ªçn ng√†y ph√°t h√†nh');
        isValid = false
      }
      if (!isValid) return;
      const correctAdminCode = 'xm1689';
      const isVerified = adminCode === correctAdminCode;
      const {
        error
      } = await supabase.from('songs').insert([{
        'T√™n': songName,
        'Ca sƒ©': artist,
        'S√°ng t√°c': composer,
        'Ng√†y ph√°t h√†nh': releaseDate,
        'avatar': avatar || null,
        'Lyric': lyric,
        'X√°c minh': isVerified,
        'add_by': addedBy
      }]);
      if (error) {
        console.error(error);
        alert('L·ªói khi th√™m b√†i h√°t: ' + error.message);
        return
      }
      songForm.reset();
      addSongDialog.close();
      if (isVerified) {
        alert('B√†i h√°t ƒë√£ ƒë∆∞·ª£c th√™m v√† x√°c minh th√†nh c√¥ng! ‚úÖ')
      } else {
        alert('B√†i h√°t ƒë√£ ƒë∆∞·ª£c th√™m!\nVui l√≤ng ƒë·ª£i duy·ªát trong gi√¢y l√°t!')
      }
      loadSongs()
    });

    editSongForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearEditErrors();
      const songName = document.getElementById('editSongName').value.trim();
      const artist = document.getElementById('editArtist').value.trim();
      const composer = document.getElementById('editComposer').value.trim();
      const releaseDate = document.getElementById('editReleaseDate').value;
      const avatar = document.getElementById('editAvatar').value.trim();
      const lyric = document.getElementById('editLyric').value.trim();
      let isValid = true;
      if (!songName) {
        showEditError('editSongName', 'Vui l√≤ng nh·∫≠p t√™n b√†i h√°t');
        isValid = false
      }
      if (!artist) {
        showEditError('editArtist', 'Vui l√≤ng nh·∫≠p t√™n ca sƒ©');
        isValid = false
      }
      if (!composer) {
        showEditError('editComposer', 'Vui l√≤ng nh·∫≠p t√™n s√°ng t√°c');
        isValid = false
      }
      if (!releaseDate) {
        showEditError('editReleaseDate', 'Vui l√≤ng ch·ªçn ng√†y ph√°t h√†nh');
        isValid = false
      }
      if (!isValid) return;
      const {
        error
      } = await supabase.from('songs').update({
        'T√™n': songName,
        'Ca sƒ©': artist,
        'S√°ng t√°c': composer,
        'Ng√†y ph√°t h√†nh': releaseDate,
        'avatar': avatar || null,
        'Lyric': lyric
      }).eq('Id', currentEditId);
      if (error) {
        console.error(error);
        alert('L·ªói khi c·∫≠p nh·∫≠t b√†i h√°t: ' + error.message);
        return
      }
      editSongDialog.close();
      loadSongs()
    });

    function showError(fieldId, message) {
      document.getElementById(`error-${fieldId}`).textContent = message
    }

    function showEditError(fieldId, message) {
      document.getElementById(`error-${fieldId}`).textContent = message
    }

    function clearErrors() {
      document.querySelectorAll('#songForm .error').forEach(el => el.textContent = '')
    }

    function clearEditErrors() {
      document.querySelectorAll('#editSongForm .error').forEach(el => el.textContent = '')
    }

    function removeDiacritics(str) {
      return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase()
    }
    loadSongs();

    const YOUTUBE_API_KEY = "AIzaSyAS6c7bto_vvZ60g_FsdA60od3Fgw0y67g";

    window.extractVideoId = function(url) {
      const match = url.match(/(?:v=|\/)([0-9A-Za-z_-]{11})/);
      return match ? match[1] : null;
    };


    window.fetchYoutubeDate = async function(type) {
      const linkInput =
        type === 'add' ?
        document.getElementById('youtubeLinkAdd') :
        document.getElementById('youtubeLinkEdit');

      const dateInput =
        type === 'add' ?
        document.getElementById('releaseDate') :
        document.getElementById('editReleaseDate');

      const videoId = extractVideoId(linkInput.value.trim());
      if (!videoId) return alert('Link YouTube kh√¥ng h·ª£p l·ªá');

      const res = await fetch(
        `https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${videoId}&key=${YOUTUBE_API_KEY}`
      );
      const data = await res.json();

      if (!data.items?.length) {
        alert('Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu video');
        return;
      }

      const publishedAt = data.items[0].snippet.publishedAt;
      dateInput.value = publishedAt.substring(0, 10);
    };

    window.autoFindReleaseDate = async function() {
      const title = document.getElementById('songName').value.trim();
      const artist = document.getElementById('artist').value.trim();
      const dateInput = document.getElementById('releaseDate');

      if (!title) {
        alert('Vui l√≤ng nh·∫≠p t√™n b√†i h√°t tr∆∞·ªõc');
        return;
      }

      const keyword = `${title} ${artist}`.trim();

      try {
        // 1Ô∏è‚É£ Search video gi·ªëng "I'm Feeling Lucky"
        const searchRes = await fetch(
          `https://www.googleapis.com/youtube/v3/search` +
          `?part=snippet&type=video&maxResults=1` +
          `&q=${encodeURIComponent(keyword)}` +
          `&key=${YOUTUBE_API_KEY}`
        );
        const searchData = await searchRes.json();

        if (!searchData.items?.length) {
          alert('Kh√¥ng t√¨m th·∫•y video ph√π h·ª£p');
          return;
        }

        const videoId = searchData.items[0].id.videoId;

        // 2Ô∏è‚É£ L·∫•y ng√†y xu·∫•t b·∫£n
        const videoRes = await fetch(
          `https://www.googleapis.com/youtube/v3/videos` +
          `?part=snippet&id=${videoId}` +
          `&key=${YOUTUBE_API_KEY}`
        );
        const videoData = await videoRes.json();

        if (!videoData.items?.length) {
          alert('Kh√¥ng l·∫•y ƒë∆∞·ª£c ng√†y ph√°t h√†nh');
          return;
        }

        // ‚≠ê FIX CHU·∫®N: KH√îNG L·ªÜCH NG√ÄY
        const publishedAt = videoData.items[0].snippet.publishedAt;
        dateInput.value = publishedAt.substring(0, 10);

      } catch (e) {
        console.error(e);
        alert('L·ªói khi t·ª± t√¨m ng√†y ph√°t h√†nh');
      }
    };

    // Authentication state
    let currentUser = null;

    // Check user session khi load
    async function checkAuth() {
      const {
        data: {
          session
        }
      } = await supabase.auth.getSession();
      if (session) {
        currentUser = session.user;
        await loadUserProfile();
        updateAuthUI(true);
      } else {
        updateAuthUI(false);
      }
    }

    // Load th√¥ng tin profile
    async function loadUserProfile() {
      if (!currentUser) return;

      const {
        data,
        error
      } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', currentUser.id)
        .single();

      if (data) {
        // Hi·ªÉn th·ªã t√™n + role v·ªõi style ƒë·∫πp
        const roleColors = {
          'Admin': '#ef4444',
          'Moderator': '#f59e0b',
          'Member': '#3b82f6',
          '·ª¶a': 'purple',
          'Jack': 'purple',
          'B·ªè con': 'purple',
          'Skibidi': 'purple',
          'B·ªìn c·∫ßu': 'purple',
          'WTF': 'purple',
          'Admin fake': 'purple',
          'Ph√©p thu·∫≠t winx enchantix bi·∫øn h√¨nh': 'purple',
        };

        const roleColor = roleColors[data.role] || '#6b7280';

        document.getElementById('userDisplayName').innerHTML = `
            ${data.display_name} 
            <span style="
                background: ${roleColor}; 
                padding: 4px 10px; 
                border-radius: 6px; 
                font-size: 18px; 
                font-weight: 600;
                margin-left: 8px;
            " id="role" onclick="roleCheck()">${data.role}</span>
        `;

        // L∆∞u role ƒë·ªÉ d√πng sau n√†y
        window.currentUserRole = data.role;
      }
    }

    // Update UI d·ª±a tr√™n tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
    function updateAuthUI(isLoggedIn) {
      const authButtons = document.getElementById('authButtons');
      const userInfo = document.getElementById('userInfo');

      if (authButtons && userInfo) {
        authButtons.style.display = isLoggedIn ? 'none' : 'flex';
        userInfo.style.display = isLoggedIn ? 'flex' : 'none';
      }
    }

    // X·ª≠ l√Ω ƒëƒÉng k√Ω
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      // Clear errors
      document.querySelectorAll('#registerForm .error').forEach(el => el.textContent = '');

      const displayName = document.getElementById('regDisplayName').value.trim();
      const email = document.getElementById('regEmail').value.trim();
      const phone = document.getElementById('regPhone').value.trim();
      const password = document.getElementById('regPassword').value;
      const confirmPassword = document.getElementById('regConfirmPassword').value;

      // Validation
      let isValid = true;

      if (displayName.length < 2) {
        document.getElementById('error-regDisplayName').textContent = 'T√™n hi·ªÉn th·ªã qu√° ng·∫Øn';
        isValid = false;
      }

      // Validate s·ªë ƒëi·ªán tho·∫°i (10 s·ªë, b·∫Øt ƒë·∫ßu b·∫±ng 0)
      const phoneRegex = /^0\d{9}$/;
      if (!phoneRegex.test(phone)) {
        document.getElementById('error-regPhone').textContent = 'S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá (VD: 0912345678)';
        isValid = false;
      }

      if (password.length < 6) {
        document.getElementById('error-regPassword').textContent = 'M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±';
        isValid = false;
      }

      if (password !== confirmPassword) {
        document.getElementById('error-regConfirmPassword').textContent = 'M·∫≠t kh·∫©u kh√¥ng kh·ªõp';
        isValid = false;
      }

      if (!isValid) return;

      // ƒêƒÉng k√Ω v·ªõi Supabase (emailRedirectTo ƒë·ªÉ t·∫Øt verify)
      const {
        data,
        error
      } = await supabase.auth.signUp({
        email: email,
        password: password,
        options: {
          data: {
            display_name: displayName,
            phone: phone
          },
          emailRedirectTo: window.location.origin
        }
      });

      if (error) {
        if (error.message.includes('already registered')) {
          alert('Email n√†y ƒë√£ ƒë∆∞·ª£c ƒëƒÉng k√Ω!');
        } else {
          alert('L·ªói ƒëƒÉng k√Ω: ' + error.message);
        }
        return;
      }

      // ƒêƒÉng nh·∫≠p lu√¥n sau khi ƒëƒÉng k√Ω (v√¨ ƒë√£ t·∫Øt verify email)
      currentUser = data.user;
      await loadUserProfile();
      updateAuthUI(true);

      alert('ƒêƒÉng k√Ω th√†nh c√¥ng! Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi ntdMUSIC! üéµ');
      document.getElementById('registerForm').reset();
      registerDialog.close();
    });

    // X·ª≠ l√Ω ƒëƒÉng nh·∫≠p
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;

      const {
        data,
        error
      } = await supabase.auth.signInWithPassword({
        email: email,
        password: password
      });

      if (error) {
        alert('L·ªói ƒëƒÉng nh·∫≠p: ' + error.message);
        return;
      }

      currentUser = data.user;
      await loadUserProfile();
      updateAuthUI(true);

      document.getElementById('loginForm').reset();
      loginDialog.close();

      alert('ƒêƒÉng nh·∫≠p th√†nh c√¥ng!');
    });

    // X·ª≠ l√Ω ƒëƒÉng xu·∫•t
    window.handleLogout = async function() {
      if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) return;

      await supabase.auth.signOut();
      currentUser = null;
      updateAuthUI(false);
      alert('ƒê√£ ƒëƒÉng xu·∫•t!');
    };

    // Listen auth state changes
    supabase.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_IN') {
        currentUser = session.user;
        loadUserProfile();
        updateAuthUI(true);
      } else if (event === 'SIGNED_OUT') {
        currentUser = null;
        updateAuthUI(false);
      }
    });

    // G·ªçi checkAuth khi load trang
    checkAuth();

    // TH√äM C√ÅC FUNCTION N√ÄY V√ÄO ƒê√ÇY

    // M·ªü dialog xem th√¥ng tin
    window.viewProfileDialog.addEventListener('click', async (e) => {
      if (e.target !== viewProfileDialog) return; // Ch·ªâ load khi click backdrop
      viewProfileDialog.close();
    });

    // T·∫°o function ri√™ng ƒë·ªÉ load v√† show
    window.showViewProfile = async function() {
      if (!currentUser) return;

      const {
        data
      } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', currentUser.id)
        .single();

      if (data) {
        document.getElementById('viewDisplayName').textContent = data.display_name;
        document.getElementById('viewEmail').textContent = currentUser.email;
        document.getElementById('viewPhone').textContent = data.phone || 'Ch∆∞a c·∫≠p nh·∫≠t';
        document.getElementById('viewRole').textContent = data.role;
      }

      viewProfileDialog.showModal();
    }

    // M·ªü dialog ch·ªânh s·ª≠a
    window.openEditProfileDialog = async function() {
      viewProfileDialog.close();

      const {
        data
      } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', currentUser.id)
        .single();

      if (data) {
        document.getElementById('editDisplayName').value = data.display_name;
        document.getElementById('editPhone').value = data.phone || '';
      }

      // Clear password fields
      document.getElementById('oldPassword').value = '';
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmNewPassword').value = '';

      // Clear errors
      document.querySelectorAll('#editProfileForm .error').forEach(el => el.textContent = '');

      editProfileDialog.showModal();
    }

    // X·ª≠ l√Ω submit form ch·ªânh s·ª≠a
    document.getElementById('editProfileForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      // Clear errors
      document.querySelectorAll('#editProfileForm .error').forEach(el => el.textContent = '');

      const displayName = document.getElementById('editDisplayName').value.trim();
      const phone = document.getElementById('editPhone').value.trim();
      const oldPassword = document.getElementById('oldPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmNewPassword = document.getElementById('confirmNewPassword').value;

      let isValid = true;

      // Validate t√™n hi·ªÉn th·ªã
      if (displayName.length < 2) {
        document.getElementById('error-editDisplayName').textContent = 'T√™n hi·ªÉn th·ªã qu√° ng·∫Øn';
        isValid = false;
      }

      // Validate s·ªë ƒëi·ªán tho·∫°i
      const phoneRegex = /^0\d{9}$/;
      if (!phoneRegex.test(phone)) {
        document.getElementById('error-editPhone').textContent = 'S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá (VD: 0912345678)';
        isValid = false;
      }

      // Validate ƒë·ªïi m·∫≠t kh·∫©u (n·∫øu c√≥ nh·∫≠p)
      if (oldPassword || newPassword || confirmNewPassword) {
        if (!oldPassword) {
          document.getElementById('error-oldPassword').textContent = 'Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u c≈©';
          isValid = false;
        }
        if (!newPassword) {
          document.getElementById('error-newPassword').textContent = 'Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u m·ªõi';
          isValid = false;
        } else if (newPassword.length < 6) {
          document.getElementById('error-newPassword').textContent = 'M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±';
          isValid = false;
        }
        if (newPassword !== confirmNewPassword) {
          document.getElementById('error-confirmNewPassword').textContent = 'M·∫≠t kh·∫©u kh√¥ng kh·ªõp';
          isValid = false;
        }
      }

      if (!isValid) return;

      try {
        // 1. C·∫≠p nh·∫≠t th√¥ng tin c∆° b·∫£n
        const {
          error: updateError
        } = await supabase
          .from('profiles')
          .update({
            display_name: displayName,
            phone: phone
          })
          .eq('id', currentUser.id);

        if (updateError) throw updateError;

        // 2. ƒê·ªïi m·∫≠t kh·∫©u (n·∫øu c√≥)
        if (oldPassword && newPassword) {
          // Verify m·∫≠t kh·∫©u c≈©
          const {
            error: signInError
          } = await supabase.auth.signInWithPassword({
            email: currentUser.email,
            password: oldPassword
          });

          if (signInError) {
            document.getElementById('error-oldPassword').textContent = 'M·∫≠t kh·∫©u c≈© kh√¥ng ƒë√∫ng';
            return;
          }

          // C·∫≠p nh·∫≠t m·∫≠t kh·∫©u m·ªõi
          const {
            error: passwordError
          } = await supabase.auth.updateUser({
            password: newPassword
          });

          if (passwordError) throw passwordError;

          alert('C·∫≠p nh·∫≠t th√¥ng tin v√† m·∫≠t kh·∫©u th√†nh c√¥ng! üéâ');
        } else {
          alert('C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng! ‚úÖ');
        }

        // Reload profile v√† ƒë√≥ng dialog
        await loadUserProfile();
        editProfileDialog.close();

      } catch (error) {
        console.error(error);
        alert('L·ªói khi c·∫≠p nh·∫≠t: ' + error.message);
      }
    });

    // K·∫æT TH√öC PH·∫¶N TH√äM
  </script>
</body>

</html>